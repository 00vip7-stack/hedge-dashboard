<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HedgeFreedom - ë¡œê·¸ì¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('user_logged_in') === 'true';
            const onboardingCompleted = localStorage.getItem('hedge_onboarding_completed') === 'true';
            
            if (isLoggedIn) {
                if (onboardingCompleted) {
                    // ë¡œê·¸ì¸ + ì˜¨ë³´ë”© ì™„ë£Œ â†’ ëŒ€ì‹œë³´ë“œ
                    console.log('âœ… ì´ë¯¸ ë¡œê·¸ì¸ë¨ - ëŒ€ì‹œë³´ë“œë¡œ ì´ë™');
                    window.location.href = './hedge-manager.html';
                } else {
                    // ë¡œê·¸ì¸í–ˆì§€ë§Œ ì˜¨ë³´ë”© ë¯¸ì™„ë£Œ â†’ ì˜¨ë³´ë”©
                    console.log('ğŸ“„ ë¡œê·¸ì¸ë¨ í•˜ì§€ë§Œ ì˜¨ë³´ë”© ë¯¸ì™„ë£Œ - ì˜¨ë³´ë”©ìœ¼ë¡œ ì´ë™');
                    window.location.href = './onboarding.html';
                }
            }
        });
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="login-card rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <!-- ë¡œê³  -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">HedgeFreedom</h1>
            <p class="text-gray-500 text-sm">ì™¸í™˜ í—¤ì§€ ê´€ë¦¬ í”Œë«í¼</p>
        </div>

        <!-- ë¡œê·¸ì¸ í¼ -->
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                    ì´ë©”ì¼
                </label>
                <input 
                    type="email" 
                    id="email" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                    placeholder="your@company.com"
                >
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                    ë¹„ë°€ë²ˆí˜¸
                </label>
                <input 
                    type="password" 
                    id="password" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                >
            </div>

            <div class="flex items-center justify-between mb-6">
                <label class="flex items-center">
                    <input type="checkbox" id="rememberMe" class="mr-2">
                    <span class="text-sm text-gray-600">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</span>
                </label>
                <a href="#" class="text-sm text-purple-600 hover:text-purple-800">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition duration-300"
            >
                ë¡œê·¸ì¸
            </button>
        </form>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingState" class="hidden mt-6 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
            <p class="text-gray-600 mt-2">ì¸ì¦ ì¤‘...</p>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-600 text-sm"></p>
        </div>

        <!-- êµ¬ë¶„ì„  -->
        <div class="mt-8 mb-6 border-t border-gray-200"></div>

        <!-- ë°ëª¨ ê³„ì • ì•ˆë‚´ -->
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm font-bold text-blue-800 mb-2">ğŸ¯ ë°ëª¨ ê³„ì • (í…ŒìŠ¤íŠ¸ìš©)</p>
            <div class="text-xs text-blue-700 space-y-1 font-mono">
                <div>ì´ë©”ì¼: <span class="font-bold">demo@hedgefreedom.com</span></div>
                <div>ë¹„ë°€ë²ˆí˜¸: <span class="font-bold">demo1234</span></div>
            </div>
            <button 
                onclick="quickDemoLogin()" 
                class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-2 px-4 rounded transition"
            >
                âš¡ ë°ëª¨ ê³„ì •ìœ¼ë¡œ ë¹ ë¥¸ ë¡œê·¸ì¸
            </button>
        </div>

        <!-- ì¶”ê°€ ì •ë³´ -->
        <div class="text-center mt-6">
            <p class="text-gray-600 text-sm mb-4">ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</p>
            <a href="#" class="text-purple-600 hover:text-purple-800 font-semibold text-sm">
                ë¬´ë£Œ ì²´í—˜ ì‹ ì²­í•˜ê¸° â†’
            </a>
        </div>

        <!-- ì‹œìŠ¤í…œ ì •ë³´ -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <div class="text-xs text-gray-500 space-y-1">
                <div class="flex justify-between">
                    <span>ë¡œì»¬ ë²„ì „:</span>
                    <span id="localVersion" class="font-mono">v1.0.0</span>
                </div>
                <div class="flex justify-between">
                    <span>ì„œë²„ ìƒíƒœ:</span>
                    <span id="serverStatus" class="text-green-600">â— ì •ìƒ</span>
                </div>
                <div class="flex justify-between">
                    <span>ë°ì´í„° ì €ì¥:</span>
                    <span class="font-mono">ë¡œì»¬ í´ë”</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì„¤ì •
        const API_SERVER = 'https://api.hedgefreedom.com'; // ì‹¤ì œ ì„œë²„ ì£¼ì†Œë¡œ ë³€ê²½
        const LOCAL_STORAGE_KEY = 'hedgefreedom_auth';
        const LOCAL_VERSION = 'v1.0.0';

        // ë°ëª¨ ê³„ì • ì •ë³´
        const DEMO_ACCOUNT = {
            email: 'demo@hedgefreedom.com',
            password: 'demo1234'
        };

        // ë°ëª¨ ê³„ì • ë¹ ë¥¸ ë¡œê·¸ì¸
        function quickDemoLogin() {
            document.getElementById('email').value = DEMO_ACCOUNT.email;
            document.getElementById('password').value = DEMO_ACCOUNT.password;
            document.getElementById('rememberMe').checked = true;
            
            // í¼ ìë™ ì œì¶œ
            setTimeout(() => {
                document.getElementById('loginForm').dispatchEvent(new Event('submit', { cancelable: true }));
            }, 300);
        }

        // ì„œë²„ ìƒíƒœ ì²´í¬
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_SERVER}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    document.getElementById('serverStatus').innerHTML = 'â— ì •ìƒ';
                    document.getElementById('serverStatus').className = 'text-green-600';
                } else {
                    throw new Error('Server unavailable');
                }
            } catch (error) {
                console.warn('ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ì˜¤í”„ë¼ì¸ ëª¨ë“œ:', error);
                document.getElementById('serverStatus').innerHTML = 'â— ì˜¤í”„ë¼ì¸';
                document.getElementById('serverStatus').className = 'text-yellow-600';
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                let authData;
                
                // ë¨¼ì € ë¡œì»¬ ì¸ì¦ ì‹œë„ (ë°ëª¨/ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
                if (email === DEMO_ACCOUNT.email && password === DEMO_ACCOUNT.password) {
                    // ë¡œì»¬ ë°ëª¨ ê³„ì • ì¸ì¦ ì„±ê³µ
                    console.log('ë¡œì»¬ ë°ëª¨ ê³„ì • ì¸ì¦ ì„±ê³µ');
                    authData = {
                        token: 'demo_token_' + Date.now(),
                        userId: 'demo_user',
                        email: email,
                        companyName: 'ë°ëª¨ íšŒì‚¬',
                        userName: 'ë°ëª¨ ì‚¬ìš©ì',
                        permissions: ['read', 'write', 'execute']
                    };
                } else {
                    // ì„œë²„ ì¸ì¦ ì‹œë„
                    try {
                        const response = await fetch(`${API_SERVER}/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                        }

                        authData = await response.json();
                    } catch (serverError) {
                        // ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì¸ì¦ ì‹œë„
                        console.warn('ì„œë²„ ì¸ì¦ ì‹¤íŒ¨, ë¡œì»¬ ëª¨ë“œë¡œ ì „í™˜:', serverError);
                        
                        // ì„ì‹œ ë¡œì»¬ ì¸ì¦ (ê°œë°œìš©)
                        if (email && password) {
                            authData = {
                                token: 'local_token_' + Date.now(),
                                userId: email.split('@')[0],
                                email: email,
                                companyName: 'ë¡œì»¬ íšŒì‚¬',
                                userName: email.split('@')[0],
                                permissions: ['read', 'write', 'execute']
                            };
                        } else {
                            throw new Error('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        }
                    }
                }
                
                // ì¸ì¦ ì •ë³´ ì €ì¥
                const authInfo = {
                    token: authData.token,
                    userId: authData.userId,
                    email: email,
                    companyName: authData.companyName,
                    userName: authData.userName,
                    permissions: authData.permissions,
                    loginTime: new Date().toISOString(),
                    rememberMe: rememberMe
                };

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                if (rememberMe) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(authInfo));
                } else {
                    sessionStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(authInfo));
                }
                
                // ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
                localStorage.setItem('user_logged_in', 'true');

                // ë©”ì¸ ëŒ€ì‹œë³´ë“œ ë˜ëŠ” ì˜¨ë³´ë”©ìœ¼ë¡œ ì´ë™
                const onboardingCompleted = localStorage.getItem('hedge_onboarding_completed') === 'true';
                
                console.log('ë¡œê·¸ì¸ ì„±ê³µ! ', onboardingCompleted ? 'ëŒ€ì‹œë³´ë“œë¡œ' : 'ì˜¨ë³´ë”©ìœ¼ë¡œ', ' ì´ë™...');
                
                if (onboardingCompleted) {
                    // ì˜¨ë³´ë”© ì™„ë£Œ â†’ ëŒ€ì‹œë³´ë“œ
                    window.location.href = 'hedge-manager.html';
                } else {
                    // ì˜¨ë³´ë”© ë¯¸ì™„ë£Œ â†’ ì˜¨ë³´ë”© í˜ì´ì§€
                    window.location.href = 'onboarding.html';
                }

            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showError(error.message);
                
                // UI ë³µì›
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        // ë¡œì»¬ í´ë” ì„¤ì •
        async function setupLocalFolder(userId) {
            try {
                // File System Access API ì§€ì› í™•ì¸
                if ('showDirectoryPicker' in window) {
                    // ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸° (ì„ íƒ ì‚¬í•­)
                    const setupFolder = confirm('ë°ì´í„°ë¥¼ ì €ì¥í•  ë¡œì»¬ í´ë”ë¥¼ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë‚˜ì¤‘ì—ë„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                    
                    if (setupFolder) {
                        // ì‚¬ìš©ìì—ê²Œ í´ë” ì„ íƒ ìš”ì²­
                        const dirHandle = await window.showDirectoryPicker({
                            mode: 'readwrite',
                            startIn: 'documents'
                        });
                        
                        // í´ë” í•¸ë“¤ ì €ì¥ (ì‹¤ì œë¡œëŠ” IndexedDB ì‚¬ìš© ê¶Œì¥)
                        console.log('ë¡œì»¬ í´ë” ì„¤ì • ì™„ë£Œ:', dirHandle.name);
                        
                        // ì„¤ì • íŒŒì¼ ìƒì„±
                        await createConfigFile(dirHandle, userId);
                    } else {
                        console.log('í´ë” ì„¤ì •ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤. localStorage ì‚¬ìš©.');
                    }
                } else {
                    console.warn('File System Access API ë¯¸ì§€ì›. localStorage ì‚¬ìš©');
                }
            } catch (error) {
                console.error('í´ë” ì„¤ì • ì˜¤ë¥˜:', error);
                // í´ë” ì„¤ì • ì‹¤íŒ¨í•´ë„ ì§„í–‰ (localStorage ì‚¬ìš©)
            }
        }

        // ì„¤ì • íŒŒì¼ ìƒì„±
        async function createConfigFile(dirHandle, userId) {
            const config = {
                userId: userId,
                createdAt: new Date().toISOString(),
                version: LOCAL_VERSION,
                dataFolder: dirHandle.name
            };

            const configFile = await dirHandle.getFileHandle('hedgefreedom.config.json', { create: true });
            const writable = await configFile.createWritable();
            await writable.write(JSON.stringify(config, null, 2));
            await writable.close();
            
            console.log('ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ');
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // ìë™ ë¡œê·¸ì¸ ì²´í¬
        function checkAutoLogin() {
            const savedAuth = localStorage.getItem(LOCAL_STORAGE_KEY) || 
                            sessionStorage.getItem(LOCAL_STORAGE_KEY);
            
            if (savedAuth) {
                try {
                    const authInfo = JSON.parse(savedAuth);
                    
                    // í† í° ìœ íš¨ì„± ê²€ì¦ (ê°„ë‹¨í•œ ì‹œê°„ ì²´í¬)
                    const loginTime = new Date(authInfo.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        // 24ì‹œê°„ ì´ë‚´ë©´ ìë™ ë¡œê·¸ì¸
                        console.log('ìë™ ë¡œê·¸ì¸ ì¤‘...');
                        window.location.href = 'hedge-manager.html';
                    } else {
                        // ë§Œë£Œëœ í† í° ì œê±°
                        localStorage.removeItem(LOCAL_STORAGE_KEY);
                        sessionStorage.removeItem(LOCAL_STORAGE_KEY);
                    }
                } catch (error) {
                    console.error('ìë™ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                }
            }
        }

        // ë°ëª¨/í…ŒìŠ¤íŠ¸ ë¡œê·¸ì¸
        function quickLogin() {
            document.getElementById('email').value = 'demo@hedgefreedom.com';
            document.getElementById('password').value = 'demo1234';
            document.getElementById('rememberMe').checked = true;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('load', () => {
            document.getElementById('localVersion').textContent = LOCAL_VERSION;
            checkServerStatus();
            checkAutoLogin();
            
            // ê°œë°œ ëª¨ë“œ: Shift+Dë¡œ ë¹ ë¥¸ ë¡œê·¸ì¸
            document.addEventListener('keydown', (e) => {
                if (e.shiftKey && e.key === 'D') {
                    quickLogin();
                }
            });
        });
    </script>

</body>
</html>
