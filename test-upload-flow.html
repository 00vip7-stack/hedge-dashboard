<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—…ë¡œë“œ íë¦„ ì¶”ì  ë””ë²„ê±°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 p-8">
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“Š ì—…ë¡œë“œ â†’ ê³„ì‚° â†’ ê²°ê³¼ íë¦„ ì¶”ì </h1>
        
        <!-- ë¡œê·¸ ë·°ì–´ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- ì™¼ìª½: ì œì–´íŒ -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ® ì œì–´ íŒ¨ë„</h2>
                
                <!-- 1. ìƒ˜í”Œ ë°ì´í„° ìƒì„± -->
                <div class="border border-blue-300 rounded-lg p-4 bg-blue-50">
                    <h3 class="font-bold text-blue-800 mb-2">1ï¸âƒ£ ìƒ˜í”Œ ë°ì´í„° ìƒì„±</h3>
                    <button onclick="createSampleData()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        ìƒ˜í”Œ ë°ì´í„° ìƒì„± (localStorage)
                    </button>
                </div>
                
                <!-- 2. íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
                <div class="border border-green-300 rounded-lg p-4 bg-green-50">
                    <h3 class="font-bold text-green-800 mb-2">2ï¸âƒ£ ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ</h3>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="block w-full mb-2">
                    <button onclick="uploadRealFile()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                        íŒŒì¼ ì—…ë¡œë“œ & íŒŒì‹±
                    </button>
                </div>
                
                <!-- 3. ê³„ì‚° ìš”ì²­ -->
                <div class="border border-purple-300 rounded-lg p-4 bg-purple-50">
                    <h3 class="font-bold text-purple-800 mb-2">3ï¸âƒ£ ê³„ì‚° ìš”ì²­</h3>
                    <input type="number" id="targetRatio" placeholder="ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ (%)" value="70" class="w-full border border-purple-300 rounded px-2 py-1 mb-2">
                    <button onclick="requestCalculation()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                        ì„œë²„ë¡œ ê³„ì‚° ìš”ì²­
                    </button>
                </div>
                
                <!-- 4. ìƒíƒœ í™•ì¸ -->
                <div class="border border-orange-300 rounded-lg p-4 bg-orange-50">
                    <h3 class="font-bold text-orange-800 mb-2">4ï¸âƒ£ ìƒíƒœ í™•ì¸</h3>
                    <button onclick="checkFlowStatus()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded mb-2">
                        í˜„ì¬ ìƒíƒœ í™•ì¸
                    </button>
                    <button onclick="clearLogs()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                        ë¡œê·¸ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ ì¶œë ¥ -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
                <div id="logContainer" class="border border-gray-300 rounded-lg bg-gray-900 text-green-400 p-4 font-mono text-xs h-96 overflow-y-auto">
                    <div class="text-yellow-300">[ì‹œìŠ¤í…œ] ë¡œê·¸ ë¹„ì›Œì§. ìœ„ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
                </div>
            </div>
        </div>
        
        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-700 mb-4">ğŸ“Š ë°ì´í„° í˜„í™©</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 border border-blue-300 rounded-lg p-4">
                    <div class="text-sm text-blue-600 font-bold">íŒŒì¼ì—ì„œ ì½ì€ ê±´ìˆ˜</div>
                    <div id="uploadedCount" class="text-3xl font-bold text-blue-800">0</div>
                </div>
                <div class="bg-green-50 border border-green-300 rounded-lg p-4">
                    <div class="text-sm text-green-600 font-bold">ì„œë²„ë¡œ ì „ì†¡í•  ìµëª…í™” ë°ì´í„°</div>
                    <div id="anonymizedCount" class="text-3xl font-bold text-green-800">0</div>
                </div>
                <div class="bg-purple-50 border border-purple-300 rounded-lg p-4">
                    <div class="text-sm text-purple-600 font-bold">ê³„ì‚° ê²°ê³¼ ìˆ˜ì‹  ì—¬ë¶€</div>
                    <div id="calculationStatus" class="text-2xl font-bold text-purple-800">âŒ ë¯¸ìˆ˜ì‹ </div>
                </div>
            </div>
            
            <!-- ë°ì´í„° ìƒ˜í”Œ -->
            <div class="bg-white border border-gray-300 rounded-lg p-4">
                <h3 class="font-bold text-gray-700 mb-2">ì›ë³¸ ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 3ê±´)</h3>
                <div id="originalDataTable" class="overflow-x-auto">
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border border-gray-300 px-2 py-1">ê±°ë˜ì²˜</th>
                                <th class="border border-gray-300 px-2 py-1">í†µí™”</th>
                                <th class="border border-gray-300 px-2 py-1">ê¸ˆì•¡</th>
                                <th class="border border-gray-300 px-2 py-1">ìœ í˜•</th>
                                <th class="border border-gray-300 px-2 py-1">ë‚ ì§œ</th>
                            </tr>
                        </thead>
                        <tbody id="originalDataBody" class="bg-blue-50">
                            <tr><td colspan="5" class="text-center p-2 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white border border-gray-300 rounded-lg p-4 mt-4">
                <h3 class="font-bold text-gray-700 mb-2">ìµëª…í™” ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 3ê±´)</h3>
                <div id="anonymizedDataTable" class="overflow-x-auto">
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border border-gray-300 px-2 py-1">í†µí™”</th>
                                <th class="border border-gray-300 px-2 py-1">ê¸ˆì•¡</th>
                                <th class="border border-gray-300 px-2 py-1">ìœ í˜•</th>
                                <th class="border border-gray-300 px-2 py-1">ë‚ ì§œ</th>
                                <th class="border border-gray-300 px-2 py-1">ìµëª…ID</th>
                            </tr>
                        </thead>
                        <tbody id="anonymizedDataBody" class="bg-green-50">
                            <tr><td colspan="5" class="text-center p-2 text-gray-500">ë°ì´í„° ì—†ìŒ</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ê³„ì‚° ê²°ê³¼ -->
            <div class="bg-white border border-gray-300 rounded-lg p-4 mt-4">
                <h3 class="font-bold text-gray-700 mb-2">ê³„ì‚° ê²°ê³¼</h3>
                <div id="calculationResultContainer" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3">
                        <div class="text-xs text-blue-600 font-bold">ì´ ë…¸ì¶œì•¡</div>
                        <div id="resultExposure" class="text-lg font-bold text-blue-800">-</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded p-3">
                        <div class="text-xs text-green-600 font-bold">ëª©í‘œ í—¤ì§€ì•¡</div>
                        <div id="resultTargetHedge" class="text-lg font-bold text-green-800">-</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded p-3">
                        <div class="text-xs text-purple-600 font-bold">í˜„ì¬ í—¤ì§€ ë¹„ìœ¨</div>
                        <div id="resultCurrentRatio" class="text-lg font-bold text-purple-800">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ë¡œê¹… í•¨ìˆ˜
const logs = [];
function addLog(message, type = 'info', data = null) {
    const timestamp = new Date().toLocaleTimeString('ko-KR');
    const logEntry = {timestamp, message, type, data};
    logs.push(logEntry);
    
    const logContainer = document.getElementById('logContainer');
    const logDiv = document.createElement('div');
    
    let color = 'text-green-400';
    let prefix = 'âœ“';
    
    if (type === 'error') { color = 'text-red-400'; prefix = 'âœ—'; }
    else if (type === 'warning') { color = 'text-yellow-400'; prefix = 'âš '; }
    else if (type === 'request') { color = 'text-blue-400'; prefix = 'â†’'; }
    else if (type === 'response') { color = 'text-cyan-400'; prefix = 'â†'; }
    
    logDiv.innerHTML = `<div class="${color}">[${timestamp}] ${prefix} ${message}</div>`;
    logContainer.appendChild(logDiv);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// 1. ìƒ˜í”Œ ë°ì´í„° ìƒì„±
function createSampleData() {
    addLog('ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì¤‘...', 'info');
    
    const sampleData = [
        {counterparty: 'ì‚¼ì„±ì „ì', currency: 'USD', amount: 1000000, type: 'receivable', date: '2024-01-15', bank: 'KBêµ­ë¯¼'},
        {counterparty: 'ì• í”Œ', currency: 'USD', amount: 500000, type: 'payable', date: '2024-01-14', bank: 'NHë†í˜‘'},
        {counterparty: 'BMW', currency: 'EUR', amount: 200000, type: 'receivable', date: '2024-01-13', bank: 'SCì œì¼'},
        {counterparty: 'ì†Œë‹ˆ', currency: 'JPY', amount: 10000000, type: 'payable', date: '2024-01-12', bank: 'KBêµ­ë¯¼'},
        {counterparty: 'ì¸í…”', currency: 'USD', amount: 800000, type: 'receivable', date: '2024-01-11', bank: 'HSBC'},
        {counterparty: 'í† ìš”íƒ€', currency: 'JPY', amount: 5000000, type: 'receivable', date: '2024-01-10', bank: 'DBS'},
    ];
    
    // localStorageì— ì €ì¥
    localStorage.setItem('uploadedData', JSON.stringify(sampleData));
    addLog(`âœ… ìƒ˜í”Œ ë°ì´í„° ì €ì¥: ${sampleData.length}ê±´`, 'response', sampleData);
    
    // UI ì—…ë°ì´íŠ¸
    document.getElementById('uploadedCount').textContent = sampleData.length;
    renderOriginalData(sampleData.slice(0, 3));
}

// 2. ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ
function uploadRealFile() {
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) {
        addLog('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    const file = fileInput.files[0];
    addLog(`íŒŒì¼ ì„ íƒ: ${file.name} (${(file.size / 1024).toFixed(2)}KB)`, 'info');
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            addLog('XLSX íŒŒì‹± ì¤‘...', 'info');
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            addLog(`âœ… íŒŒì¼ íŒŒì‹± ì™„ë£Œ: ${jsonData.length}ê±´`, 'response', jsonData);
            
            // ë°ì´í„° ì •ê·œí™” (ì»¬ëŸ¼ëª… ë§µí•‘)
            const normalized = jsonData.map(row => ({
                counterparty: row['ê±°ë˜ì²˜'] || row['counterparty'] || row['Counterparty'] || 'Unknown',
                currency: row['í†µí™”'] || row['currency'] || row['Currency'] || 'USD',
                amount: parseFloat(row['ê¸ˆì•¡'] || row['amount'] || row['Amount'] || 0),
                type: row['ìœ í˜•'] || row['type'] || row['Type'] || 'receivable',
                date: row['ë‚ ì§œ'] || row['date'] || row['Date'] || new Date().toISOString().split('T')[0],
                bank: row['ì€í–‰'] || row['bank'] || row['Bank'] || 'Unknown'
            }));
            
            // localStorageì— ì €ì¥
            localStorage.setItem('uploadedData', JSON.stringify(normalized));
            addLog(`âœ… ì •ê·œí™”ëœ ë°ì´í„° ì €ì¥: ${normalized.length}ê±´`, 'response');
            
            document.getElementById('uploadedCount').textContent = normalized.length;
            renderOriginalData(normalized.slice(0, 3));
            
        } catch (err) {
            addLog(`âŒ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${err.message}`, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// 3. ê³„ì‚° ìš”ì²­
async function requestCalculation() {
    const uploadedData = localStorage.getItem('uploadedData');
    if (!uploadedData) {
        addLog('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    const targetRatio = parseInt(document.getElementById('targetRatio').value) || 70;
    const originalData = JSON.parse(uploadedData);
    
    // ìµëª…í™” ì²˜ë¦¬
    addLog('ë°ì´í„° ìµëª…í™” ì¤‘...', 'info');
    const anonymizedData = originalData.map(row => ({
        currency: row.currency,
        amount: row.amount,
        type: row.type,
        date: row.date,
        anonymousId: 'anon_' + Math.random().toString(36).substr(2, 9)
        // counterparty, bank ì œê±°ë¨
    }));
    
    localStorage.setItem('anonymizedData', JSON.stringify(anonymizedData));
    addLog(`âœ… ìµëª…í™” ì™„ë£Œ: ${anonymizedData.length}ê±´`, 'response', anonymizedData);
    document.getElementById('anonymizedCount').textContent = anonymizedData.length;
    renderAnonymizedData(anonymizedData.slice(0, 3));
    
    // ì„œë²„ë¡œ ì „ì†¡
    addLog(`ğŸ“¤ ì„œë²„ ìš”ì²­: POST /api/calculate (ëª©í‘œë¹„ìœ¨: ${targetRatio}%)`, 'request');
    
    try {
        const response = await fetch('/api/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                positions: anonymizedData,
                targetRatio: targetRatio,
                _anonymized: true
            })
        });
        
        if (!response.ok) {
            addLog(`âš ï¸ ì„œë²„ ì‘ë‹µ ì—†ìŒ (${response.status}), Mock ë°ì´í„°ë¡œ ì²˜ë¦¬`, 'warning');
        }
        
        const result = await response.json();
        addLog(`âœ… ê³„ì‚° ê²°ê³¼ ìˆ˜ì‹ `, 'response', result);
        
        document.getElementById('calculationStatus').innerHTML = 'âœ… ìˆ˜ì‹  ì™„ë£Œ';
        renderCalculationResult(result.kpi);
        
    } catch (err) {
        addLog(`âš ï¸ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${err.message}, Mock ë°ì´í„° ì‚¬ìš©`, 'warning');
        
        // Mock ê²°ê³¼
        const mockResult = generateMockResult(anonymizedData, targetRatio);
        addLog(`âœ… Mock ê³„ì‚° ê²°ê³¼ ìƒì„±`, 'response', mockResult);
        
        document.getElementById('calculationStatus').innerHTML = 'âœ… Mock ì™„ë£Œ';
        renderCalculationResult(mockResult);
    }
}

// Mock ê³„ì‚° ê²°ê³¼ ìƒì„±
function generateMockResult(positions, targetRatio) {
    const totalExposure = positions.reduce((sum, p) => sum + p.amount, 0);
    const targetHedgeAmount = totalExposure * (targetRatio / 100);
    
    return {
        totalExposure: totalExposure,
        targetHedgeRatio: targetRatio,
        targetHedgeAmount: targetHedgeAmount,
        currentHedgedAmount: totalExposure * 0.4, // ê°€ì •: í˜„ì¬ 40% í—¤ì§€ë¨
        currentHedgeRatio: 40,
        gap: 40 - targetRatio,
        unhedgedAmount: totalExposure - (totalExposure * 0.4)
    };
}

// 4. ìƒíƒœ í™•ì¸
function checkFlowStatus() {
    addLog('=== í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ ===', 'info');
    
    const uploaded = localStorage.getItem('uploadedData');
    const anonymized = localStorage.getItem('anonymizedData');
    
    if (uploaded) {
        const count = JSON.parse(uploaded).length;
        addLog(`âœ“ localStorage.uploadedData: ${count}ê±´`, 'response');
    } else {
        addLog(`âœ— localStorage.uploadedData: ì—†ìŒ`, 'warning');
    }
    
    if (anonymized) {
        const count = JSON.parse(anonymized).length;
        addLog(`âœ“ localStorage.anonymizedData: ${count}ê±´`, 'response');
    } else {
        addLog(`âœ— localStorage.anonymizedData: ì—†ìŒ`, 'warning');
    }
    
    const sessionLog = JSON.parse(localStorage.getItem('flowLog') || '[]');
    addLog(`ğŸ“‹ ì„¸ì…˜ ë¡œê·¸: ${sessionLog.length}ê°œ í•­ëª©`, 'info');
}

// UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
function renderOriginalData(data) {
    const tbody = document.getElementById('originalDataBody');
    tbody.innerHTML = data.map(row => `
        <tr>
            <td class="border border-gray-300 px-2 py-1">${row.counterparty}</td>
            <td class="border border-gray-300 px-2 py-1">${row.currency}</td>
            <td class="border border-gray-300 px-2 py-1">${row.amount.toLocaleString()}</td>
            <td class="border border-gray-300 px-2 py-1">${row.type}</td>
            <td class="border border-gray-300 px-2 py-1">${row.date}</td>
        </tr>
    `).join('');
}

function renderAnonymizedData(data) {
    const tbody = document.getElementById('anonymizedDataBody');
    tbody.innerHTML = data.map(row => `
        <tr>
            <td class="border border-gray-300 px-2 py-1">${row.currency}</td>
            <td class="border border-gray-300 px-2 py-1">${row.amount.toLocaleString()}</td>
            <td class="border border-gray-300 px-2 py-1">${row.type}</td>
            <td class="border border-gray-300 px-2 py-1">${row.date}</td>
            <td class="border border-gray-300 px-2 py-1 text-xs">${row.anonymousId}</td>
        </tr>
    `).join('');
}

function renderCalculationResult(kpi) {
    if (!kpi) return;
    
    document.getElementById('resultExposure').textContent = 
        '$' + (kpi.totalExposure || 0).toLocaleString();
    document.getElementById('resultTargetHedge').textContent = 
        '$' + (kpi.targetHedgeAmount || 0).toLocaleString();
    document.getElementById('resultCurrentRatio').textContent = 
        (kpi.currentHedgeRatio || 0) + '%';
}

function clearLogs() {
    document.getElementById('logContainer').innerHTML = 
        '<div class="text-yellow-300">[ì‹œìŠ¤í…œ] ë¡œê·¸ ë¹„ì›Œì§. ìœ„ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.</div>';
    logs.length = 0;
    addLog('ë¡œê·¸ ì´ˆê¸°í™” ì™„ë£Œ', 'info');
}

// ì´ˆê¸° ë©”ì‹œì§€
addLog('ğŸš€ ì—…ë¡œë“œ íë¦„ ì¶”ì  ë””ë²„ê±° ì¤€ë¹„ ì™„ë£Œ', 'info');
addLog('ì™¼ìª½ íŒ¨ë„ì—ì„œ ë‹¨ê³„ë³„ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”', 'info');
</script>
</body>
</html>
