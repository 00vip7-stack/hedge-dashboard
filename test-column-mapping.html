<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¬ëŸ¼ ë§¤í•‘ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; }
        .success { color: green; background: #e6ffe6; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { color: red; background: #ffe6e6; padding: 10px; margin: 10px 0; border-radius: 4px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #45a049; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #4CAF50; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Excel ì»¬ëŸ¼ ë§¤í•‘ í…ŒìŠ¤íŠ¸</h1>
    
    <div>
        <input type="file" id="fileInput" accept=".xlsx,.xls">
        <button onclick="testMapping()">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        // ì»¬ëŸ¼ ë§¤í•‘ í•¨ìˆ˜ (excel-parser.jsì™€ ë™ì¼)
        function mapColumns(headers) {
            const map = {
                counterparty: -1,
                currency: -1,
                amount: -1,
                date: -1,
                bank: -1,
                type: -1
            };
            
            const mappingRules = {
                counterparty: ['ê±°ë˜ì²˜', 'ê±°ë˜ì²˜ëª…', 'ì—…ì²´ëª…', 'ê³ ê°ì‚¬', 'ìƒëŒ€ì²˜', 'counterparty', 'client', 'customer', 'íšŒì‚¬ëª…', 'ìƒí˜¸'],
                currency: ['í†µí™”', 'ì™¸í™”', 'ì™¸í™”ì¢…ë¥˜', 'í†µí™”ì½”ë“œ', 'currency', 'curr', 'ccy', 'í™”í', 'ì™¸í™”êµ¬ë¶„'],
                amount: ['ê¸ˆì•¡', 'ì™¸í™”ê¸ˆì•¡', 'ê±°ë˜ê¸ˆì•¡', 'ìˆ˜ëŸ‰', 'amount', 'amt', 'ì™¸í™”ìˆ˜ëŸ‰', 'ë°œìƒê¸ˆì•¡', 'ê¸ˆì•¡(ì™¸í™”)'],
                date: ['ë‚ ì§œ', 'ê±°ë˜ì¼', 'ê²°ì œì˜ˆì •ì¼', 'ì˜ˆì •ì¼', 'date', 'ì¼ì', 'ê²°ì œì¼', 'ë§Œê¸°ì¼', 'ì •ì‚°ì¼'],
                bank: ['ì€í–‰', 'ê±°ë˜ì€í–‰', 'ê¸ˆìœµê¸°ê´€', 'bank', 'ì€í–‰ëª…'],
                type: ['ìœ í˜•', 'ê±°ë˜ìœ í˜•', 'êµ¬ë¶„', 'type', 'ì¢…ë¥˜', 'ìˆ˜ì¶œì…êµ¬ë¶„', 'ê±°ë˜êµ¬ë¶„', 'ìˆ˜ì¶œ/ìˆ˜ì…']
            };
            
            let log = '<h3>ğŸ” ë§¤í•‘ ê³¼ì •</h3>';
            
            headers.forEach((header, index) => {
                const headerStr = String(header).trim().toLowerCase();
                log += `<div>ì»¬ëŸ¼ ${index}: "${header}" (ì†Œë¬¸ì: "${headerStr}")</div>`;
                
                for (const [field, keywords] of Object.entries(mappingRules)) {
                    const matched = keywords.some(keyword => {
                        const keywordLower = keyword.toLowerCase();
                        const isMatch = headerStr.includes(keywordLower) || keywordLower.includes(headerStr);
                        if (isMatch) {
                            log += `  <span style="color: green;">âœ“ ${field} ë§¤ì¹­! (í‚¤ì›Œë“œ: "${keyword}")</span><br>`;
                        }
                        return isMatch;
                    });
                    
                    if (matched && map[field] === -1) {
                        map[field] = index;
                    }
                }
            });
            
            return { map, log };
        }
        
        async function testMapping() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</div>';
                return;
            }
            
            try {
                const file = fileInput.files[0];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const headers = jsonData[0];
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>âœ… íŒŒì¼ ì½ê¸° ì„±ê³µ: ${file.name}</h3>
                        <p>ì‹œíŠ¸: ${firstSheetName}</p>
                        <p>ì´ í–‰ìˆ˜: ${jsonData.length}</p>
                    </div>
                `;
                
                // í—¤ë” í‘œì‹œ
                resultDiv.innerHTML += `
                    <h3>ğŸ“‹ í—¤ë”</h3>
                    <table>
                        <tr><th>ì¸ë±ìŠ¤</th><th>ì»¬ëŸ¼ëª…</th><th>íƒ€ì…</th></tr>
                        ${headers.map((h, i) => `<tr><td>${i}</td><td>${h}</td><td>${typeof h}</td></tr>`).join('')}
                    </table>
                `;
                
                // ë§¤í•‘ í…ŒìŠ¤íŠ¸
                const { map, log } = mapColumns(headers);
                
                resultDiv.innerHTML += log;
                
                resultDiv.innerHTML += `
                    <h3>ğŸ—ºï¸ ìµœì¢… ë§¤í•‘ ê²°ê³¼</h3>
                    <pre>${JSON.stringify(map, null, 2)}</pre>
                `;
                
                // í•„ìˆ˜ ì»¬ëŸ¼ ì²´í¬
                const missingFields = [];
                if (map.currency === -1) missingFields.push('í†µí™”');
                if (map.amount === -1) missingFields.push('ê¸ˆì•¡');
                
                if (missingFields.length > 0) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <h3>âŒ í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½</h3>
                            <p>ëˆ„ë½ëœ ì»¬ëŸ¼: ${missingFields.join(', ')}</p>
                            <p>ì‚¬ìš© ê°€ëŠ¥í•œ í—¤ë”: ${headers.join(', ')}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="success">
                            <h3>âœ… ë§¤í•‘ ì„±ê³µ!</h3>
                            <p>í†µí™”: ì»¬ëŸ¼ ${map.currency} (${headers[map.currency]})</p>
                            <p>ê¸ˆì•¡: ì»¬ëŸ¼ ${map.amount} (${headers[map.amount]})</p>
                        </div>
                    `;
                    
                    // ë°ì´í„° ìƒ˜í”Œ í‘œì‹œ
                    resultDiv.innerHTML += `
                        <h3>ğŸ“Š ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 3í–‰)</h3>
                        <table>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            ${jsonData.slice(1, 4).map(row => 
                                `<tr>${row.map(cell => `<td>${cell || ''}</td>`).join('')}</tr>`
                            ).join('')}
                        </table>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
