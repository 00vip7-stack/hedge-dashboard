<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í…ŒìŠ¤íŠ¸ ë°ì´í„° ì£¼ì…</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-6">ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ì£¼ì…</h1>
        
        <div class="space-y-4">
            <button onclick="injectTestData()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-bold">
                ğŸ“Š í…ŒìŠ¤íŠ¸ ë°ì´í„° ì£¼ì…
            </button>
            
                <button onclick="requestServerAnalysis()" class="w-full bg-indigo-500 text-white py-3 rounded-lg hover:bg-indigo-600 font-bold">
                    ğŸ” ì„œë²„ë¡œ ê³„ì‚° ìš”ì²­ (ë°°ì¹˜)
                </button>
            
            <button onclick="checkData()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-bold">
                ğŸ” í˜„ì¬ ë°ì´í„° í™•ì¸
            </button>
            
            <button onclick="clearData()" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-bold">
                ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ
            </button>
            
            <div class="grid grid-cols-2 gap-4 mt-6">
                <a href="hedge-manager.html" class="bg-gray-200 text-center py-3 rounded-lg hover:bg-gray-300">
                    â†’ í—¤ì§€ë§¤ë‹ˆì €
                </a>
                <a href="02 ë…¸ì¶œë¶„ì„ .html" class="bg-gray-200 text-center py-3 rounded-lg hover:bg-gray-300">
                    â†’ ë…¸ì¶œë¶„ì„
                </a>
            </div>
        </div>
        
        <div id="result" class="mt-6 p-4 bg-gray-50 rounded font-mono text-xs whitespace-pre-wrap"></div>
    </div>

    <script>
        function injectTestData() {
            const testData = [
                { id: 1, type: 'receivable', currency: 'USD', amount: 5000000, maturityDate: '2026-05-15', counterparty: 'ì‚¼ì„±ì „ì' },
                { id: 2, type: 'receivable', currency: 'USD', amount: 3000000, maturityDate: '2026-06-20', counterparty: 'LGì „ì' },
                { id: 3, type: 'payable', currency: 'USD', amount: 2000000, maturityDate: '2026-04-10', counterparty: 'Apple' },
                { id: 4, type: 'receivable', currency: 'EUR', amount: 1500000, maturityDate: '2026-07-01', counterparty: 'BMW' },
                { id: 5, type: 'payable', currency: 'EUR', amount: 800000, maturityDate: '2026-05-25', counterparty: 'Siemens' },
                { id: 6, type: 'receivable', currency: 'JPY', amount: 200000000, maturityDate: '2026-08-15', counterparty: 'Sony' },
                { id: 7, type: 'payable', currency: 'JPY', amount: 150000000, maturityDate: '2026-06-30', counterparty: 'Toyota' },
                { id: 8, type: 'receivable', currency: 'CNY', amount: 10000000, maturityDate: '2026-09-01', counterparty: 'Huawei' }
            ];
            
            localStorage.setItem('uploadedData', JSON.stringify(testData));
            localStorage.setItem('uploadedDataTimestamp', new Date().toISOString());
            localStorage.setItem('LIGHTWEIGHT_MODE', 'true');
            
            document.getElementById('result').textContent = 
                'âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì£¼ì… ì™„ë£Œ!\n\n' +
                'ì´ ' + testData.length + 'ê±´ì˜ ê±°ë˜ ë°ì´í„°:\n' +
                testData.map(d => `- ${d.counterparty}: ${d.currency} ${d.amount.toLocaleString()} (${d.type})`).join('\n');
        }
        
        async function requestServerAnalysis() {
            const dataStr = localStorage.getItem('uploadedData');
            if (!dataStr) {
                document.getElementById('result').textContent = 'âŒ ë¨¼ì € "í…ŒìŠ¤íŠ¸ ë°ì´í„° ì£¼ì…"ì„ ëˆŒëŸ¬ uploadedDataë¥¼ ë§Œë“œì„¸ìš”.';
                return;
            }

            const data = JSON.parse(dataStr);
            // ê°„ë‹¨í•œ í†µí™”ë³„ ìš”ì•½ êµ¬ì„±
            const currencySummary = {};
            data.forEach(item => {
                const c = item.currency || 'USD';
                if (!currencySummary[c]) currencySummary[c] = { receivable: 0, payable: 0 };
                if (item.type === 'receivable') currencySummary[c].receivable += Number(item.amount) || 0;
                else currencySummary[c].payable += Number(item.amount) || 0;
            });

            const payload = { currencySummary, maturityBuckets: {}, options: { targetHedgeRatio: 75 } };

            document.getElementById('result').textContent = 'â³ ì„œë²„ë¡œ ê³„ì‚° ìš”ì²­ ì¤‘...';
            try {
                const res = await fetch('http://localhost:9000/api/calculator/batch', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const json = await res.json();
                if (!json) throw new Error('No JSON');

                // ì €ì¥ ë° ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜
                localStorage.setItem('serverAnalysisResult', JSON.stringify(json));
                try { window.dispatchEvent(new CustomEvent('serverAnalysisResultUpdated', { detail: json })); } catch(e){}

                document.getElementById('result').textContent = 'âœ… ì„œë²„ ê³„ì‚° ê²°ê³¼ ì €ì¥ ë° ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜ ì™„ë£Œ:\n\n' + JSON.stringify(json, null, 2);
            } catch (err) {
                document.getElementById('result').textContent = 'âŒ ì„œë²„ ê³„ì‚° ì‹¤íŒ¨:\n' + err.message;
            }
        }
        
        function checkData() {
            const data = localStorage.getItem('uploadedData');
            const timestamp = localStorage.getItem('uploadedDataTimestamp');
            const netting = localStorage.getItem('nettingResult');
            const serverResult = localStorage.getItem('serverAnalysisResult');
            
            let result = 'ğŸ“¦ localStorage ìƒíƒœ:\n\n';
            
            if (data) {
                const parsed = JSON.parse(data);
                result += `âœ… uploadedData: ${parsed.length}ê±´\n`;
                result += `   ì—…ë¡œë“œ ì‹œê°„: ${timestamp || 'ì•Œ ìˆ˜ ì—†ìŒ'}\n\n`;
                result += 'ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:\n';
                result += JSON.stringify(parsed.slice(0, 3), null, 2);
            } else {
                result += 'âŒ uploadedData: ì—†ìŒ\n';
            }
            
            result += '\n\n';
            result += netting ? 'âœ… nettingResult: ìˆìŒ' : 'âŒ nettingResult: ì—†ìŒ';
            result += '\n';
            result += serverResult ? 'âœ… serverAnalysisResult: ìˆìŒ' : 'âŒ serverAnalysisResult: ì—†ìŒ';
            
            document.getElementById('result').textContent = result;
        }
        
        function clearData() {
            localStorage.removeItem('uploadedData');
            localStorage.removeItem('uploadedDataTimestamp');
            localStorage.removeItem('nettingResult');
            localStorage.removeItem('serverAnalysisResult');
            
            document.getElementById('result').textContent = 'ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í™•ì¸
        window.onload = checkData;
    </script>
</body>
</html>
