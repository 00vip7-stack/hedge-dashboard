<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ì¶œ ë¶„ì„ - HedgeFreedom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="core/api-client.js"></script>
    <script src="core/local-storage-manager.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hedgefreedom-dark': '#1a1f2e'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Malgun Gothic', 'Segoe UI', 'Tahoma', sans-serif; font-size: 11px; color: #333; margin: 0; }
        
        /* Toolbar & Filters */
        .toolbar { background: #fff; height: 35px; border-bottom: 1px solid #d1d5db; display: flex; align-items: center; padding: 0 15px; gap: 15px; }
        .filter-panel { background: #fff; border-bottom: 1px solid #d1d5db; padding: 12px 20px; display: flex; gap: 25px; }
        .filter-group label { display: block; font-size: 9px; font-weight: bold; color: #8c8c8c; margin-bottom: 3px; }
        .filter-group select { border: 1px solid #d1d5db; padding: 2px 5px; min-width: 140px; background: #fff; height: 22px; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-bar { background: #f3f4f6; border-bottom: 2px solid #e5e7eb; display: flex; padding: 0 20px; gap: 4px; }
        .tab-item { padding: 10px 20px; font-size: 13px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-item:hover { color: #3b82f6; }
        .tab-item.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }

        
        /* ë¶„ì„ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë…¸ì¶œë¶„ì„ê¸°ì—ì„œ ê°€ì ¸ì˜´) */
        .analysis-card { background: white; border: 1px solid #d1d5db; border-radius: 4px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .risk-value { font-family: 'Consolas', monospace; font-size: 18px; font-weight: bold; }
        .chart-container { position: relative; height: 180px; width: 100%; }

        /* The Matrix Grid */
        .matrix-container { background: #fff; overflow: auto; border: 1px solid #d1d5db; }
        .matrix-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .matrix-table th { background: #f8f9fb; border: 1px solid #d1d5db; padding: 6px; font-weight: 700; color: #595959; text-align: center; font-size: 10px; }
        .matrix-table td { border: 1px solid #f0f0f0; padding: 5px 10px; font-family: 'Consolas', monospace; text-align: right; }
        
        /* Row Styles */
        .row-entity { background: #fafafa; font-weight: bold; text-align: left !important; color: #1890ff; }
        .row-total { background: #f0f2f5; font-weight: bold; }
        
        /* Value Colors */
        .val-long { color: #096dd9; } /* Asset / Inflow */
        .val-short { color: #cf1322; } /* Liability / Outflow */
        .val-net { background-color: #fffbe6; font-weight: bold; }

        /* KPI Ribbon */
        .kpi-ribbon { display: flex; gap: 20px; padding: 10px 20px; background: #fff; border-bottom: 1px solid #d1d5db; }
        .kpi-card { border-left: 3px solid #1890ff; padding-left: 8px; }
        .kpi-title { font-size: 9px; color: #8c8c8c; font-weight: bold; text-transform: uppercase; }
        .kpi-val { font-size: 15px; font-weight: 700; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .ky-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .ky-table th { background: #f1f3f8; border: 1px solid #d1d5db; padding: 6px; text-align: left; font-weight: 700; }
        .ky-table td { border: 1px solid #f0f0f0; padding: 5px 8px; }

        /* ê³„ì‚°ê¸° ì„¤ëª… íˆ´íŒ ìŠ¤íƒ€ì¼ (ì¹´ë“œ ê·¼ì²˜ì— í‘œì‹œ) */
        .calc-tooltip { position: absolute; display: none; background: linear-gradient(180deg,#fffef7 0%,#fff8e6 100%); border-radius: 8px; padding: 12px 14px; width: 280px; box-shadow: 0 8px 26px rgba(0,0,0,0.14); font-size: 13px; color: #111827; z-index: 9999; border-left: 4px solid #f59e0b; }
        .calc-tooltip { opacity: 0; transform: translateY(6px) scale(0.995); transition: opacity 180ms ease, transform 180ms ease; }
        .calc-tooltip.show { display: block; opacity: 1; transform: translateY(0) scale(1); }
        .calc-tooltip .tt-title { font-weight: 700; margin-bottom: 6px; }
        .calc-tooltip .tt-desc { font-size: 12px; color: #444; line-height: 1.3; margin-bottom: 8px; }
        .calc-tooltip .tt-actions { text-align: right; }
        .calc-tooltip .tt-actions button { background: #2563eb; color: #fff; border: none; padding: 6px 8px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        .calc-tooltip .tt-close { position: absolute; top: 6px; right: 8px; cursor: pointer; color: #666; font-size: 14px; }
        /* ì‘ì€ ì‚¼ê°í˜• í™”ì‚´í‘œ */
        .calc-tooltip::after { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }

        /* ì¹´ë“œ ìš°ìƒë‹¨ì˜ ì„¤ëª… ë²„íŠ¼ (ëˆˆì— ë„ê²Œ) */
        .calc-info-btn { position: absolute; top: 8px; right: 10px; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #2563eb; color: #fff; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.2); border: 2px solid #fff; }
        .calc-info-btn:focus { outline: 3px solid rgba(37,99,235,0.18); }
        .calc-info-btn .dot { font-size: 14px; line-height: 0; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.35); } 70% { box-shadow: 0 0 0 8px rgba(37,99,235,0); } 100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); } }
        .calc-info-btn.pulse { animation: pulse-ring 1.6s infinite; }

        /* ìƒì„¸ ëª¨ë‹¬ (ì¤‘ì•™) */
        .calc-detail-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 10020; opacity: 0; transition: opacity 220ms ease; }
        .calc-detail-overlay.show { display: flex; opacity: 1; }
        .calc-detail-modal { width: 520px; max-width: 94%; background: linear-gradient(180deg,#eef6ff 0%,#dbefff 100%); color: #062a47; border-radius: 10px; padding: 18px 18px 12px 18px; box-shadow: 0 18px 48px rgba(0,0,0,0.28); position: relative; border-left: 6px solid #2563eb; transform: translateY(8px) scale(0.995); transition: transform 200ms ease, opacity 200ms ease; opacity: 0; }
        .calc-detail-overlay.show .calc-detail-modal { transform: translateY(0) scale(1); opacity: 1; }
        /* ì‚¬ì´ë“œë°” ë‚´ë¶€ì— í‘œì‹œí•  ë•Œì˜ ìŠ¤íƒ€ì¼ (ì‘ê³  ëˆˆì— ë„ê²Œ) */
        /* ì‚¬ì´ë“œë°” ë‚´ë¶€ì— í‘œì‹œí•  ë•Œì˜ ìŠ¤íƒ€ì¼ (ê³ ì • ìœ„ì¹˜ë¡œ ë³€ê²½) */
        .calc-detail-overlay.side { position: fixed; top: 72px; left: 8px; width: auto; display: none; background: transparent; z-index: 12030; }
        .calc-detail-overlay.side.show { display: block; }
        .calc-detail-overlay.side .calc-detail-modal { width: 100%; max-width: 100%; margin: 0; box-shadow: 0 8px 20px rgba(0,0,0,0.18); border-left: 6px solid #2563eb; padding: 12px; }
        .calc-detail-overlay.side .title { font-size: 14px; }
        .calc-detail-modal .title { font-size: 16px; font-weight: 800; margin-bottom: 8px; }
        .calc-detail-modal .body { font-size: 13px; color: #333; line-height: 1.5; margin-bottom: 12px; }
        .calc-detail-modal .controls { text-align: right; }
        .calc-detail-modal .controls button { margin-left: 8px; padding: 8px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .calc-detail-modal .controls .run { background: #059669; color: #fff; }
        .calc-detail-modal .controls .close { background: #e5e7eb; color: #111827; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-gray-50">

    <aside class="bg-hedgefreedom-dark w-60 flex-shrink-0 text-gray-400 text-sm h-screen overflow-y-auto">
        <div class="p-6 text-white text-xl font-bold border-b border-gray-800">HedgeFreedom</div>
        <nav class="mt-4 pb-20">
            <div class="px-6 py-2 text-xs font-semibold text-gray-600 uppercase">ğŸ“Œ ì—…ë¬´ íë¦„</div>
            
            <!-- STEP 1 -->
            <a href="hedge-manager.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="bg-gray-700 text-gray-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">1</span>
                í—¤ì§€ ë§¤ë‹ˆì €
            </a>
            
            <!-- STEP 2 (í˜„ì¬ í™œì„±) -->
            <a href="02 ë…¸ì¶œë¶„ì„ .html" class="flex items-center px-6 py-3 bg-blue-600 text-white font-medium">
                <span class="bg-white text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">2</span>
                ë…¸ì¶œ ë¶„ì„
            </a>
            
            <!-- STEP 3 -->
            <a href="03 ìœ„í—˜ë³´ê³ ì„œ.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="bg-gray-700 text-gray-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">3</span>
                ìœ„í—˜ ë³´ê³ ì„œ
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            
            <div class="px-6 py-2 text-xs font-semibold text-gray-600 uppercase">ì¶”ê°€ ë„êµ¬</div>
            <a href="hedge-dashboard.html" class="flex items-center px-6 py-3 hover:bg-gray-800">ğŸ“Š ì „ì²´ ëŒ€ì‹œë³´ë“œ</a>
            <a href="dashboard-analysis.html" class="flex items-center px-6 py-3 hover:bg-gray-800">ğŸ“ˆ ë¶„ì„ ë„êµ¬</a>
            <a href="demo-anonymization.html" class="flex items-center px-6 py-3 hover:bg-gray-800">ğŸ”’ ìµëª…í™” í…ŒìŠ¤íŠ¸</a>
            
            <div class="border-t border-gray-800 my-4"></div>
            
            <div class="px-6 py-2 text-xs font-semibold text-gray-600 uppercase">ê³„ì •</div>
            <a href="login.html" onclick="handleLogout(event)" class="flex items-center px-6 py-3 hover:bg-gray-800 text-red-400">
                ğŸšª ë¡œê·¸ì•„ì›ƒ
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col">
        <header class="bg-white border-b">
            <div class="text-right px-8 py-0.5 border-b border-gray-50">
                <span class="text-[10px] text-gray-400 font-light">ê°±ì‹  1ë¶„ì „</span>
            </div>
            <div class="h-14 flex items-center justify-between px-8">
                <div class="flex items-center space-x-6 flex-1">
                    <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded">
                        <span class="text-xs font-bold text-gray-600">USD/KRW</span>
                        <span class="text-sm font-bold text-green-600">1,342.50</span>
                        <span class="text-[10px] text-green-600">â–²0.45%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-red-50 rounded">
                        <span class="text-xs font-bold text-gray-600">EUR/USD</span>
                        <span class="text-sm font-bold text-red-600">1.0842</span>
                        <span class="text-[10px] text-red-600">â–¼0.12%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded">
                        <span class="text-xs font-bold text-gray-600">USD/JPY</span>
                        <span class="text-sm font-bold text-green-600">148.23</span>
                        <span class="text-[10px] text-green-600">â–²0.28%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-red-50 rounded">
                        <span class="text-xs font-bold text-gray-600">USD/CNY</span>
                        <span class="text-sm font-bold text-red-600">7.2145</span>
                        <span class="text-[10px] text-red-600">â–¼0.08%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded">
                        <span class="text-xs font-bold text-gray-600">DXY</span>
                        <span class="text-sm font-bold text-green-600">103.42</span>
                        <span class="text-[10px] text-green-600">â–²0.15%</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- íƒ­ ë°” ì¶”ê°€ -->
        <div class="tab-bar">
            <div class="tab-item active" onclick="showTab('overview')">ê°œìš” ëŒ€ì‹œë³´ë“œ</div>
            <div class="tab-item" onclick="showTab('matrix')">ìƒì„¸ ë§¤íŠ¸ë¦­ìŠ¤</div>
            <div class="tab-item" onclick="showTab('analysis')">ë¦¬ìŠ¤í¬ ë¶„ì„</div>
        </div>

        <!-- íƒ­ ì»¨í…ì¸ : ê°œìš” ëŒ€ì‹œë³´ë“œ (ë…¸ì¶œë¶„ì„ê¸°ì—ì„œ ê°€ì ¸ì˜´) -->
        <div id="tab-overview" class="flex-1 overflow-hidden">
            <div class="p-6 overflow-y-auto h-full space-y-4">
                
                <!-- ë°ì´í„° ìƒíƒœ ì•Œë¦¼ -->
                <div id="dataStatusBanner" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">ğŸ“Š</span>
                            <span class="text-sm text-yellow-800">í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                        </div>
                        <a href="hedge-manager.html" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            ë°ì´í„° ì—…ë¡œë“œí•˜ê¸° â†’
                        </a>
                    </div>
                </div>

                <!-- KPI ì¹´ë“œ 4ê°œ -->
                <div id="exposureKpiSection" class="grid grid-cols-4 gap-4">
                    <div class="analysis-card border-l-4 border-l-red-500">
                        <div class="text-[9px] text-gray-400 font-bold">ìµœëŒ€ ì˜ˆìƒ ì†ì‹¤ì•¡ (VaR 95%)</div>
                        <div id="kpiVaR" class="risk-value text-red-600">â‚© 0</div>
                        <div id="kpiVaRChange" class="text-[9px] text-gray-400 mt-1">ë°ì´í„° ì—†ìŒ</div>
                    </div>
                    <div class="analysis-card border-l-4 border-l-blue-500">
                        <div class="text-[9px] text-gray-400 font-bold">í•©ì‚° ìˆœ ë…¸ì¶œ (Net Exposure)</div>
                        <div id="kpiNetExposure" class="risk-value text-blue-800">$ 0</div>
                        <div id="kpiCurrencyInfo" class="text-[9px] text-gray-400 mt-1">ë°ì´í„° ì—†ìŒ</div>
                    </div>
                    <div class="analysis-card border-l-4 border-l-orange-400">
                        <div class="text-[9px] text-gray-400 font-bold">í˜„ì¬ í—¤ì§€ ë¹„ìœ¨ (Hedge Ratio)</div>
                        <div id="kpiHedgeRatio" class="risk-value text-gray-700">0 %</div>
                        <div class="w-full bg-gray-200 h-2 mt-2 rounded-full overflow-hidden">
                            <div id="hedgeRatioBar" class="bg-orange-400 h-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="analysis-card border-l-4 border-l-yellow-500">
                        <div class="text-[9px] text-gray-400 font-bold">ë¦¬ìŠ¤í¬ ì •ì±… ì¤€ìˆ˜</div>
                        <div id="kpiPolicyStatus" class="risk-value text-gray-400 italic">ë°ì´í„° ì—†ìŒ</div>
                        <div id="kpiPolicyMessage" class="text-[9px] text-gray-400 mt-1 italic">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                    </div>
                </div>

                <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
                <!-- ğŸ“Š ì„œë²„ ê³„ì‚°ê¸° ëª¨ë“ˆ ì¹´ë“œ (9ê°œ) -->
                <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-gray-700">ğŸ“Š ì„œë²„ ê³„ì‚°ê¸° ë¶„ì„ ê²°ê³¼</h3>
                        <div class="flex items-center gap-2">
                            <span id="calculatorServerStatus" class="text-[9px] text-gray-400">ì„œë²„ ì—°ê²° ëŒ€ê¸°</span>
                            <button onclick="runAllCalculators()" id="runCalculatorsBtn"
                                    class="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded hover:bg-blue-700 disabled:bg-gray-400">
                                ğŸ”„ ì „ì²´ ê³„ì‚° ì‹¤í–‰
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3" id="calculatorCardsContainer">
                        <!-- ê³„ì‚°ê¸° 01: ìµœì  í—¤ì§€ ë¹„ìœ¨ -->
                        <div class="analysis-card border-l-4 border-l-blue-500 calculator-card" data-calc="01" data-desc="ë³´ìœ  í¬ì§€ì…˜ê³¼ ì‹œì¥ ë³€ë™ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë¹„ìš© ëŒ€ë¹„ ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ìµœì ì˜ í—¤ì§€ ë¹„ìœ¨ì„ ì œì•ˆí•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-blue-600 font-bold">ê³„ì‚°ê¸° 01</div>
                                    <div class="text-[11px] font-bold text-gray-700">ìµœì  í—¤ì§€ ë¹„ìœ¨</div>
                                </div>
                                <span class="text-lg">ğŸ¯</span>
                            </div>
                            <div id="calc01Value" class="text-xl font-bold text-blue-600 mt-2">--%</div>
                            <div id="calc01Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 02: í—¤ì§€ ë„êµ¬ ì¶”ì²œ -->
                        <div class="analysis-card border-l-4 border-l-green-500 calculator-card" data-calc="02" data-desc="ì—¬ëŸ¬ í—¤ì§€ ìˆ˜ë‹¨(ì„ ë„, ì˜µì…˜ ë“±)ì„ ë¹„êµí•´ ë¹„ìš©Â·ìœ ë™ì„±Â·íš¨ê³¼ì„±ì„ ê³ ë ¤í•œ ì¶”ì²œ í—¤ì§€ ë„êµ¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-green-600 font-bold">ê³„ì‚°ê¸° 02</div>
                                    <div class="text-[11px] font-bold text-gray-700">í—¤ì§€ ë„êµ¬ ì¶”ì²œ</div>
                                </div>
                                <span class="text-lg">ğŸ› ï¸</span>
                            </div>
                            <div id="calc02Value" class="text-sm font-bold text-green-600 mt-2">--</div>
                            <div id="calc02Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 03: ê²°ì œì¼ í™˜ìœ¨ ì˜ˆì¸¡ -->
                        <div class="analysis-card border-l-4 border-l-purple-500 calculator-card" data-calc="03" data-desc="ê²°ì œì¼ ê¸°ì¤€ í™˜ìœ¨ì„ ì‹œê³„ì—´ ë° ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ìœ¼ë¡œ ì˜ˆì¸¡í•˜ì—¬ í™˜ë¦¬ìŠ¤í¬ë¥¼ ì‚¬ì „ ì‹ë³„í•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-purple-600 font-bold">ê³„ì‚°ê¸° 03</div>
                                    <div class="text-[11px] font-bold text-gray-700">ê²°ì œì¼ í™˜ìœ¨ ì˜ˆì¸¡</div>
                                </div>
                                <span class="text-lg">ğŸ”®</span>
                            </div>
                            <div id="calc03Value" class="text-xl font-bold text-purple-600 mt-2">--ì›</div>
                            <div id="calc03Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 04: ì†ìµ ê³„ì‚° -->
                        <div class="analysis-card border-l-4 border-l-red-500 calculator-card" data-calc="04" data-desc="í¬ì§€ì…˜ë³„ ë° ì‹œë‚˜ë¦¬ì˜¤ë³„ ì†ìµ(P&L)ì„ ê³„ì‚°í•´ ì˜ˆìƒ ì†ìµ ë²”ìœ„ë¥¼ ì œê³µí•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-red-600 font-bold">ê³„ì‚°ê¸° 04</div>
                                    <div class="text-[11px] font-bold text-gray-700">ì†ìµ ê³„ì‚° (P&L)</div>
                                </div>
                                <span class="text-lg">ğŸ’°</span>
                            </div>
                            <div id="calc04Value" class="text-xl font-bold text-red-600 mt-2">--ì–µì›</div>
                            <div id="calc04Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 05: í—¤ì§€ ë¹„ìš© -->
                        <div class="analysis-card border-l-4 border-l-yellow-500 calculator-card" data-calc="05" data-desc="ì œì•ˆëœ í—¤ì§€ ê³„íšì˜ ì˜ˆìƒ ë¹„ìš©(í”„ë¦¬ë¯¸ì—„, ìŠ¤í”„ë ˆë“œ ë“±)ì„ ì‚°ì¶œí•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-yellow-600 font-bold">ê³„ì‚°ê¸° 05</div>
                                    <div class="text-[11px] font-bold text-gray-700">í—¤ì§€ ë¹„ìš© ê³„ì‚°</div>
                                </div>
                                <span class="text-lg">ğŸ’µ</span>
                            </div>
                            <div id="calc05Value" class="text-xl font-bold text-yellow-600 mt-2">--ì›</div>
                            <div id="calc05Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 06: ì‹œê°„ê°€ì¹˜ ê°ì‡  -->
                        <div class="analysis-card border-l-4 border-l-pink-500 calculator-card" data-calc="06" data-desc="ì‹œê°„ ê²½ê³¼ì— ë”°ë¥¸ ê°€ì¹˜ê°ì†Œ(ì‹œê°„ê°€ì¹˜)ë¥¼ ì¼ë³„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì •í•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-pink-600 font-bold">ê³„ì‚°ê¸° 06</div>
                                    <div class="text-[11px] font-bold text-gray-700">ì‹œê°„ê°€ì¹˜ ê°ì‡ </div>
                                </div>
                                <span class="text-lg">â±ï¸</span>
                            </div>
                            <div id="calc06Value" class="text-xl font-bold text-pink-600 mt-2">--ì›/ì¼</div>
                            <div id="calc06Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 07: VaR ê³„ì‚° -->
                        <div class="analysis-card border-l-4 border-l-indigo-500 calculator-card" data-calc="07" data-desc="ì£¼ì–´ì§„ ì‹ ë¢°ìˆ˜ì¤€(ì˜ˆ: 95%)ê³¼ ê¸°ê°„ ê¸°ì¤€ìœ¼ë¡œ VaR(ì˜ˆìƒ ìµœëŒ€ ì†ì‹¤)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-indigo-600 font-bold">ê³„ì‚°ê¸° 07</div>
                                    <div class="text-[11px] font-bold text-gray-700">VaR ê³„ì‚°</div>
                                </div>
                                <span class="text-lg">ğŸ“‰</span>
                            </div>
                            <div id="calc07Value" class="text-xl font-bold text-indigo-600 mt-2">--ì–µì›</div>
                            <div id="calc07Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 08: ë¯¼ê°ë„ ë¶„ì„ -->
                        <div class="analysis-card border-l-4 border-l-teal-500 calculator-card" data-calc="08" data-desc="ì£¼ìš” ìš”ì¸ë³„ ë¯¼ê°ë„(ì˜ˆ: í™˜ìœ¨ Â±1%)ì— ë”°ë¥¸ ì†ìµ ë³€ë™ì„ ë¶„ì„í•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-teal-600 font-bold">ê³„ì‚°ê¸° 08</div>
                                    <div class="text-[11px] font-bold text-gray-700">ë¯¼ê°ë„ ë¶„ì„</div>
                                </div>
                                <span class="text-lg">ğŸ“Š</span>
                            </div>
                            <div id="calc08Value" class="text-xl font-bold text-teal-600 mt-2">Â±--ì–µ</div>
                            <div id="calc08Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                        
                        <!-- ê³„ì‚°ê¸° 09: í—¤ì§€ íš¨ê³¼ì„± -->
                        <div class="analysis-card border-l-4 border-l-gray-500 calculator-card" data-calc="09" data-desc="ì œì•ˆëœ í—¤ì§€ ì „ëµì˜ íš¨ê³¼ì„±(ë‹¬ëŸ¬ ì˜¤í”„ì…‹ ë“±)ì„ ì •ëŸ‰ì ìœ¼ë¡œ í‰ê°€í•©ë‹ˆë‹¤.">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-[9px] text-gray-600 font-bold">ê³„ì‚°ê¸° 09</div>
                                    <div class="text-[11px] font-bold text-gray-700">í—¤ì§€ íš¨ê³¼ì„±</div>
                                </div>
                                <span class="text-lg">âœ…</span>
                            </div>
                            <div id="calc09Value" class="text-xl font-bold text-gray-600 mt-2">--%</div>
                            <div id="calc09Detail" class="text-[9px] text-gray-500 mt-1">ë°ì´í„° ëŒ€ê¸° ì¤‘</div>
                        </div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ + í…Œì´ë¸” -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="analysis-card col-span-1 flex flex-col items-center">
                        <div class="w-full text-[11px] font-bold text-gray-600 mb-3">í†µí™”ë³„ ë¦¬ìŠ¤í¬ ë¹„ì¤‘</div>
                        <div class="chart-container">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>

                    <div class="analysis-card col-span-2 overflow-hidden flex flex-col">
                        <div class="flex justify-between mb-3">
                            <span class="text-[11px] font-bold text-gray-600">í†µí™”ë³„ ìˆœ í¬ì§€ì…˜ ë‚´ì—­</span>
                            <span id="dataSourceInfo" class="text-[9px] text-gray-400 italic">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</span>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="ky-table">
                                <thead>
                                    <tr>
                                        <th>í†µí™”ìŒ</th>
                                        <th class="text-right">ì´ ë…¸ì¶œì•¡</th>
                                        <th class="text-right">ë‚´ë¶€ ìƒê³„(Netting)</th>
                                        <th class="text-right bg-blue-50">ìˆœ ë…¸ì¶œì•¡ (Net)</th>
                                        <th class="text-right">í˜„ì¬ í—¤ì§€ì•¡</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="exposureTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-400">
                                            <div class="text-3xl mb-2">ğŸ“Š</div>
                                            <p>í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´</p>
                                            <p class="text-xs mt-1">í†µí™”ë³„ í¬ì§€ì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- íŠ¸ë Œë“œ ê·¸ë˜í”„ ì˜ì—­ -->
                <div class="analysis-card">
                    <div class="text-[11px] font-bold text-gray-600 mb-3">ìµœê·¼ 30ì¼ í™˜ìœ¨ ë³€ë™ì— ë”°ë¥¸ ë¦¬ìŠ¤í¬ ì¶”ì´</div>
                    <div class="h-32 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-dashed border-blue-200 rounded flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-blue-400 text-2xl mb-2">ğŸ“Š</div>
                            <div class="text-sm text-gray-500">í™˜ìœ¨ ì¶”ì´ì™€ ì˜ˆìƒ ì†ì‹¤ì•¡ì˜ ìƒê´€ê´€ê³„ ì‹œê°í™”</div>
                            <div class="text-xs text-gray-400 mt-1">(í–¥í›„ Chart.js ë¼ì¸ ì°¨íŠ¸ë¡œ êµ¬í˜„ ì˜ˆì •)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ì»¨í…ì¸ : ìƒì„¸ ë§¤íŠ¸ë¦­ìŠ¤ (ê¸°ì¡´ ë…¸ì¶œë¶„ì„ 2) -->
        <div id="tab-matrix" class="flex-1 overflow-hidden" style="display:none;">
            <div class="h-full flex flex-col">
                <div class="toolbar text-[10px] font-bold">
            <span class="text-blue-600">ë³´ê¸°: í†µí•© FX ë…¸ì¶œ</span>
            <span class="text-gray-300">|</span>
            <span>ì‹œë‚˜ë¦¬ì˜¤: í˜„ì¬ ì‹œì¥</span>
            <span class="text-gray-300">|</span>
            <span class="text-green-600 italic underline">ê°±ì‹ : 2026-02-02 07:05</span>
        </div>

        <div class="filter-panel">
            <div class="filter-group">
                <label>ë¶„ì„ ìˆ˜ì¤€</label>
                <select><option>ë²•ì¸ / í†µí™” / ë§Œê¸°</option></select>
            </div>
            <div class="filter-group">
                <label>ê¸°ì¤€ í†µí™”</label>
                <select><option>USD - ë¯¸êµ­ ë‹¬ëŸ¬</option></select>
            </div>
            <div class="filter-group">
                <label>í‘œì‹œ ë‹¨ìœ„</label>
                <select><option>ì²œ ë‹¨ìœ„ (k)</option></select>
            </div>
            <div class="flex items-end">
                <button class="bg-blue-600 text-white font-bold px-6 h-[22px] rounded-sm hover:bg-blue-700">ê³„ì‚°</button>
            </div>
        </div>

        <div class="kpi-ribbon">
            <div class="kpi-card">
                <div class="kpi-title">ì´ ë…¸ì¶œ (USD í™˜ì‚°)</div>
                <div id="matrixTotalExposure" class="kpi-val">--</div>
            </div>
            <div class="kpi-card border-l-red-500">
                <div class="kpi-title">ìˆœ ë¯¸í—¤ì§€ ë…¸ì¶œ</div>
                <div id="matrixUnhedgedExposure" class="kpi-val text-red-600">--</div>
            </div>
            <div class="kpi-card border-l-green-500">
                <div class="kpi-title">í—¤ì§€ ê¸ˆì•¡</div>
                <div id="matrixHedgedAmount" class="kpi-val text-green-600">--</div>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-hidden flex flex-col">
            <div class="matrix-container flex-1 shadow-sm">
                <table class="matrix-table">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th rowspan="2" class="w-48">êµ¬ì¡° (ë²•ì¸ > í†µí™”)</th>
                            <th colspan="3" class="bg-blue-50 border-b-2 border-blue-200">ì´ í†µí•© (USD)</th>
                            <th colspan="2" class="bg-gray-100">ë§Œê¸° êµ¬ê°„ (í˜„ì¬)</th>
                            <th colspan="2" class="bg-gray-100">ë§Œê¸° êµ¬ê°„ (í–¥í›„ 30ì¼)</th>
                        </tr>
                        <tr>
                            <th>ì´ ë…¸ì¶œ</th>
                            <th>ì´ í—¤ì§€</th>
                            <th class="val-net">ìˆœ í¬ì§€ì…˜</th>
                            <th>ìœ ì…</th>
                            <th>ìœ ì¶œ</th>
                            <th>ìœ ì…</th>
                            <th>ìœ ì¶œ</th>
                        </tr>
                    </thead>
                    <tbody id="matrixTableBody">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-400">ë°ì´í„° ì—†ìŒ â€” í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì„œë²„ ê³„ì‚°ì„ ì‹¤í–‰í•˜ì„¸ìš”.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="h-32 bg-white mt-4 border border-slate-300 p-3 flex gap-8">
                <div class="flex-1 border-r pr-4">
                    <div class="text-[9px] font-bold text-gray-500 uppercase mb-2">í—¤ì§€ ì»¤ë²„ë¦¬ì§€ ì •ì±… ì¤€ìˆ˜</div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1 bg-gray-200 h-3 rounded-sm"><div class="bg-blue-500 h-full w-[72%]"></div></div>
                        <span class="font-bold">72.1%</span>
                    </div>
                    <p class="text-[9px] text-red-500 mt-1 italic">* ì •ì±… ê²½ê³ : EUR/USD í¬ì§€ì…˜ì´ ëª©í‘œ 75% ë¯¸ë§Œì…ë‹ˆë‹¤.</p>
                </div>
                <div class="w-64">
                    <div class="text-[9px] font-bold text-gray-500 uppercase mb-2">VaR ë¯¼ê°ë„ (+/- 5%)</div>
                    <div class="flex justify-between text-[10px]">
                        <span>+5% ì‹œ ì´ìµ</span> <span class="text-blue-600 font-bold">+$2.1M</span>
                    </div>
                    <div class="flex justify-between text-[10px]">
                        <span>-5% ì‹œ ì†ì‹¤</span> <span class="text-red-600 font-bold">-$1.8M</span>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- íƒ­ ì»¨í…ì¸ : ë¦¬ìŠ¤í¬ ë¶„ì„ (VaR ì˜í–¥ ë° ë¯¼ê°ë„ ë¶„ì„) -->
        <div id="tab-analysis" class="flex-1 overflow-hidden" style="display:none;">
            <div class="p-6 overflow-y-auto h-full space-y-6">
                
                <!-- VaR ì˜í–¥ ë° ë¯¼ê°ë„ ë¶„ì„ -->
                <div class="grid grid-cols-2 gap-6">
                    <div id="varImpactSection" class="bg-white p-5 rounded shadow-sm border">
                        <h4 class="text-sm font-bold text-gray-600 mb-4 italic">ğŸ¯ í—¤ì§€ í›„ VaR ì˜í–¥</h4>
                        <div class="flex items-center justify-between">
                            <div class="text-center w-1/2 border-r">
                                <p class="text-xs text-gray-400">í˜„ì¬ ìœ„í—˜</p>
                                <p id="currentVaR" class="text-xl font-bold text-red-500">0ì–µì›</p>
                            </div>
                            <div class="text-center w-1/2">
                                <p class="text-xs text-gray-400">ì˜ˆìƒ ìœ„í—˜ (í—¤ì§€ í›„)</p>
                                <p id="projectedVaR" class="text-xl font-bold text-green-600">0ì–µì›</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500">ìœ„í—˜ ê°ì†Œìœ¨</span>
                                <span id="varReduction" class="text-sm font-bold text-blue-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 h-2 rounded-full mt-2">
                                <div id="varReductionBar" class="bg-blue-500 h-full rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <p class="text-[10px] text-center text-gray-400 mt-4 italic">ì‹œìŠ¤í…œ ê³„ì‚° 95% ì‹ ë¢°êµ¬ê°„ ìœ„í—˜ ê°ì†Œ.</p>
                    </div>
                    
                    <div id="sensitivitySection" class="bg-white p-5 rounded shadow-sm border">
                        <h4 class="text-sm font-bold text-gray-600 mb-4 italic">ğŸ“Š ë¯¼ê°ë„ ë¶„ì„ (ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸)</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between text-xs">
                                <span>USD/KRW +5% ì‹œ</span>
                                <span id="sensitivityUp" class="text-green-600 font-bold">+0ì–µì› ì´ìµ</span>
                            </div>
                            <div class="w-full bg-gray-100 h-2 rounded-full">
                                <div id="sensitivityUpBar" class="bg-green-500 h-full rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span>USD/KRW -5% ì‹œ</span>
                                <span id="sensitivityDown" class="text-red-500 font-bold">-0ì–µì› ì†ì‹¤</span>
                            </div>
                            <div class="w-full bg-gray-100 h-2 rounded-full">
                                <div id="sensitivityDownBar" class="bg-red-400 h-full rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <p class="text-[10px] text-center text-gray-400 mt-4 italic">í™˜ìœ¨ ë³€ë™ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ ì†ìµ ë¶„ì„</p>
                    </div>
                </div>
                
                <!-- ì¶”ê°€ ë¶„ì„ ì•ˆë‚´ -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                    <div class="flex items-start gap-4">
                        <div class="text-4xl">ğŸ”¬</div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-700 mb-2">ê³ ê¸‰ ë¦¬ìŠ¤í¬ ë¶„ì„</h3>
                            <p class="text-sm text-gray-500 mb-3">í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ VaR ì˜í–¥ ë° ë¯¼ê°ë„ ë¶„ì„ ê²°ê³¼ê°€ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                            <div class="flex gap-2">
                                <span class="px-3 py-1 bg-white text-xs text-gray-600 rounded border">âœ… VaR ë¶„ì„</span>
                                <span class="px-3 py-1 bg-white text-xs text-gray-600 rounded border">âœ… ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸</span>
                                <span class="px-3 py-1 bg-white text-xs text-gray-600 rounded border">âœ… ë¯¼ê°ë„ ë¶„ì„</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        const api = typeof HedgeFreedomAPI !== 'undefined' ? new HedgeFreedomAPI() : { 
            loadToken: () => null 
        };
        
        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function showTab(tabName) {
            // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.getElementById('tab-overview').style.display = 'none';
            document.getElementById('tab-matrix').style.display = 'none';
            document.getElementById('tab-analysis').style.display = 'none';
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            document.getElementById('tab-' + tabName).style.display = 'flex';
            event.target.classList.add('active');
        }

        // Chart.js - í†µí™”ë³„ ë¦¬ìŠ¤í¬ ë¹„ì¤‘ ë„ë„› ì°¨íŠ¸
        const ctx = document.getElementById('riskChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['USD', 'EUR', 'JPY', 'ê¸°íƒ€'],
                datasets: [{
                    data: [65, 15, 15, 5],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#d1d5db'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                cutout: '65%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'right', 
                        labels: { 
                            boxWidth: 12, 
                            font: { size: 10 },
                            padding: 8
                        } 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });

        // ì¸ì¦ ì²´í¬ (ê²½ëŸ‰ í”Œë«í¼: ë¡œì»¬ ì „ìš©ì´ë¯€ë¡œ ì¸ì¦ ì„ íƒì )
        function checkAuthentication() {
            // â˜… ê²½ëŸ‰ í”Œë«í¼ ëª¨ë“œ: ì¸ì¦ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ â˜…
            const isLightweightMode = window.location.port === '7870' || 
                                       window.location.protocol === 'file:' ||
                                       localStorage.getItem('LIGHTWEIGHT_MODE') === 'true';
            
            if (isLightweightMode) {
                console.log('âœ… ê²½ëŸ‰ í”Œë«í¼ ëª¨ë“œ - ì¸ì¦ ìƒëµ');
                return true;
            }
            
            const authInfo = api.loadToken();
            
            if (!authInfo) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return false;
            }

            console.log('ì¸ì¦ í™•ì¸ ì™„ë£Œ:', authInfo.email);
            return true;
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        async function handleLogout(event) {
            if (event) event.preventDefault();
            
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await api.logout();
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    // ì—ëŸ¬ê°€ ë‚˜ë„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    localStorage.removeItem('hedgefreedom_auth');
                    sessionStorage.removeItem('hedgefreedom_auth');
                    window.location.href = 'login.html';
                }
            }
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // í—¤ì§€ë§¤ë‹ˆì € ë°ì´í„° ì—°ë™ (localStorage ê¸°ë°˜)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        // ë°ì´í„° í™•ì¸ ë° í‘œì‹œ
        function checkAndDisplayData() {
            // â˜… localStorageë§Œ ì‚¬ìš© (íƒ­ ê°„ ê³µìœ , ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ìœ ì§€) â˜…
            const uploadedData = localStorage.getItem('uploadedData');
            const serverResult = localStorage.getItem('serverAnalysisResult');
            const nettingResult = localStorage.getItem('nettingResult');
            
            if (uploadedData) {
                try {
                    const data = JSON.parse(uploadedData);
                    console.log('ğŸ“Š ë…¸ì¶œë¶„ì„: ì—…ë¡œë“œëœ ë°ì´í„° ë°œê²¬ -', data.length, 'ê±´');
                    
                    // ë°ì´í„° ìƒíƒœ ë°°ë„ˆ ìˆ¨ê¹€
                    document.getElementById('dataStatusBanner').classList.add('hidden');
                    
                    // ë°ì´í„° ì†ŒìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸
                    const timestamp = localStorage.getItem('uploadedDataTimestamp');
                    const timeStr = timestamp ? new Date(timestamp).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                    
                    // â˜… ì„œë²„ ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì„œë²„ ê²°ê³¼ í‘œì‹œ â˜…
                    if (serverResult) {
                        const result = JSON.parse(serverResult);
                        console.log('âœ… ì„œë²„ ë¶„ì„ ê²°ê³¼ ë°œê²¬:', result);
                        
                        document.getElementById('dataSourceInfo').textContent = `ì„œë²„ ë¶„ì„ ì™„ë£Œ: ${timeStr}`;
                        document.getElementById('dataSourceInfo').className = 'text-[9px] text-green-600 font-bold';
                        
                        // ì„œë²„ ê²°ê³¼ë¡œ ì „ì²´ í™”ë©´ ì—…ë°ì´íŠ¸
                        updateFromServerResult(result);
                        
                    } else if (nettingResult) {
                        // ë‚´ë¶€í—¤ì§€(ë„¤íŒ…) ê²°ê³¼ë§Œ ìˆëŠ” ê²½ìš°
                        const netting = JSON.parse(nettingResult);
                        console.log('ğŸ“Š ë‚´ë¶€í—¤ì§€ ê²°ê³¼ ë°œê²¬:', netting);
                        
                        document.getElementById('dataSourceInfo').textContent = `ë¡œì»¬ ë¶„ì„: ${timeStr} (${data.length}ê±´)`;
                        document.getElementById('dataSourceInfo').className = 'text-[9px] text-blue-500 font-bold';
                        
                        // ê¸°ë³¸ ë°ì´í„°ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸
                        updateExposureAnalysis(data);
                        
                        // ë‚´ë¶€í—¤ì§€ ê²°ê³¼ ë°˜ì˜
                        updateFromNettingResult(netting);
                        
                    } else {
                        // ì„œë²„ ë¶„ì„ ì „ - ëŒ€ê¸° ìƒíƒœ í‘œì‹œ
                        document.getElementById('dataSourceInfo').textContent = `ì—…ë¡œë“œ: ${timeStr} - ì„œë²„ ë¶„ì„ ëŒ€ê¸° ì¤‘`;
                        document.getElementById('dataSourceInfo').className = 'text-[9px] text-orange-500 font-bold';
                        
                        // ê¸°ë³¸ ë°ì´í„°ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸ (ì„ì‹œ)
                        updateExposureAnalysis(data);
                        
                        // ì„œë²„ ë¶„ì„ í•„ìš” ì•Œë¦¼
                        showServerAnalysisPending();
                    }
                    
                } catch (e) {
                    console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    resetToEmptyState();
                }
            } else {
                console.log('ğŸ“Š ë…¸ì¶œë¶„ì„: ì—…ë¡œë“œëœ ë°ì´í„° ì—†ìŒ');
                resetToEmptyState();
            }
        }
        
        // ì„œë²„ ë¶„ì„ ëŒ€ê¸° ì¤‘ ì•Œë¦¼
        function showServerAnalysisPending() {
            // KPIì— ëŒ€ê¸° ì¤‘ í‘œì‹œ
            document.getElementById('kpiVaR').textContent = 'ê³„ì‚° ëŒ€ê¸°';
            document.getElementById('kpiVaR').className = 'risk-value text-orange-500 italic';
            document.getElementById('kpiVaRChange').innerHTML = '<a href="#" onclick="window.location.href=\'hedge-manager.html\'; return false;" class="underline hover:text-blue-600">í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ "í—¤ì§€ ê³„ì‚° ì‹¤í–‰" í´ë¦­ â†’</a>';
            document.getElementById('kpiVaRChange').className = 'text-[9px] text-orange-400 mt-1';
            
            // ìˆœ ë…¸ì¶œì•¡ í‘œì‹œ (ê³„ì‚° ì „ì´ë¯€ë¡œ ëŒ€ê¸° ì¤‘)
            document.getElementById('kpiNetExposure').textContent = 'ê³„ì‚° ëŒ€ê¸°';
            document.getElementById('kpiNetExposure').className = 'risk-value text-orange-500 italic text-lg';
            
            // í—¤ì§€ ë¹„ìœ¨
            document.getElementById('kpiHedgeRatio').textContent = '- %';
            document.getElementById('kpiPolicyStatus').textContent = 'ë¶„ì„ ëŒ€ê¸°';
            document.getElementById('kpiPolicyStatus').className = 'risk-value text-orange-500 italic';
            document.getElementById('kpiPolicyMessage').textContent = 'ì„œë²„ ë¶„ì„ ì™„ë£Œ í›„ í‘œì‹œë©ë‹ˆë‹¤';
        }

        // ë¹ˆ ìƒíƒœë¡œ ì´ˆê¸°í™”
        function resetToEmptyState() {
            console.log('ğŸ”„ ë…¸ì¶œë¶„ì„ ì´ˆê¸°í™”');
            
            // ë°ì´í„° ìƒíƒœ ë°°ë„ˆ í‘œì‹œ
            document.getElementById('dataStatusBanner').classList.remove('hidden');
            
            // KPI ì´ˆê¸°í™”
            document.getElementById('kpiVaR').textContent = 'â‚© 0';
            document.getElementById('kpiVaRChange').textContent = 'ë°ì´í„° ì—†ìŒ';
            document.getElementById('kpiVaRChange').className = 'text-[9px] text-gray-400 mt-1';
            
            document.getElementById('kpiNetExposure').textContent = '$ 0';
            document.getElementById('kpiCurrencyInfo').textContent = 'ë°ì´í„° ì—†ìŒ';
            
            document.getElementById('kpiHedgeRatio').textContent = '0 %';
            document.getElementById('hedgeRatioBar').style.width = '0%';
            
            document.getElementById('kpiPolicyStatus').textContent = 'ë°ì´í„° ì—†ìŒ';
            document.getElementById('kpiPolicyStatus').className = 'risk-value text-gray-400 italic';
            document.getElementById('kpiPolicyMessage').textContent = 'ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”';
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            document.getElementById('exposureTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-gray-400">
                        <div class="text-3xl mb-2">ğŸ“Š</div>
                        <p>í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´</p>
                        <p class="text-xs mt-1">í†µí™”ë³„ í¬ì§€ì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </td>
                </tr>
            `;
            
            // ë°ì´í„° ì†ŒìŠ¤ ì •ë³´ ì´ˆê¸°í™”
            document.getElementById('dataSourceInfo').textContent = 'ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”';
            document.getElementById('dataSourceInfo').className = 'text-[9px] text-gray-400 italic';
            
            // ë¦¬ìŠ¤í¬ ë¶„ì„ íƒ­ ì´ˆê¸°í™” (VaR ì˜í–¥ / ë¯¼ê°ë„ ë¶„ì„)
            const currentVaREl = document.getElementById('currentVaR');
            const projectedVaREl = document.getElementById('projectedVaR');
            const varReductionEl = document.getElementById('varReduction');
            const varReductionBarEl = document.getElementById('varReductionBar');
            
            if (currentVaREl) currentVaREl.textContent = '0ì–µì›';
            if (projectedVaREl) projectedVaREl.textContent = '0ì–µì›';
            if (varReductionEl) varReductionEl.textContent = '0%';
            if (varReductionBarEl) varReductionBarEl.style.width = '0%';
            
            const sensitivityUpEl = document.getElementById('sensitivityUp');
            const sensitivityDownEl = document.getElementById('sensitivityDown');
            const sensitivityUpBarEl = document.getElementById('sensitivityUpBar');
            const sensitivityDownBarEl = document.getElementById('sensitivityDownBar');
            
            if (sensitivityUpEl) sensitivityUpEl.textContent = '+0ì–µì› ì´ìµ';
            if (sensitivityDownEl) sensitivityDownEl.textContent = '-0ì–µì› ì†ì‹¤';
            if (sensitivityUpBarEl) sensitivityUpBarEl.style.width = '0%';
            if (sensitivityDownBarEl) sensitivityDownBarEl.style.width = '0%';
        }

        // ë°ì´í„°ë¡œ ë…¸ì¶œë¶„ì„ ì—…ë°ì´íŠ¸
        function updateExposureAnalysis(data) {
            console.log('ğŸ“Š ë…¸ì¶œë¶„ì„ ì—…ë°ì´íŠ¸ ì‹œì‘:', data.length, 'ê±´');
            console.log('ğŸ“Š ë°ì´í„° ìƒ˜í”Œ:', data.slice(0, 3));
            
            const rates = {
                'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190,
                'GBP': 1750, 'AUD': 900, 'CAD': 1000, 'CHF': 1550
            };
            
            // í†µí™”ë³„ ì§‘ê³„
            const summary = {};
            let validCount = 0;
            
            data.forEach(item => {
                // ë°ì´í„° ê²€ì¦
                const currency = item.currency || 'USD';
                const amount = parseFloat(item.amount) || 0;
                const type = item.type || 'receivable';
                
                if (amount <= 0) return;
                validCount++;
                
                if (!summary[currency]) {
                    summary[currency] = { receivable: 0, payable: 0 };
                }
                if (type === 'receivable') {
                    summary[currency].receivable += amount;
                } else {
                    summary[currency].payable += amount;
                }
            });
            
            // KPI ê³„ì‚°
            let totalReceivableKRW = 0;
            let totalPayableKRW = 0;
            
            Object.entries(summary).forEach(([ccy, amounts]) => {
                const rate = rates[ccy] || 1350;
                totalReceivableKRW += amounts.receivable * rate;
                totalPayableKRW += amounts.payable * rate;
            });
            
            const netExposureKRW = Math.abs(totalReceivableKRW - totalPayableKRW);
            const netExposureUSD = netExposureKRW / 1350;
            
            // ë‚´ë¶€í—¤ì§€ìœ¨ ê³„ì‚°
            const internalHedge = Math.min(totalReceivableKRW, totalPayableKRW);
            const totalGross = totalReceivableKRW + totalPayableKRW;
            const hedgeRatio = totalGross > 0 ? (internalHedge / totalGross * 100).toFixed(1) : 0;
            
            // VaR ê³„ì‚° (95%, 1ì¼)
            const var95 = netExposureKRW * 0.015 * 1.645;
            
            // KPI ì—…ë°ì´íŠ¸
            document.getElementById('kpiVaR').textContent = 'â‚© ' + Math.round(var95).toLocaleString();
            document.getElementById('kpiVaRChange').textContent = '95% ì‹ ë¢°ìˆ˜ì¤€, 1ì¼ ê¸°ì¤€';
            document.getElementById('kpiVaRChange').className = 'text-[9px] text-gray-500 mt-1';
            
            document.getElementById('kpiNetExposure').textContent = '$ ' + Math.round(netExposureUSD).toLocaleString();
            document.getElementById('kpiCurrencyInfo').textContent = 'í†µí™”: ' + Object.keys(summary).join(', ');
            
            document.getElementById('kpiHedgeRatio').textContent = hedgeRatio + ' %';
            document.getElementById('hedgeRatioBar').style.width = hedgeRatio + '%';
            
            // ì •ì±… ì¤€ìˆ˜ ìƒíƒœ
            if (parseFloat(hedgeRatio) >= 70) {
                document.getElementById('kpiPolicyStatus').textContent = 'ì–‘í˜¸ (Good)';
                document.getElementById('kpiPolicyStatus').className = 'risk-value text-green-600 italic';
                document.getElementById('kpiPolicyMessage').textContent = 'ì •ì±… ëª©í‘œ ë‹¬ì„±';
            } else if (parseFloat(hedgeRatio) >= 50) {
                document.getElementById('kpiPolicyStatus').textContent = 'ì£¼ì˜ (Warning)';
                document.getElementById('kpiPolicyStatus').className = 'risk-value text-orange-500 italic';
                document.getElementById('kpiPolicyMessage').textContent = 'ìµœì†Œ í—¤ì§€ ëª©í‘œì¹˜(70%) ë¯¸ë‹¬';
            } else {
                document.getElementById('kpiPolicyStatus').textContent = 'ìœ„í—˜ (Danger)';
                document.getElementById('kpiPolicyStatus').className = 'risk-value text-red-600 italic';
                document.getElementById('kpiPolicyMessage').textContent = 'ê¸´ê¸‰ í—¤ì§€ ì¡°ì¹˜ í•„ìš”';
            }
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const tbody = document.getElementById('exposureTableBody');
            const rows = Object.entries(summary).map(([ccy, amounts]) => {
                const total = amounts.receivable + amounts.payable;
                const net = amounts.receivable - amounts.payable;
                const netting = Math.min(amounts.receivable, amounts.payable);
                const hedgeAmount = 0; // ì‹¤ì œ í—¤ì§€ì•¡ì€ ì„œë²„ì—ì„œ ê³„ì‚°
                
                let status, statusClass;
                const hedgePct = total > 0 ? (netting / total * 100) : 0;
                if (hedgePct >= 70) {
                    status = 'ì ì •';
                    statusClass = 'bg-green-100 text-green-600';
                } else if (hedgePct >= 50) {
                    status = 'ë¶€ì¡±';
                    statusClass = 'bg-yellow-100 text-yellow-600';
                } else {
                    status = 'ìœ„í—˜';
                    statusClass = 'bg-red-100 text-red-600';
                }
                
                return `
                    <tr>
                        <td class="font-bold">${ccy}/KRW</td>
                        <td class="text-right">${Math.round(total).toLocaleString()}</td>
                        <td class="text-right">(${Math.round(netting).toLocaleString()})</td>
                        <td class="text-right font-bold text-blue-700 bg-blue-50">${Math.round(Math.abs(net)).toLocaleString()}</td>
                        <td class="text-right">${hedgeAmount.toLocaleString()}</td>
                        <td><span class="px-2 py-0.5 ${statusClass} font-bold rounded text-[9px]">${status}</span></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows || `
                <tr>
                    <td colspan="6" class="text-center py-4 text-gray-400">ë°ì´í„° ì—†ìŒ</td>
                </tr>
            `;
            // ìƒì„¸ ë§¤íŠ¸ë¦­ìŠ¤ì—ë„ ë™ì¼ ë°ì´í„° ë°˜ì˜
            try { updateMatrixFromExposure(summary); } catch(e) { console.warn('ë§¤íŠ¸ë¦­ìŠ¤ ë°˜ì˜ ì‹¤íŒ¨:', e); }
            
            console.log('âœ… ë…¸ì¶œë¶„ì„ ì—…ë°ì´íŠ¸ ì™„ë£Œ - í†µí™”:', Object.keys(summary).join(', '));
        }

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ì„œë²„ ë¶„ì„ ê²°ê³¼ ë°˜ì˜ (í•µì‹¬ í•¨ìˆ˜)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        function updateFromServerResult(result) {
            console.log('ğŸ”„ ì„œë²„ ê²°ê³¼ë¡œ ì „ì²´ í™”ë©´ ì—…ë°ì´íŠ¸:', result);
            
            const rates = { 'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190 };
            
            // â˜… 1. KPI ì—…ë°ì´íŠ¸ â˜…
            // VaR (ì„œë²„ì—ì„œ ê³„ì‚°ëœ ê°’)
            if (result.risk?.var95) {
                document.getElementById('kpiVaR').textContent = 'â‚© ' + Math.round(result.risk.var95).toLocaleString();
                document.getElementById('kpiVaR').className = 'risk-value text-red-600';
                document.getElementById('kpiVaRChange').textContent = 'ì„œë²„ ê³„ì‚° (95% ì‹ ë¢°ìˆ˜ì¤€)';
                document.getElementById('kpiVaRChange').className = 'text-[9px] text-green-500 mt-1 font-bold';
            }
            
            // ìˆœ ë…¸ì¶œì•¡ (ì„œë²„ì—ì„œ ê³„ì‚°ëœ ê°’)
            if (result.exposure?.netExposure !== undefined) {
                document.getElementById('kpiNetExposure').textContent = '$ ' + Math.round(result.exposure.netExposure).toLocaleString();
                document.getElementById('kpiCurrencyInfo').textContent = result.exposure.currencies?.join(', ') || 'USD';
            }
            
            // í—¤ì§€ ë¹„ìœ¨ (ì„œë²„ì—ì„œ ê³„ì‚°ëœ ê°’)
            if (result.hedge?.currentRatio !== undefined) {
                const ratio = result.hedge.currentRatio;
                document.getElementById('kpiHedgeRatio').textContent = ratio.toFixed(1) + ' %';
                document.getElementById('hedgeRatioBar').style.width = ratio + '%';
                
                // ì •ì±… ì¤€ìˆ˜ ìƒíƒœ
                if (ratio >= 70) {
                    document.getElementById('kpiPolicyStatus').textContent = 'ì–‘í˜¸ (Good)';
                    document.getElementById('kpiPolicyStatus').className = 'risk-value text-green-600';
                    document.getElementById('kpiPolicyMessage').textContent = 'ì •ì±… ëª©í‘œ ë‹¬ì„±';
                } else if (ratio >= 50) {
                    document.getElementById('kpiPolicyStatus').textContent = 'ì£¼ì˜ (Warning)';
                    document.getElementById('kpiPolicyStatus').className = 'risk-value text-orange-500';
                    document.getElementById('kpiPolicyMessage').textContent = 'ìµœì†Œ í—¤ì§€ ëª©í‘œì¹˜(70%) ë¯¸ë‹¬';
                } else {
                    document.getElementById('kpiPolicyStatus').textContent = 'ìœ„í—˜ (Danger)';
                    document.getElementById('kpiPolicyStatus').className = 'risk-value text-red-600';
                    document.getElementById('kpiPolicyMessage').textContent = 'ê¸´ê¸‰ í—¤ì§€ ì¡°ì¹˜ í•„ìš”';
                }
            }
            
            // â˜… 2. í†µí™”ë³„ í¬ì§€ì…˜ í…Œì´ë¸” ì—…ë°ì´íŠ¸ â˜…
            if (result.exposure?.byCurrency) {
                updateExposureTableFromServer(result.exposure.byCurrency);
                // ìƒì„¸ ë§¤íŠ¸ë¦­ìŠ¤ì—ë„ ë°˜ì˜
                try { updateMatrixFromExposure(result.exposure.byCurrency); } catch(e){ console.warn('ë§¤íŠ¸ë¦­ìŠ¤ ë°˜ì˜ ì‹¤íŒ¨:', e); }
            }
            
            // â˜… 3. VaR ì˜í–¥ ì„¹ì…˜ ì—…ë°ì´íŠ¸ â˜…
            updateVaRImpactFromServer(result);
            
            // â˜… 4. ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸ â˜…
            updateSensitivityFromServer(result);
            
            console.log('âœ… ì„œë²„ ê²°ê³¼ ë°˜ì˜ ì™„ë£Œ');
        }
        
        // ì„œë²„ ê²°ê³¼ë¡œ í†µí™”ë³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateExposureTableFromServer(byCurrency) {
            const tbody = document.getElementById('exposureTableBody');
            
            const rows = Object.entries(byCurrency).map(([ccy, data]) => {
                const total = (data.receivable || 0) + (data.payable || 0);
                const net = (data.receivable || 0) - (data.payable || 0);
                const netting = data.nettedAmount || Math.min(data.receivable || 0, data.payable || 0);
                const hedgeAmount = data.hedgedAmount || 0;
                
                let status, statusClass;
                const hedgePct = total > 0 ? ((netting + hedgeAmount) / total * 100) : 0;
                if (hedgePct >= 70) {
                    status = 'ì ì •';
                    statusClass = 'bg-green-100 text-green-600';
                } else if (hedgePct >= 50) {
                    status = 'ë¶€ì¡±';
                    statusClass = 'bg-yellow-100 text-yellow-600';
                } else {
                    status = 'ìœ„í—˜';
                    statusClass = 'bg-red-100 text-red-600';
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="font-bold">${ccy}/KRW</td>
                        <td class="text-right">${Math.round(total).toLocaleString()}</td>
                        <td class="text-right text-green-600">(${Math.round(netting).toLocaleString()})</td>
                        <td class="text-right font-bold text-blue-700 bg-blue-50">${Math.round(Math.abs(net)).toLocaleString()}</td>
                        <td class="text-right">${Math.round(hedgeAmount).toLocaleString()}</td>
                        <td><span class="px-2 py-0.5 ${statusClass} font-bold rounded text-[9px]">${status}</span></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows || `<tr><td colspan="6" class="text-center py-4 text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>`;
        }

        // ìƒì„¸ ë§¤íŠ¸ë¦­ìŠ¤(ë²•ì¸/í†µí™”/ë§Œê¸°) ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateMatrixFromExposure(byCurrency) {
            try {
                const tbody = document.getElementById('matrixTableBody');
                if (!tbody) return;

                const entries = Object.entries(byCurrency || {});
                if (entries.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>`;
                    return;
                }

                // Build rows grouped by currency. If server provides corporate grouping, extend accordingly.
                const rows = [];
                let totals = { gross: 0, hedged: 0, net: 0, inflowNow: 0, outflowNow: 0, inflow30: 0, outflow30: 0 };

                entries.forEach(([ccy, data]) => {
                    const receivable = Number(data.receivable || 0);
                    const payable = Number(data.payable || 0);
                    const hedged = Number(data.hedgedAmount || data.hedged || 0);
                    const net = receivable - payable;

                    // Maturity buckets may be provided by server
                    const inflowNow = Number(data.maturityNow?.inflow || data.now?.inflow || 0);
                    const outflowNow = Number(data.maturityNow?.outflow || data.now?.outflow || 0);
                    const inflow30 = Number(data.next30?.inflow || 0);
                    const outflow30 = Number(data.next30?.outflow || 0);

                    rows.push(`
                        <tr>
                            <td class="pl-6 text-left font-bold border-r">ã„´ ${ccy}/KRW</td>
                            <td class="val-long">${Math.round(receivable).toLocaleString()}</td>
                            <td>${Math.round(hedged).toLocaleString()}</td>
                            <td class="val-net ${net>=0 ? 'text-blue-600' : 'text-red-600'}">${Math.abs(Math.round(net)).toLocaleString()}</td>
                            <td class="val-long">${Math.round(inflowNow).toLocaleString()}</td>
                            <td class="val-short">(${Math.round(outflowNow).toLocaleString()})</td>
                            <td class="val-long">${Math.round(inflow30).toLocaleString()}</td>
                            <td class="val-short">(${Math.round(outflow30).toLocaleString()})</td>
                        </tr>
                    `);

                    totals.gross += (receivable + payable);
                    totals.hedged += hedged;
                    totals.net += net;
                    totals.inflowNow += inflowNow;
                    totals.outflowNow += outflowNow;
                    totals.inflow30 += inflow30;
                    totals.outflow30 += outflow30;
                });

                const totalRow = `
                    <tr class="row-total">
                        <td class="text-left font-bold p-3">ì´ê³„ (í†µí™” í•©ê³„)</td>
                        <td>${Math.round(totals.gross).toLocaleString()}</td>
                        <td>${Math.round(totals.hedged).toLocaleString()}</td>
                        <td class="bg-yellow-100 font-bold text-red-600">${Math.abs(Math.round(totals.net)).toLocaleString()}</td>
                        <td>${Math.round(totals.inflowNow).toLocaleString()}</td>
                        <td>(${Math.round(totals.outflowNow).toLocaleString()})</td>
                        <td>${Math.round(totals.inflow30).toLocaleString()}</td>
                        <td>(${Math.round(totals.outflow30).toLocaleString()})</td>
                    </tr>
                `;

                tbody.innerHTML = totalRow + rows.join('');

                // KPI ë¦¬ë³¸ ì—…ë°ì´íŠ¸ (ì´ ë…¸ì¶œ, ìˆœ ë¯¸í—¤ì§€, í—¤ì§€ ê¸ˆì•¡)
                try {
                    const totalExpEl = document.getElementById('matrixTotalExposure');
                    const unhedgedEl = document.getElementById('matrixUnhedgedExposure');
                    const hedgedEl = document.getElementById('matrixHedgedAmount');

                    if (totalExpEl) totalExpEl.textContent = Math.round(totals.gross).toLocaleString();
                    if (unhedgedEl) unhedgedEl.textContent = Math.abs(Math.round(totals.net)).toLocaleString();
                    if (hedgedEl) hedgedEl.textContent = Math.round(totals.hedged).toLocaleString();
                } catch (e) { console.warn('KPI ë¦¬ë³¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e); }
            } catch (e) {
                console.error('updateMatrixFromExposure ì˜¤ë¥˜:', e);
            }
        }
        
        // ì„œë²„ ê²°ê³¼ë¡œ VaR ì˜í–¥ ì—…ë°ì´íŠ¸
        function updateVaRImpactFromServer(result) {
            const toEokWon = (val) => (val / 100000000).toFixed(1);
            
            const currentVaR = result.risk?.var95 || 0;
            const projectedVaR = result.risk?.projectedVar || currentVaR * 0.3;
            const reduction = currentVaR > 0 ? Math.round((1 - projectedVaR / currentVaR) * 100) : 0;
            
            const currentVaREl = document.getElementById('currentVaR');
            const projectedVaREl = document.getElementById('projectedVaR');
            const varReductionEl = document.getElementById('varReduction');
            const varReductionBarEl = document.getElementById('varReductionBar');
            
            if (currentVaREl) currentVaREl.textContent = toEokWon(currentVaR) + 'ì–µì›';
            if (projectedVaREl) projectedVaREl.textContent = toEokWon(projectedVaR) + 'ì–µì›';
            if (varReductionEl) varReductionEl.textContent = reduction + '%';
            if (varReductionBarEl) varReductionBarEl.style.width = Math.min(reduction, 100) + '%';
        }
        
        // ì„œë²„ ê²°ê³¼ë¡œ ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateSensitivityFromServer(result) {
            const toEokWon = (val) => Math.abs(val / 100000000).toFixed(1);
            
            const upside = result.sensitivity?.upside || 0;
            const downside = result.sensitivity?.downside || 0;
            
            const sensitivityUpEl = document.getElementById('sensitivityUp');
            const sensitivityDownEl = document.getElementById('sensitivityDown');
            const sensitivityUpBarEl = document.getElementById('sensitivityUpBar');
            const sensitivityDownBarEl = document.getElementById('sensitivityDownBar');
            
            if (sensitivityUpEl) sensitivityUpEl.textContent = '+' + toEokWon(upside) + 'ì–µì› ì´ìµ';
            if (sensitivityDownEl) sensitivityDownEl.textContent = '-' + toEokWon(downside) + 'ì–µì› ì†ì‹¤';
            
            // ë°” ë„ˆë¹„ (ìµœëŒ€ 100ì–µì› ê¸°ì¤€)
            const maxBar = 10000000000;
            if (sensitivityUpBarEl) sensitivityUpBarEl.style.width = Math.min(Math.abs(upside) / maxBar * 100, 100) + '%';
            if (sensitivityDownBarEl) sensitivityDownBarEl.style.width = Math.min(Math.abs(downside) / maxBar * 100, 100) + '%';
        }
        
        // ë‚´ë¶€í—¤ì§€(ë„¤íŒ…) ê²°ê³¼ ë°˜ì˜
        function updateFromNettingResult(netting) {
            console.log('ğŸ“Š ë‚´ë¶€í—¤ì§€ ê²°ê³¼ ë°˜ì˜:', netting);
            
            const rates = { 'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190 };
            
            // ë„¤íŒ… ê¸ˆì•¡ (KRW í™˜ì‚°)
            const nettedAmountKRW = (netting.totalNettedAmount || 0) * (rates[netting.currency] || 1350);
            const nettedEokWon = (nettedAmountKRW / 100000000).toFixed(1);
            
            // ì”ì—¬ ë…¸ì¶œ
            const remainingCount = netting.remainingExposure?.length || 0;
            
            // ë§¤ì¹­ ìŒ ìˆ˜
            const pairCount = netting.nettedPairs?.length || 0;
            
            // í†µí™”ë³„ ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            if (netting.byCurrency) {
                updateExposureTableWithNetting(netting.byCurrency);
            }
            
            // KPI ì—…ë°ì´íŠ¸ - ë‚´ë¶€í—¤ì§€ ì •ë³´ ì¶”ê°€
            const hedgeRatioEl = document.getElementById('kpiHedgeRatio');
            if (hedgeRatioEl && pairCount > 0) {
                // ë‚´ë¶€í—¤ì§€ë¡œ ì¸í•œ í—¤ì§€ë¹„ìœ¨ ì¦ê°€ ê³„ì‚°
                const currentRatio = parseFloat(hedgeRatioEl.textContent) || 0;
                const boostedRatio = Math.min(currentRatio + (pairCount * 2), 100);
                hedgeRatioEl.textContent = boostedRatio.toFixed(1) + ' %';
                document.getElementById('hedgeRatioBar').style.width = boostedRatio + '%';
            }
            
            // VaR ì˜í–¥ ê³„ì‚° (ë‚´ë¶€í—¤ì§€ë¡œ ë¦¬ìŠ¤í¬ ê°ì†Œ)
            const uploadedData = localStorage.getItem('uploadedData');
            if (uploadedData) {
                const data = JSON.parse(uploadedData);
                const totalCount = data.length;
                const hedgeEfficiency = totalCount > 0 ? (pairCount * 2 / totalCount) : 0;
                
                // VaR ê°ì†Œ íš¨ê³¼ ë°˜ì˜
                updateVaRWithNetting(netting, hedgeEfficiency);
            }
        }
        
        // ë‚´ë¶€í—¤ì§€ ê²°ê³¼ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateExposureTableWithNetting(byCurrency) {
            const tbody = document.getElementById('exposureTableBody');
            if (!byCurrency || Object.keys(byCurrency).length === 0) return;
            
            const rows = Object.entries(byCurrency).map(([ccy, data]) => {
                const total = data.totalReceivable + data.totalPayable;
                const net = data.totalReceivable - data.totalPayable;
                const netting = data.nettedAmount || Math.min(data.totalReceivable, data.totalPayable);
                const remaining = data.remainingExposure || Math.abs(net);
                
                let status, statusClass;
                const hedgePct = total > 0 ? (netting / total * 100) : 0;
                if (hedgePct >= 70) {
                    status = 'ì ì •';
                    statusClass = 'bg-green-100 text-green-600';
                } else if (hedgePct >= 50) {
                    status = 'ë¶€ì¡±';
                    statusClass = 'bg-yellow-100 text-yellow-600';
                } else {
                    status = 'ìœ„í—˜';
                    statusClass = 'bg-red-100 text-red-600';
                }
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="font-bold">${ccy}/KRW</td>
                        <td class="text-right">${Math.round(total).toLocaleString()}</td>
                        <td class="text-right text-green-600">(${Math.round(netting).toLocaleString()})</td>
                        <td class="text-right font-bold text-blue-700 bg-blue-50">${Math.round(remaining).toLocaleString()}</td>
                        <td class="text-right text-gray-400">-</td>
                        <td><span class="px-2 py-0.5 ${statusClass} font-bold rounded text-[9px]">${status}</span></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
        
        // ë‚´ë¶€í—¤ì§€ë¡œ VaR ì—…ë°ì´íŠ¸
        function updateVaRWithNetting(netting, hedgeEfficiency) {
            const rates = { 'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190 };
            
            // ì´ ë…¸ì¶œì•¡ (KRW)
            const totalExposureKRW = (netting.totalReceivable + netting.totalPayable) * (rates['USD'] || 1350);
            
            // í˜„ì¬ VaR (95%, 1ì¼)
            const currentVaR = totalExposureKRW * 0.015 * 1.645;
            
            // ë‚´ë¶€í—¤ì§€ í›„ VaR (ìƒê³„ëœ ê¸ˆì•¡ë§Œí¼ ê°ì†Œ)
            const nettedAmountKRW = netting.totalNettedAmount * (rates['USD'] || 1350);
            const remainingExposureKRW = totalExposureKRW - nettedAmountKRW * 2;
            const projectedVaR = Math.max(0, remainingExposureKRW * 0.015 * 1.645);
            
            // ê°ì†Œìœ¨
            const reduction = currentVaR > 0 ? Math.round((1 - projectedVaR / currentVaR) * 100) : 0;
            
            // ì–µì› ë‹¨ìœ„ ë³€í™˜
            const toEokWon = (krw) => (krw / 100000000).toFixed(1);
            
            // VaR ì˜í–¥ ì„¹ì…˜ ì—…ë°ì´íŠ¸
            const currentVaREl = document.getElementById('currentVaR');
            const projectedVaREl = document.getElementById('projectedVaR');
            const varReductionEl = document.getElementById('varReduction');
            const varReductionBarEl = document.getElementById('varReductionBar');
            
            if (currentVaREl) currentVaREl.textContent = toEokWon(currentVaR) + 'ì–µì›';
            if (projectedVaREl) projectedVaREl.textContent = toEokWon(projectedVaR) + 'ì–µì›';
            if (varReductionEl) varReductionEl.textContent = reduction + '%';
            if (varReductionBarEl) varReductionBarEl.style.width = Math.min(reduction, 100) + '%';
            
            // KPI VaR ì—…ë°ì´íŠ¸
            document.getElementById('kpiVaR').textContent = 'â‚© ' + Math.round(currentVaR).toLocaleString();
            document.getElementById('kpiVaRChange').textContent = `ë‚´ë¶€í—¤ì§€ í›„ ${reduction}% ê°ì†Œ ì˜ˆìƒ`;
            document.getElementById('kpiVaRChange').className = 'text-[9px] text-green-500 mt-1 font-bold';
            
            // ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸
            updateSensitivityWithNetting(netting, remainingExposureKRW);
        }
        
        // ë‚´ë¶€í—¤ì§€ë¡œ ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateSensitivityWithNetting(netting, remainingExposureKRW) {
            // í™˜ìœ¨ 5% ë³€ë™ ì‹œ ì†ìµ ê³„ì‚°
            const upside = remainingExposureKRW * 0.05;
            const nettedRatio = netting.totalNettedAmount * 2 / (netting.totalReceivable + netting.totalPayable);
            const downside = remainingExposureKRW * 0.05 * (1 - nettedRatio);
            
            // ì–µì› ë‹¨ìœ„ ë³€í™˜
            const toEokWon = (krw) => Math.abs(krw / 100000000).toFixed(1);
            
            const sensitivityUpEl = document.getElementById('sensitivityUp');
            const sensitivityDownEl = document.getElementById('sensitivityDown');
            const sensitivityUpBarEl = document.getElementById('sensitivityUpBar');
            const sensitivityDownBarEl = document.getElementById('sensitivityDownBar');
            
            if (sensitivityUpEl) {
                sensitivityUpEl.textContent = '+' + toEokWon(upside) + 'ì–µì› ì´ìµ';
            }
            if (sensitivityDownEl) {
                sensitivityDownEl.textContent = '-' + toEokWon(downside) + 'ì–µì› ì†ì‹¤ (ë‚´ë¶€í—¤ì§€ë¡œ ì œí•œ)';
            }
            
            // ë°” ë„ˆë¹„ ê³„ì‚° (ìµœëŒ€ 100ì–µì› ê¸°ì¤€)
            const maxBar = 10000000000;
            if (sensitivityUpBarEl) sensitivityUpBarEl.style.width = Math.min(Math.abs(upside) / maxBar * 100, 100) + '%';
            if (sensitivityDownBarEl) sensitivityDownBarEl.style.width = Math.min(Math.abs(downside) / maxBar * 100, 100) + '%';
        }
        
        // VaR ì˜í–¥ ì—…ë°ì´íŠ¸
        function updateVaRImpact(result) {
            const currentVaR = result.risk?.var95 || 0;
            const hedgeRatio = result.kpi?.currentHedgeRatio || 0;
            
            // ì˜ˆìƒ VaR = í˜„ì¬ VaR Ã— (1 - í—¤ì§€ë¹„ìœ¨/100 Ã— 0.7)
            const projectedVaR = currentVaR * (1 - (hedgeRatio / 100) * 0.7);
            const reduction = currentVaR > 0 ? Math.round((1 - projectedVaR / currentVaR) * 100) : 0;
            
            // ì–µì› ë‹¨ìœ„ ë³€í™˜
            const toEokWon = (krw) => (krw / 100000000).toFixed(1);
            
            const currentVaREl = document.getElementById('currentVaR');
            const projectedVaREl = document.getElementById('projectedVaR');
            const varReductionEl = document.getElementById('varReduction');
            const varReductionBarEl = document.getElementById('varReductionBar');
            
            if (currentVaREl) currentVaREl.textContent = toEokWon(currentVaR) + 'ì–µì›';
            if (projectedVaREl) projectedVaREl.textContent = toEokWon(projectedVaR) + 'ì–µì›';
            if (varReductionEl) varReductionEl.textContent = reduction + '%';
            if (varReductionBarEl) varReductionBarEl.style.width = Math.min(reduction, 100) + '%';
        }
        
        // ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateSensitivityAnalysis(result) {
            const netExposure = result.kpi?.netExposure || 0;
            const hedgeRatio = result.kpi?.currentHedgeRatio || 0;
            
            // í™˜ìœ¨ 5% ë³€ë™ ì‹œ ì†ìµ ê³„ì‚°
            const exchangeRate = 1350;
            const netExposureKRW = netExposure * exchangeRate;
            const unhedgedRatio = (100 - hedgeRatio) / 100;
            
            // ìƒìŠ¹ ì‹œ ì´ìµ (USD ë³´ìœ  ì‹œ)
            const upside = netExposureKRW * 0.05;
            // í•˜ë½ ì‹œ ì†ì‹¤ (í—¤ì§€ë¡œ ì œí•œ)
            const downside = netExposureKRW * 0.05 * unhedgedRatio;
            
            // ì–µì› ë‹¨ìœ„ ë³€í™˜
            const toEokWon = (krw) => Math.abs(krw / 100000000).toFixed(1);
            
            const sensitivityUpEl = document.getElementById('sensitivityUp');
            const sensitivityDownEl = document.getElementById('sensitivityDown');
            const sensitivityUpBarEl = document.getElementById('sensitivityUpBar');
            const sensitivityDownBarEl = document.getElementById('sensitivityDownBar');
            
            if (sensitivityUpEl) {
                sensitivityUpEl.textContent = '+' + toEokWon(upside) + 'ì–µì› ì´ìµ';
            }
            if (sensitivityDownEl) {
                sensitivityDownEl.textContent = '-' + toEokWon(downside) + 'ì–µì› ì†ì‹¤' + (hedgeRatio > 0 ? ' (í—¤ì§€ë¡œ ì œí•œ)' : '');
            }
            
            // ë°” ë„ˆë¹„ ê³„ì‚° (ìµœëŒ€ 100ì–µì› ê¸°ì¤€)
            const maxBar = 10000000000; // 100ì–µì›
            if (sensitivityUpBarEl) sensitivityUpBarEl.style.width = Math.min(Math.abs(upside) / maxBar * 100, 100) + '%';
            if (sensitivityDownBarEl) sensitivityDownBarEl.style.width = Math.min(Math.abs(downside) / maxBar * 100, 100) + '%';
        }

        // ë‹¤ë¥¸ íƒ­ì—ì„œ storage ë³€ê²½ ê°ì§€ (localStorage ì´ë²¤íŠ¸)
        window.addEventListener('storage', (event) => {
            // í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ë°ì´í„° ì‚­ì œ ì‹ í˜¸ ê°ì§€
            if (event.key === 'dataClearSignal') {
                console.log('ğŸ“¢ ë…¸ì¶œë¶„ì„: í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ë°ì´í„° ì‚­ì œ ì‹ í˜¸ ìˆ˜ì‹ !');
                resetToEmptyState();
                resetCalculatorCards();
                
                // ì•Œë¦¼ í‘œì‹œ
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-orange-100 border-l-4 border-orange-500 text-orange-800 p-4 rounded shadow-lg z-50';
                notification.innerHTML = '<strong>ğŸ“¢ ë°ì´í„° ì´ˆê¸°í™”ë¨</strong><br><span class="text-sm">í—¤ì§€ë§¤ë‹ˆì €ì—ì„œ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</span>';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
            
            // ìƒˆ ë°ì´í„° ì—…ë¡œë“œ ì‹ í˜¸ ê°ì§€
            if (event.key === 'dataUploadSignal') {
                console.log('ğŸ“¢ ë…¸ì¶œë¶„ì„: ìƒˆ ë°ì´í„° ì—…ë¡œë“œ ì‹ í˜¸ ìˆ˜ì‹ !');
                checkAndDisplayData();
            }
        });

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ğŸ“Š ì„œë²„ ê³„ì‚°ê¸° ì—°ë™ í•¨ìˆ˜ë“¤
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        // ì„œë²„ URL ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’: í˜„ì¬ origin ë˜ëŠ” localhost:7870)
        function getServerUrl() {
            // ìš°ì„ ìˆœìœ„: ì„¤ì •ê°’ > í˜„ì¬ origin > ê¸°ë³¸ê°’
            if (window.HedgeFreedomConfig?.CALCULATOR_SERVER) {
                return window.HedgeFreedomConfig.CALCULATOR_SERVER;
            }
            // í˜„ì¬ originì´ localhost:7870ì´ë©´ ë¹ˆ ë¬¸ìì—´ (ìƒëŒ€ê²½ë¡œ ì‚¬ìš©)
            if (window.location.origin.includes('localhost:7870')) {
                return '';
            }
            // ê·¸ ì™¸ì˜ ê²½ìš° (file:// ë“±) ê¸°ë³¸ ì„œë²„ ì£¼ì†Œ ì‚¬ìš©
            if (window.location.protocol === 'file:') {
                return 'http://localhost:7870';
            }
            return '';
        }
        
        // ì „ì²´ ê³„ì‚°ê¸° ì‹¤í–‰
        async function runAllCalculators() {
            const uploadedData = localStorage.getItem('uploadedData');
            if (!uploadedData) {
                console.warn('ğŸ“Š ê³„ì‚°ê¸° ì‹¤í–‰ ì¤‘ë‹¨: ì—…ë¡œë“œëœ ë°ì´í„° ì—†ìŒ');
                updateCalculatorStatus('ë°ì´í„° ì—†ìŒ', 'gray');
                return;
            }
            
            const data = JSON.parse(uploadedData);
            const btn = document.getElementById('runCalculatorsBtn');
            
            btn.disabled = true;
            btn.textContent = 'â³ ê³„ì‚° ì¤‘...';
            updateCalculatorStatus('ì„œë²„ ì—°ê²° ì¤‘...', 'yellow');
            
            console.log('ğŸ“Š ì „ì²´ ê³„ì‚°ê¸° ì‹¤í–‰ ì‹œì‘...');
            console.log('ğŸ“Š ì„œë²„ URL:', getServerUrl() || '(í˜„ì¬ origin)');
            
            // ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
            try {
                const serverUrl = getServerUrl();
                const healthUrl = `${serverUrl}/api/health`;
                console.log('ğŸ“Š í—¬ìŠ¤ ì²´í¬:', healthUrl);
                
                const healthResponse = await fetch(healthUrl, { 
                    method: 'GET',
                    timeout: 3000 
                });
                
                if (!healthResponse.ok) {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì—†ìŒ');
                }
                
                const healthData = await healthResponse.json();
                console.log('âœ… ì„œë²„ ì—°ê²° í™•ì¸:', healthData);
                
            } catch (healthError) {
                console.error('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', healthError);
                updateCalculatorStatus('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (7870 í¬íŠ¸ í™•ì¸)', 'red');
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ ì „ì²´ ê³„ì‚° ì‹¤í–‰';
                return;
            }
            
            // ë°ì´í„° ì¤€ë¹„
            const exposureData = prepareExposureData(data);
            console.log('ğŸ“Š ì¤€ë¹„ëœ ë°ì´í„°:', exposureData);
            
            try {
                // ë³‘ë ¬ë¡œ ëª¨ë“  ê³„ì‚°ê¸° í˜¸ì¶œ
                const results = await Promise.allSettled([
                    callCalculator('01', { exposure: exposureData, options: { riskTolerance: 'moderate' } }),
                    callCalculator('02', { exposure: exposureData, options: { hedgeRatio: 0.75 } }),
                    callCalculator('03', { exposure: exposureData, options: { scenario: 'base' } }),
                    callCalculator('04', { exposure: exposureData }),
                    callCalculator('05', { planA: { instrument: 'forward', ...exposureData } }),
                    callCalculator('06', { exposure: exposureData }),
                    callCalculator('07', { exposure: { exposureKRW: exposureData.amountKRW, hedgeRatio: 0 } }),
                    callCalculator('08', { exposure: exposureData }),
                    callCalculator('09', { hedgeData: { hedgeItemChange: -100000, hedgingInstrumentChange: 95000 } })
                ]);
                
                // ê²°ê³¼ ì²˜ë¦¬ ë° ì„±ê³µ/ì‹¤íŒ¨ ì¹´ìš´íŠ¸
                let successCount = 0;
                let failCount = 0;
                
                results.forEach((result, index) => {
                    const calcNum = String(index + 1).padStart(2, '0');
                    if (result.status === 'fulfilled' && result.value?.success) {
                        updateCalculatorCard(calcNum, result.value.data);
                        successCount++;
                        console.log(`âœ… ê³„ì‚°ê¸° ${calcNum} ì„±ê³µ:`, result.value.data);
                    } else {
                        failCount++;
                        console.warn(`âŒ ê³„ì‚°ê¸° ${calcNum} ì‹¤íŒ¨:`, result.reason || result.value?.error);
                    }
                });
                
                const timeStr = new Date().toLocaleTimeString('ko-KR');
                if (failCount === 0) {
                    updateCalculatorStatus(`âœ… ì „ì²´ ì™„ë£Œ (${successCount}/9) ${timeStr}`, 'green');
                } else {
                    updateCalculatorStatus(`âš ï¸ ${successCount}/9 ì™„ë£Œ, ${failCount}ê°œ ì‹¤íŒ¨ ${timeStr}`, 'yellow');
                }
                
            } catch (error) {
                console.error('ê³„ì‚°ê¸° ì‹¤í–‰ ì˜¤ë¥˜:', error);
                updateCalculatorStatus('âŒ ê³„ì‚° ì˜¤ë¥˜: ' + error.message, 'red');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ ì „ì²´ ê³„ì‚° ì‹¤í–‰';
            }
        }
        
        // ê°œë³„ ê³„ì‚°ê¸° í˜¸ì¶œ
        async function callCalculator(calcNum, requestData) {
            const serverUrl = getServerUrl();
            const url = `${serverUrl}/api/calculator/${calcNum}`;
            
            console.log(`ğŸ“Š ê³„ì‚°ê¸° ${calcNum} í˜¸ì¶œ:`, url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return await response.json();
        }
        
        // ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ ê³„ì‚°ê¸°ìš©ìœ¼ë¡œ ë³€í™˜
        function prepareExposureData(data) {
            const rates = { 'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190 };
            
            let totalReceivable = 0;
            let totalPayable = 0;
            let dominantCurrency = 'USD';
            let currencyCount = {};
            
            data.forEach(item => {
                const ccy = item.currency || 'USD';
                const amount = parseFloat(item.amount) || 0;
                
                currencyCount[ccy] = (currencyCount[ccy] || 0) + amount;
                
                if (item.type === 'receivable') {
                    totalReceivable += amount;
                } else {
                    totalPayable += amount;
                }
            });
            
            // ê°€ì¥ í° í†µí™” ì°¾ê¸°
            dominantCurrency = Object.entries(currencyCount)
                .sort((a, b) => b[1] - a[1])[0]?.[0] || 'USD';
            
            const rate = rates[dominantCurrency] || 1350;
            const netAmount = Math.abs(totalReceivable - totalPayable);
            
            return {
                currency: dominantCurrency,
                amount: netAmount,
                rate: rate,
                amountKRW: netAmount * rate,
                direction: totalReceivable > totalPayable ? 'receivable' : 'payable',
                daysToMaturity: 90,
                totalReceivable,
                totalPayable
            };
        }
        
        // ê³„ì‚°ê¸° ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateCalculatorCard(calcNum, data) {
            const toEokWon = (val) => (val / 100000000).toFixed(1);
            
            switch(calcNum) {
                case '01': // ìµœì  í—¤ì§€ ë¹„ìœ¨
                    document.getElementById('calc01Value').textContent = (data.optimalHedgeRatio || 0) + '%';
                    document.getElementById('calc01Detail').textContent = data.recommendation || 'ë¶„ì„ ì™„ë£Œ';
                    break;
                    
                case '02': // í—¤ì§€ ë„êµ¬ ì¶”ì²œ
                    const bestChoice = data.bestChoice?.instrument || data.recommendations?.[0]?.instrument || '--';
                    document.getElementById('calc02Value').textContent = bestChoice.split('(')[0].trim();
                    document.getElementById('calc02Detail').textContent = `${data.recommendations?.length || 0}ê°œ ë„êµ¬ ë¹„êµ ì™„ë£Œ`;
                    break;
                    
                case '03': // ê²°ì œì¼ í™˜ìœ¨ ì˜ˆì¸¡
                    document.getElementById('calc03Value').textContent = Math.round(data.forecastRate || 0).toLocaleString() + 'ì›';
                    document.getElementById('calc03Detail').textContent = `ë³€ë™: ${data.expectedChangePct || 0}% (${data.scenario || 'base'})`;
                    break;
                    
                case '04': // ì†ìµ ê³„ì‚°
                    const currentPnL = data.scenarios?.current?.totalPnL || 0;
                    document.getElementById('calc04Value').textContent = toEokWon(currentPnL) + 'ì–µì›';
                    document.getElementById('calc04Detail').textContent = `ìµœì•…: ${toEokWon(data.scenarios?.down10?.totalPnL || 0)}ì–µ`;
                    break;
                    
                case '05': // í—¤ì§€ ë¹„ìš©
                    const cost = data.planA?.cost || 0;
                    document.getElementById('calc05Value').textContent = Math.round(cost).toLocaleString() + 'ì›';
                    document.getElementById('calc05Detail').textContent = `ë¹„ìš©ë¥ : ${data.planA?.costPct || '0%'}`;
                    break;
                    
                case '06': // ì‹œê°„ê°€ì¹˜ ê°ì‡ 
                    document.getElementById('calc06Value').textContent = Math.round(data.dailyDecay || 0).toLocaleString() + 'ì›/ì¼';
                    document.getElementById('calc06Detail').textContent = data.accelerationNote || 'ê°ì‡  ê³„ì‚° ì™„ë£Œ';
                    break;
                    
                case '07': // VaR ê³„ì‚°
                    document.getElementById('calc07Value').textContent = (data.var1DEokWon || 0) + 'ì–µì›';
                    document.getElementById('calc07Detail').textContent = `ES: ${data.expectedShortfallEokWon || 0}ì–µ (95%)`;
                    break;
                    
                case '08': // ë¯¼ê°ë„ ë¶„ì„
                    const per1pct = data.summary?.per1pctMove || 0;
                    document.getElementById('calc08Value').textContent = 'Â±' + toEokWon(per1pct) + 'ì–µ';
                    document.getElementById('calc08Detail').textContent = `1% ë³€ë™ ì‹œ ì†ìµ`;
                    break;
                    
                case '09': // í—¤ì§€ íš¨ê³¼ì„±
                    document.getElementById('calc09Value').textContent = data.dollarOffsetRatio || '--%';
                    document.getElementById('calc09Detail').textContent = data.isEffective ? 'âœ“ íš¨ê³¼ì ' : 'âš ï¸ ë¹„íš¨ê³¼ì ';
                    document.getElementById('calc09Detail').className = data.isEffective 
                        ? 'text-[9px] text-green-600 font-bold mt-1' 
                        : 'text-[9px] text-red-600 font-bold mt-1';
                    break;
            }
        }
        
        // ê³„ì‚°ê¸° ì¹´ë“œ ì´ˆê¸°í™”
        function resetCalculatorCards() {
            for (let i = 1; i <= 9; i++) {
                const num = String(i).padStart(2, '0');
                const valueEl = document.getElementById(`calc${num}Value`);
                const detailEl = document.getElementById(`calc${num}Detail`);
                if (valueEl) valueEl.textContent = '--';
                if (detailEl) {
                    detailEl.textContent = 'ë°ì´í„° ëŒ€ê¸° ì¤‘';
                    detailEl.className = 'text-[9px] text-gray-500 mt-1';
                }
            }
            updateCalculatorStatus('ì„œë²„ ì—°ê²° ëŒ€ê¸°', 'gray');
        }
        
        // ê³„ì‚°ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸ í—¬í¼
        function updateCalculatorStatus(message, color = 'gray') {
            const statusEl = document.getElementById('calculatorServerStatus');
            if (statusEl) {
                statusEl.textContent = message;
                const colorClass = {
                    'gray': 'text-gray-400',
                    'yellow': 'text-yellow-600',
                    'green': 'text-green-600 font-bold',
                    'red': 'text-red-600'
                }[color] || 'text-gray-400';
                statusEl.className = `text-[9px] ${colorClass}`;
            }
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('ğŸš€ ë…¸ì¶œë¶„ì„ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');
                
                // ì¸ì¦ ì²´í¬
                if (!checkAuthentication()) {
                    console.log('âŒ ì¸ì¦ ì‹¤íŒ¨');
                    return;
                }
                console.log('âœ… ì¸ì¦ ì²´í¬ í†µê³¼');

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™” (ì •ì˜ë˜ì–´ ìˆìœ¼ë©´)
                if (typeof localStorageManager !== 'undefined') {
                    localStorageManager.initialize().catch(err => {
                        console.warn('ë¡œì»¬ í´ë” ì´ˆê¸°í™” ì‹¤íŒ¨, localStorage ì‚¬ìš©:', err);
                    });
                }
                
                // â˜… localStorage ìƒíƒœ í™•ì¸ â˜…
                const hasData = localStorage.getItem('uploadedData');
                const hasNetting = localStorage.getItem('nettingResult');
                console.log('ğŸ“¦ localStorage ìƒíƒœ:');
                console.log('  - uploadedData:', hasData ? 'O' : 'X');
                console.log('  - nettingResult:', hasNetting ? 'O' : 'X');
                
                // â˜… í—¤ì§€ë§¤ë‹ˆì € ë°ì´í„° í™•ì¸ ë° í‘œì‹œ â˜…
                console.log('ğŸ“Š checkAndDisplayData í˜¸ì¶œ...');
                checkAndDisplayData();
                console.log('âœ… checkAndDisplayData ì™„ë£Œ');
                
                // â˜… ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ê¸° ì‹¤í–‰ â˜…
                if (hasData) {
                    setTimeout(() => {
                        console.log('ğŸ“Š ë°ì´í„° ìˆìŒ - ìë™ ê³„ì‚°ê¸° ì‹¤í–‰');
                        runAllCalculators();
                    }, 500);
                } else {
                    console.log('ğŸ“Š ë°ì´í„° ì—†ìŒ - ê³„ì‚°ê¸° ì‹¤í–‰ ê±´ë„ˆëœ€');
                }
                
                console.log('âœ… ë…¸ì¶œ ë¶„ì„ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ í˜ì´ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('í˜ì´ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message);
            }
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ë°ì´í„° ì¬í™•ì¸ (íƒ­ ê°„ ì´ë™ ì‹œ)
        window.addEventListener('focus', () => {
            console.log('ğŸ“Š ë…¸ì¶œë¶„ì„: í˜ì´ì§€ í¬ì»¤ìŠ¤ - ë°ì´í„° ì¬í™•ì¸');
            checkAndDisplayData();
        });

        // ê³„ì‚°ê¸° ì¹´ë“œì— ì»¤ì„œê°€ ë‹¿ìœ¼ë©´ íˆ´íŒ(ì¹´ë“œ ê·¼ì²˜) í‘œì‹œ ë° ë‹¨ì¼ ê³„ì‚°ê¸° ì‹¤í–‰ ë²„íŠ¼ ì—°ê²°
        (function setupCalculatorTooltip(){
            let hideTimer = null;
            let tooltip = null;

            function createTooltip(){
                tooltip = document.createElement('div');
                tooltip.className = 'calc-tooltip';
                tooltip.setAttribute('role', 'dialog');
                tooltip.setAttribute('aria-hidden', 'true');
                tooltip.innerHTML = `
                    <div class="tt-close" aria-label="ë‹«ê¸°" title="ë‹«ê¸°">âœ•</div>
                    <div class="tt-title" id="ttTitle"></div>
                    <div class="tt-desc" id="ttDesc"></div>
                    <div class="tt-actions"><button id="ttRunBtn">ê³„ì‚° ì‹¤í–‰</button></div>
                `;
                document.body.appendChild(tooltip);

                tooltip.querySelector('.tt-close').addEventListener('click', hideTooltip);
                tooltip.addEventListener('mouseenter', () => { if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; } });
                tooltip.addEventListener('mouseleave', () => { scheduleHide(); });

                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && tooltip.classList.contains('show')) hideTooltip(); });
            }

            function positionTooltipNear(card){
                const rect = card.getBoundingClientRect();
                const tt = tooltip;
                const margin = 10;
                // ê¸°ë³¸: ì˜¤ë¥¸ìª½ì— í‘œì‹œ
                let left = rect.right + margin + window.scrollX;
                let top = rect.top + window.scrollY;

                // í™”ë©´ ì˜¤ë¥¸ìª½ ëì— ê±¸ì¹˜ë©´ ì™¼ìª½ì— í‘œì‹œ
                if (left + tt.offsetWidth > window.innerWidth - 20) {
                    left = rect.left - tt.offsetWidth - margin + window.scrollX;
                }

                // í™”ë©´ ì•„ë˜ë¡œ ë„˜ì–´ê°€ë©´ ìœ„ë¡œ ì´ë™
                if (top + tt.offsetHeight > window.innerHeight - 20 + window.scrollY) {
                    top = window.innerHeight - tt.offsetHeight - 20 + window.scrollY;
                }

                // ìµœì†Œê°’ ë³´ì •
                left = Math.max(8 + window.scrollX, left);
                top = Math.max(8 + window.scrollY, top);

                tt.style.left = left + 'px';
                tt.style.top = top + 'px';

                // í™”ì‚´í‘œ ë°©í–¥ ìŠ¤íƒ€ì¼ (ê°„ë‹¨ ì²˜ë¦¬)
                tt.style.setProperty('--arrow-left', (rect.left + rect.width/2) + 'px');
            }

            function showTooltip(card){
                if (!tooltip) createTooltip();
                const titleEl = card.querySelector(':scope > div > div > div:nth-child(2)');
                const title = (titleEl && titleEl.innerText) ? titleEl.innerText.trim() : (`ê³„ì‚°ê¸° ${card.dataset.calc || ''}`);
                const desc = card.dataset.desc || 'ì„¤ëª… ì—†ìŒ';

                tooltip.querySelector('#ttTitle').textContent = title;
                tooltip.querySelector('#ttDesc').textContent = desc;
                tooltip.setAttribute('aria-hidden', 'false');
                tooltip.classList.add('show');
                positionTooltipNear(card);

                // 'ê³„ì‚° ì‹¤í–‰' ë²„íŠ¼ ì—°ê²°
                const runBtn = tooltip.querySelector('#ttRunBtn');
                runBtn.disabled = false;
                runBtn.textContent = 'ê³„ì‚° ì‹¤í–‰';
                runBtn.onclick = async () => {
                    const calcNum = (card.dataset.calc || '').padStart(2, '0');
                    try {
                        runBtn.disabled = true; runBtn.textContent = 'â³ ì‹¤í–‰ ì¤‘...';
                        updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì‹¤í–‰ ì¤‘...`, 'yellow');
                        const uploadedData = localStorage.getItem('uploadedData');
                        if (!uploadedData) {
                            updateCalculatorStatus('ë°ì´í„° ì—†ìŒ - ì—…ë¡œë“œ í•„ìš”', 'red');
                            runBtn.disabled = false; runBtn.textContent = 'ê³„ì‚° ì‹¤í–‰';
                            return;
                        }
                        const exposureData = prepareExposureData(JSON.parse(uploadedData));
                        const res = await callCalculator(calcNum, { exposure: exposureData });
                        if (res && res.success) {
                            updateCalculatorCard(calcNum, res.data);
                            updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì™„ë£Œ`, 'green');
                        } else {
                            updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì‹¤íŒ¨`, 'red');
                        }
                    } catch (err) {
                        console.error('ë‹¨ì¼ ê³„ì‚°ê¸° ì‹¤í–‰ ì˜¤ë¥˜:', err);
                        updateCalculatorStatus('ê³„ì‚° ì‹¤íŒ¨: ' + (err.message || err), 'red');
                    } finally {
                        runBtn.disabled = false; runBtn.textContent = 'ê³„ì‚° ì‹¤í–‰';
                    }
                };
            }

            function hideTooltip(){ if (!tooltip) return; tooltip.classList.remove('show'); tooltip.setAttribute('aria-hidden', 'true'); }

            function scheduleHide(){ if (hideTimer) clearTimeout(hideTimer); hideTimer = setTimeout(() => { hideTooltip(); hideTimer = null; }, 220); }

            function getTitleFromElement(el){
                if (!el) return '';
                if (el.dataset && el.dataset.title) return el.dataset.title;
                // common heading selectors
                const hdr = el.querySelector('h3,h4,.title,.text-sm,.text-lg,.tt-title,.risk-value');
                if (hdr && hdr.innerText) return hdr.innerText.trim();
                // fallback to first line of text content
                const txt = (el.innerText || '').trim().split('\n').map(s=>s.trim()).find(s=>s.length>0);
                return txt ? txt.slice(0, 80) : 'ìƒì„¸ ì •ë³´';
            }

            function bindToCards(){
                // Attach to all card-like elements and any element that has a data-desc attribute
                const cards = document.querySelectorAll('.analysis-card, .kpi-card, [data-desc]');
                cards.forEach(card => {
                    // avoid non-element nodes
                    if (!(card instanceof HTMLElement)) return;
                    card.setAttribute('tabindex', '0');
                    card.addEventListener('mouseenter', () => { if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; } showTooltip(card); });
                    card.addEventListener('mouseleave', () => { scheduleHide(); });
                    card.addEventListener('focus', () => { showTooltip(card); });
                    card.addEventListener('blur', () => { scheduleHide(); });
                });
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindToCards); else bindToCards();

            // ë¬¸ì„œ í´ë¦­ ì‹œ íˆ´íŒ ì™¸ë¶€ í´ë¦­ì´ë©´ íˆ´íŒ ìˆ¨ê¹€
            document.addEventListener('click', (e) => {
                try {
                    if (tooltip && tooltip.classList.contains('show')) {
                        if (!tooltip.contains(e.target) && !e.target.closest('.calc-info-btn')) {
                            hideTooltip();
                        }
                    }
                } catch (err) { /* ì•ˆì „í•˜ê²Œ ë¬´ì‹œ */ }
            });
        })();

        // ëˆˆì— ë„ëŠ” ì„¤ëª… ë²„íŠ¼ê³¼ ì¤‘ì•™ ìƒì„¸ ëª¨ë‹¬ ì¶”ê°€
        (function setupInfoButtonsAndModal(){
            let overlay = null;
            function showTooltip(card){
                if (!tooltip) createTooltip();
                const title = getTitleFromElement(card) || (`í•­ëª© ${card.dataset.calc || ''}`);
                const desc = card.dataset.desc || 'ì„¤ëª… ì—†ìŒ';

                tooltip.querySelector('#ttTitle').textContent = title;
                tooltip.querySelector('#ttDesc').textContent = desc;
                tooltip.setAttribute('aria-hidden', 'false');
                tooltip.classList.add('show');
                positionTooltipNear(card);

                // 'ìì„¸íˆ ë³´ê¸°' ë²„íŠ¼ ì—°ê²°: ê³„ì‚° ê°€ëŠ¥í•œ í•­ëª©ì´ë©´ ê³„ì‚° ì‹¤í–‰, ì•„ë‹ˆë©´ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
                const runBtn = tooltip.querySelector('#ttRunBtn');
                runBtn.disabled = false;
                if (card.dataset && card.dataset.calc) runBtn.textContent = 'ê³„ì‚° ì‹¤í–‰';
                else runBtn.textContent = 'ìì„¸íˆ ë³´ê¸°';
                runBtn.onclick = async () => {
                    try {
                        if (card.dataset && card.dataset.calc) {
                            const calcNum = (card.dataset.calc || '').padStart(2, '0');
                            runBtn.disabled = true; runBtn.textContent = 'â³ ì‹¤í–‰ ì¤‘...';
                            updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì‹¤í–‰ ì¤‘...`, 'yellow');
                            const uploadedData = localStorage.getItem('uploadedData');
                            if (!uploadedData) {
                                updateCalculatorStatus('ë°ì´í„° ì—†ìŒ - ì—…ë¡œë“œ í•„ìš”', 'red');
                                runBtn.disabled = false; runBtn.textContent = 'ê³„ì‚° ì‹¤í–‰';
                                return;
                            }
                            const exposureData = prepareExposureData(JSON.parse(uploadedData));
                            const res = await callCalculator(calcNum, { exposure: exposureData });
                            if (res && res.success) {
                                updateCalculatorCard(calcNum, res.data);
                                updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì™„ë£Œ`, 'green');
                            } else {
                                updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì‹¤íŒ¨`, 'red');
                            }
                        } else {
                            // ë‹¨ìˆœíˆ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
                            const modalTarget = document.querySelector('.calc-detail-overlay') || null;
                            if (modalTarget) {
                                // reuse showModalFor logic by creating a fake card wrapper
                                showModalFor(card);
                            }
                        }
                    } catch (err) {
                        console.error('íˆ´íŒ ë™ì‘ ì˜¤ë¥˜:', err);
                        updateCalculatorStatus('ë™ì‘ ì‹¤íŒ¨: ' + (err.message || err), 'red');
                    } finally {
                        if (card.dataset && card.dataset.calc) { runBtn.disabled = false; runBtn.textContent = 'ê³„ì‚° ì‹¤í–‰'; }
                    }
                };
            }

            function createModal(){
                overlay = document.createElement('div');
                overlay.className = 'calc-detail-overlay';
                // mark as side variant by default
                overlay.classList.add('side');

                const modal = document.createElement('div');
                modal.className = 'calc-detail-modal';
                modal.setAttribute('role','dialog');
                modal.setAttribute('aria-modal','true');
                modal.innerHTML = `
                    <div class="title" id="detailTitle">ê³„ì‚°ê¸° ì„¤ëª…</div>
                    <div class="body" id="detailBody">ì„¤ëª… ë‚´ìš©</div>
                    <div class="controls">
                        <button class="close" id="detailClose">ë‹«ê¸°</button>
                        <button class="run" id="detailRun">ê³„ì‚° ì‹¤í–‰</button>
                    </div>
                `;
                overlay.appendChild(modal);

                // ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ì´ë“œë°”(aside)ê°€ ìˆìœ¼ë©´ ê·¸ ë‚´ë¶€ì— ì¶”ê°€í•˜ì—¬ ì‚¬ì´ë“œë°” ì˜ì—­ì—ì„œ ëª¨ë‹¬ì´ ì—´ë¦¬ê²Œ í•¨
                const side = document.querySelector('aside');
                if (side) {
                    try {
                        // ensure aside can contain absolutely positioned children
                        if (getComputedStyle(side).position === 'static') side.style.position = 'relative';
                        side.appendChild(overlay);
                        // position overlay absolutely inside aside
                        overlay.style.position = 'absolute';
                        overlay.style.top = '72px';
                        overlay.style.left = '8px';
                        overlay.style.width = 'calc(100% - 16px)';
                        console.log('INFO: overlay appended into aside for sidebar modal');
                    } catch (err) {
                        console.warn('WARN: failed to append overlay into aside, fallback to body', err);
                        document.body.appendChild(overlay);
                    }
                } else {
                    document.body.appendChild(overlay);
                }

                // ì´ë²¤íŠ¸ ì—°ê²°
                overlay.querySelector('#detailClose').addEventListener('click', hideModal);
                overlay.querySelector('#detailRun').addEventListener('click', async () => {
                    const calcNum = overlay.dataset.calcNum;
                    if (!calcNum) return;
                    const btn = overlay.querySelector('#detailRun');
                    try {
                        btn.disabled = true; btn.textContent = 'â³ ì‹¤í–‰ ì¤‘...';
                        updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì‹¤í–‰ ì¤‘...`, 'yellow');
                        const uploadedData = localStorage.getItem('uploadedData');
                        if (!uploadedData) { updateCalculatorStatus('ë°ì´í„° ì—†ìŒ - ì—…ë¡œë“œ í•„ìš”', 'red'); return; }
                        const exposureData = prepareExposureData(JSON.parse(uploadedData));
                        const res = await callCalculator(calcNum, { exposure: exposureData });
                        if (res && res.success) { updateCalculatorCard(calcNum, res.data); updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì™„ë£Œ`, 'green'); }
                        else updateCalculatorStatus(`ê³„ì‚°ê¸° ${calcNum} ì‹¤íŒ¨`, 'red');
                    } catch (err) {
                        console.error(err); updateCalculatorStatus('ê³„ì‚° ì‹¤íŒ¨', 'red');
                    } finally { btn.disabled = false; btn.textContent = 'ê³„ì‚° ì‹¤í–‰'; }
                });

                // ESCë¡œ ë‹«ê¸°
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && overlay.classList.contains('show')) hideModal(); });

                // ì˜¤ë²„ë ˆì´(ë°°ê²½) í´ë¦­ ì‹œ ë‹«ê¸°
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) hideModal();
                });
            }

            function getTitleForModal(el){
                if (!el) return 'ìƒì„¸ ì •ë³´';
                if (el.dataset && el.dataset.title) return el.dataset.title;
                const hdr = el.querySelector('h3,h4,.title,.text-sm,.text-lg');
                if (hdr && hdr.innerText) return hdr.innerText.trim();
                const txt = (el.innerText || '').trim().split('\n').map(s=>s.trim()).find(s=>s.length>0);
                return txt ? txt.slice(0,80) : 'ìƒì„¸ ì •ë³´';
            }

            function showModalFor(card){
                console.log('INFO: showModalFor called for calc', card && card.dataset && card.dataset.calc);
                if (!overlay) createModal();
                const title = getTitleForModal(card) || (`ê³„ì‚°ê¸° ${card.dataset.calc || ''}`);
                const desc = card.dataset.desc || 'ì„¤ëª… ì—†ìŒ';
                overlay.querySelector('#detailTitle').textContent = title;
                overlay.querySelector('#detailBody').textContent = desc;
                overlay.dataset.calcNum = (card.dataset.calc || '').padStart(2,'0');
                // Position overlay fixed inside the left sidebar area so all modals open in one place
                try {
                    // ensure overlay is a direct child of body to avoid being clipped or positioned by other containers
                    // If aside exists and overlay is not already in it, append into aside so modal shows inside sidebar
                    const side = document.querySelector('aside');
                    if (side && overlay.parentElement !== side) {
                        try { side.appendChild(overlay); } catch (err) { console.warn('WARN: could not append overlay into aside', err); }
                    }
                    // clear any CSS inset shorthand so inline left/top take effect
                    overlay.style.inset = 'auto';
                    if (side) {
                        const rect = side.getBoundingClientRect();
                        // left position with small inset
                        const left = Math.max(6, Math.round(rect.left + 8));
                        const top = Math.max(72, Math.round(rect.top + 72));
                        overlay.style.position = 'fixed';
                        overlay.style.left = left + 'px';
                        // keep a fixed top so it appears under the header
                        overlay.style.top = '72px';
                        overlay.style.width = Math.max(180, Math.round(rect.width - 16)) + 'px';
                        // ensure modal inside fills the overlay width
                        const modalEl = overlay.querySelector('.calc-detail-modal');
                        if (modalEl) {
                            modalEl.style.width = '100%';
                            modalEl.style.maxWidth = '100%';
                            modalEl.style.margin = '0';
                        }
                    } else {
                        // fallback: center
                        overlay.style.left = '';
                        overlay.style.top = '';
                        overlay.style.width = '';
                    }
                } catch (err) {
                    console.warn('WARN: showModalFor positioning failed', err);
                }

                overlay.classList.add('show');
                console.log('INFO: overlay positioned and shown. Parent:', overlay.parentElement && overlay.parentElement.tagName, 'classes:', overlay.className);
            }

            function hideModal(){ if (!overlay) return; overlay.classList.remove('show'); overlay.dataset.calcNum = ''; }

            function addInfoButtons(){
                const cards = document.querySelectorAll('.analysis-card, .kpi-card, [data-desc]');
                console.log('INFO: addInfoButtons found', cards.length, 'cards/elements');
                cards.forEach(card => {
                    // avoid duplicating buttons
                    if (card.querySelector('.calc-info-btn')) return;
                    // make card position relative so absolute button positions correctly
                    if (!(card instanceof HTMLElement)) return;
                    if (!card.style.position || card.style.position === '') card.style.position = 'relative';

                    const btn = document.createElement('button');
                    btn.className = 'calc-info-btn pulse';
                    btn.type = 'button';
                    btn.setAttribute('aria-label', 'ê³„ì‚°ê¸° ì„¤ëª… ë³´ê¸°');
                    btn.innerHTML = '<span class="dot">i</span>';
                    btn.addEventListener('click', (e) => { e.stopPropagation(); showModalFor(card); });
                    // also show tooltip on hover/focus
                    btn.addEventListener('mouseenter', () => { card.dispatchEvent(new Event('mouseenter')); });
                    btn.addEventListener('focus', () => { card.dispatchEvent(new Event('focus')); });

                    card.appendChild(btn);
                });
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', addInfoButtons); else addInfoButtons();
        })();
    </script>
</body>
</html>