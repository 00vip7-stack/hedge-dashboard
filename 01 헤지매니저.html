<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HedgeFreedom - ë©”ì¸ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- HedgeFreedom ì½”ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="core/api-client.js"></script>
    <script src="core/local-storage-manager.js"></script>
    <!-- ì•ˆë‚´/ì„¤ëª… ëª¨ë‹¬ CSS/JS -->
    <link rel="stylesheet" href="../ë„êµ¬ëŒ€ê¸°/guide-modal.css">
    <script src="../ë„êµ¬ëŒ€ê¸°/guide-modal.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; color: #333; }
        .hedgefreedom-blue { color: #0056b3; }
        .bg-hedgefreedom-dark { background-color: #001529; }
        .action-card { background: white; border-top: 4px solid #1890ff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .btn-execute { background-color: #1890ff; color: white; transition: all 0.2s; }
        .btn-execute:hover { background-color: #096dd9; }
        .indicator-red { color: #f5222d; background: #fff1f0; border: 1px solid #ffa39e; }
        .indicator-green { color: #52c41a; background: #f6ffed; border: 1px solid #b7eb8f; }
        
        /* í—¤ì§€ ê³„ì‚° ë²„íŠ¼ í™œì„±í™” ì• ë‹ˆë©”ì´ì…˜ (ë°ì€ ê¹œë¹¡ì„) */
        @keyframes brightPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7), 0 4px 15px rgba(249, 115, 22, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(249, 115, 22, 0), 0 4px 20px rgba(249, 115, 22, 0.6);
                transform: scale(1.02);
            }
        }
        .btn-ready-pulse {
            animation: brightPulse 1.5s ease-in-out infinite;
        }
        
        /* ì‹œìŠ¤í…œ ì œì•ˆ í—¤ì§€ ê±°ë˜ ìŠ¤í¬ë¡¤ í…Œì´ë¸” */
        #hedgeSuggestionsSection {
            display: flex !important;
            flex-direction: column !important;
            max-height: 220px !important;
            overflow: hidden !important;
        }
        #hedgeSuggestionsScrollArea {
            flex: 1 1 auto !important;
            overflow-y: auto !important;
            min-height: 80px !important;
            max-height: 130px !important;
        }
        #hedgeSuggestionsScrollArea table {
            table-layout: fixed;
            width: 100%;
        }
        #hedgeSuggestionsScrollArea::-webkit-scrollbar {
            width: 10px;
        }
        #hedgeSuggestionsScrollArea::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 5px;
        }
        #hedgeSuggestionsScrollArea::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 5px;
        }
        #hedgeSuggestionsScrollArea::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        
        /* ê¸°ì¡´ ìŠ¤í¬ë¡¤ í´ë˜ìŠ¤ (ë¯¸ì‚¬ìš©) */
        .hedge-suggestions-scroll {
            height: 400px;
            overflow-y: scroll !important;
            display: block;
        }
        .hedge-suggestions-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .hedge-suggestions-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .hedge-suggestions-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .hedge-suggestions-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="flex h-screen">

    <div class="menu-guide-box"></div>
    <aside class="bg-hedgefreedom-dark w-60 flex-shrink-0 text-gray-400 text-sm h-screen overflow-y-auto left-menu">
        <div class="p-6 text-white text-xl font-bold border-b border-gray-800">HedgeFreedom</div>
        <nav class="mt-4 pb-20">
            <div class="px-6 py-2 text-xs font-semibold text-gray-600 uppercase">ğŸ“Œ ì—…ë¬´ íë¦„</div>
            
            <!-- STEP 1 -->
            <a href="01 í—¤ì§€ë§¤ë‹ˆì €.html" class="flex items-center px-6 py-3 bg-blue-600 text-white font-medium" data-guide="í—¤ì§€ ë§¤ë‹ˆì €ì—ì„œëŠ” ì—…ë¡œë“œëœ ê±°ë˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í—¤ì§€ ì „ëµì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° ê±°ë˜ì˜ ìƒíƒœì™€ KPIë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”." data-guidetitle="í—¤ì§€ ë§¤ë‹ˆì € ì•ˆë‚´">
                <span class="bg-white text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">1</span>
                í—¤ì§€ ë§¤ë‹ˆì €
            </a>
            
            <!-- STEP 2 -->
            <a href="02 ë…¸ì¶œë¶„ì„ .html" class="flex items-center px-6 py-3 hover:bg-gray-800" data-guide="ë…¸ì¶œ ë¶„ì„ì—ì„œëŠ” ì „ì²´ ê±°ë˜ì˜ í†µí™”ë³„, ì±„ê¶Œ/ì±„ë¬´ë³„ í˜„í™©ì„ ì§‘ê³„í•˜ì—¬ í™˜ë¦¬ìŠ¤í¬ë¥¼ ì‹œê°ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ë…¸ì¶œ ë¶„ì„ ì•ˆë‚´">
                <span class="bg-gray-700 text-gray-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">2</span>
                ë…¸ì¶œ ë¶„ì„
            </a>
            
            <!-- STEP 3 -->
            <a href="03 ìœ„í—˜ë³´ê³ ì„œ.html" class="flex items-center px-6 py-3 hover:bg-gray-800" data-guide="ìœ„í—˜ ë³´ê³ ì„œì—ì„œëŠ” í™˜ë¦¬ìŠ¤í¬, ë¯¸í—¤ì§€ ë…¸ì¶œ, ì „ëµ ì‹¤í–‰ ê²°ê³¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ìœ„í—˜ ë³´ê³ ì„œ ì•ˆë‚´">
                <span class="bg-gray-700 text-gray-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">3</span>
                ìœ„í—˜ ë³´ê³ ì„œ
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            
            <div class="px-6 py-2 text-xs font-semibold text-gray-600 uppercase">ì¶”ê°€ ë„êµ¬</div>
            <a href="hedge-dashboard.html" class="flex items-center px-6 py-3 hover:bg-gray-800">ğŸ“Š ì „ì²´ ëŒ€ì‹œë³´ë“œ</a>
            <a href="dashboard-analysis.html" class="flex items-center px-6 py-3 hover:bg-gray-800">ğŸ“ˆ ë¶„ì„ ë„êµ¬</a>
            <a href="demo-anonymization.html" class="flex items-center px-6 py-3 hover:bg-gray-800">ğŸ”’ ìµëª…í™” í…ŒìŠ¤íŠ¸</a>
            
            <div class="border-t border-gray-800 my-4"></div>
            
            <div class="px-6 py-2 text-xs font-semibold text-gray-600 uppercase">ê³„ì •</div>
            <a href="login.html" onclick="handleLogout(event)" class="flex items-center px-6 py-3 hover:bg-gray-800 text-red-400">
                ğŸšª ë¡œê·¸ì•„ì›ƒ
            </a>
            
            <!-- ì‚¬ìš©ì ì •ë³´ -->
            <div class="px-6 py-4 mt-8 border-t border-gray-800">
                <div class="text-xs text-gray-500">ë¡œê·¸ì¸:</div>
                <div id="userEmail" class="text-sm text-gray-300 truncate">demo@hedgefreedom.com</div>
                <div id="companyName" class="text-xs text-gray-500 mt-1">ë°ëª¨ íšŒì‚¬</div>
            </div>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        
        <header class="bg-white border-b">
            <div class="flex justify-between items-center px-8 py-0.5 border-b border-gray-50">
                <div class="flex items-center space-x-2">
                    <span id="serverStatusDot" class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span id="serverStatusText" class="text-[10px] text-gray-500">ê³„ì‚° ì„œë²„: ë¡œì»¬</span>
                    <button onclick="showServerSettings()" class="text-[10px] text-blue-500 hover:underline ml-2">âš™ï¸ ì„¤ì •</button>
                </div>
                <span class="text-[10px] text-gray-400 font-light">ê°±ì‹  1ë¶„ì „</span>
            </div>
            <div class="h-14 flex items-center justify-between px-8">
                <div class="flex items-center space-x-6 flex-1">
                    <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded">
                        <span class="text-xs font-bold text-gray-600">USD/KRW</span>
                        <span class="text-sm font-bold text-green-600">1,342.50</span>
                        <span class="text-[10px] text-green-600">â–²0.45%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-red-50 rounded">
                        <span class="text-xs font-bold text-gray-600">EUR/USD</span>
                        <span class="text-sm font-bold text-red-600">1.0842</span>
                        <span class="text-[10px] text-red-600">â–¼0.12%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded">
                        <span class="text-xs font-bold text-gray-600">USD/JPY</span>
                        <span class="text-sm font-bold text-green-600">148.23</span>
                        <span class="text-[10px] text-green-600">â–²0.28%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-red-50 rounded">
                        <span class="text-xs font-bold text-gray-600">USD/CNY</span>
                        <span class="text-sm font-bold text-red-600">7.2145</span>
                        <span class="text-[10px] text-red-600">â–¼0.08%</span>
                    </div>
                    <div class="flex items-center space-x-2 px-3 py-1 bg-green-50 rounded">
                        <span class="text-xs font-bold text-gray-600">DXY</span>
                        <span class="text-sm font-bold text-green-600">103.42</span>
                        <span class="text-[10px] text-green-600">â–²0.15%</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-6 overflow-y-auto space-y-6">
            
            <!-- ì—…ë¡œë“œëœ ê±°ë˜ ë°ì´í„° í…Œì´ë¸” (ìƒë‹¨ ë°°ì¹˜) -->
            <section class="action-card overflow-hidden" data-guide="ì—¬ê¸°ì„œ ì—…ë¡œë“œëœ ê±°ë˜ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³ , íŒŒì¼/í´ë” ì—…ë¡œë“œ, ë°ì´í„° ì‚­ì œ, í—¤ì§€ ê³„ì‚° ì‹¤í–‰ ë“± ì£¼ìš” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ê±°ë˜ ë°ì´í„° ì•ˆë‚´">
                <div class="p-4 bg-gradient-to-r from-blue-600 to-indigo-600 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg text-white">ğŸ“Š ì—…ë¡œë“œëœ ê±°ë˜ ë°ì´í„°</h3>
                        <p class="text-xs text-blue-100 mt-1">Excel/CSV íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¨ ì›ë³¸ ê±°ë˜ ë°ì´í„°</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tradeCount" class="text-sm font-bold text-white bg-blue-500 px-4 py-2 rounded-lg">ë°ì´í„° ì—†ìŒ</span>
                        <input type="file" id="fileInputDirect" accept=".xlsx,.xls,.csv" class="hidden">
                        <input type="file" id="folderInputDirect" webkitdirectory directory accept=".xlsx,.xls,.csv" class="hidden" multiple>
                        <button onclick="document.getElementById('fileInputDirect').click()" class="px-4 py-2 bg-white text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-50 flex items-center gap-2">
                            ğŸ“„ íŒŒì¼ ì—…ë¡œë“œ
                        </button>
                        <button onclick="document.getElementById('folderInputDirect').click()" class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-semibold hover:bg-yellow-200 flex items-center gap-2">
                            ğŸ“ í´ë” ì—…ë¡œë“œ
                        </button>
                        <button id="clearDataBtn" onclick="clearAllData()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200 flex items-center gap-2">
                            ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ
                        </button>
                        <button id="runHedgeAnalysisBtn" onclick="runHedgeAnalysis()" class="px-6 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg text-sm font-bold hover:from-orange-600 hover:to-red-600 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            âš¡ í—¤ì§€ ê³„ì‚° ì‹¤í–‰
                        </button>
                    </div>
                </div>
                <div class="overflow-auto max-h-60">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-white text-gray-400 border-b sticky top-0">
                            <tr>
                                <th class="p-3 uppercase tracking-wider font-bold">ê±°ë˜ID</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ê±°ë˜ì²˜ëª…</th>
                                <th class="p-3 uppercase tracking-wider font-bold">í†µí™”</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ì™¸í™”ê¸ˆì•¡</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ê²°ì œì˜ˆì •ì¼</th>
                                <th class="p-3 uppercase tracking-wider font-bold">êµ¬ë¶„</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ì›í™”í™˜ì‚°ì•¡</th>
                                <th class="p-3 uppercase tracking-wider font-bold">D-Day</th>
                                <th class="p-3 uppercase tracking-wider font-bold">í—¤ì§€ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="tradeListBody" class="divide-y divide-gray-100">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
                            <tr>
                                <td colspan="9" class="p-8 text-center text-gray-400">
                                    <div class="text-4xl mb-2">ğŸ“Š</div>
                                    <p>ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                    <p class="text-xs mt-2">íŒŒì¼ ë˜ëŠ” í´ë”ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ì›ë³¸ í—¤ì§€ë§¤ë‹ˆì € KPI ì„¹ì…˜ -->
            <section id="kpiSection" class="grid grid-cols-3 gap-6" data-guide="KPI ì„¹ì…˜ì—ì„œëŠ” ëª©í‘œ í—¤ì§€ ë¹„ìœ¨, í˜„ì¬ í—¤ì§€ ë¹„ìœ¨, ë¯¸í—¤ì§€ ë…¸ì¶œ ë“± í•µì‹¬ ì§€í‘œë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="KPI ì•ˆë‚´">
                <div class="bg-white p-5 rounded shadow-sm flex flex-col">
                    <span class="text-xs font-bold text-gray-400 mb-2">ëª©í‘œ í—¤ì§€ ë¹„ìœ¨</span>
                    <div class="flex items-end space-x-2">
                        <span id="kpiTargetHedge" class="text-3xl font-bold text-gray-800">75%</span>
                        <span class="text-sm text-gray-500 mb-1">ì´ì‚¬íšŒ ì •ì±… ê¸°ì¤€</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded shadow-sm flex flex-col">
                    <span class="text-xs font-bold text-gray-400 mb-2">í˜„ì¬ í—¤ì§€ ë¹„ìœ¨</span>
                    <div class="flex items-end space-x-2">
                        <span id="kpiCurrentHedge" class="text-3xl font-bold text-red-500">0%</span>
                        <span id="kpiHedgeGap" class="indicator-red text-[10px] px-2 py-1 rounded font-bold mb-1">ë°ì´í„° ì—†ìŒ</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded shadow-sm flex flex-col">
                    <span class="text-xs font-bold text-gray-400 mb-2">ë¯¸í—¤ì§€ ë…¸ì¶œ</span>
                    <div class="flex items-end space-x-2">
                        <span id="kpiUnhedgedExposure" class="text-3xl font-bold text-gray-800">0ì–µì›</span>
                        <span class="text-sm text-gray-500 mb-1">KRW í™˜ì‚°</span>
                    </div>
                </div>
            </section>

            <!-- ì›ë³¸ í—¤ì§€ë§¤ë‹ˆì € ì œì•ˆ ê±°ë˜ ì„¹ì…˜ -->
            <section id="hedgeSuggestionsSection" class="action-card" data-guide="ì‹œìŠ¤í…œì´ ì œì•ˆí•˜ëŠ” ê°œë³„ í—¤ì§€ ê±°ë˜ë¥¼ í™•ì¸í•˜ê³ , ì „ëµ ìµœì í™” ë° ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤." data-guidetitle="ì œì•ˆ í—¤ì§€ ê±°ë˜ ì•ˆë‚´">
                <div class="p-4 bg-gray-50 flex justify-between items-center border-b flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-sm text-gray-700">ğŸ“‹ ì‹œìŠ¤í…œ ì œì•ˆ í—¤ì§€ ê±°ë˜ (ê°œë³„ê±´)</h3>
                        <span id="hedgeSuggestionsCount" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">0ê±´</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-xs px-3 py-1 border rounded bg-white hover:bg-gray-100">ì „ëµ ìµœì í™”</button>
                        <button onclick="executeAllSuggestions()" class="text-xs px-3 py-1 btn-execute rounded font-bold">ëª¨ë“  ì œì•ˆ ì‹¤í–‰</button>
                    </div>
                </div>
                
                <!-- í…Œì´ë¸” í—¤ë” (ê³ ì •) -->
                <div class="bg-gray-100 border-b flex-shrink-0">
                    <table class="w-full text-xs text-left" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th class="px-2 py-2 uppercase tracking-wider text-gray-600 text-center text-[10px]" style="width: 40px;">#</th>
                                <th class="px-2 py-2 uppercase tracking-wider text-gray-600 text-[10px]" style="width: 150px;">ê±°ë˜ì²˜</th>
                                <th class="px-2 py-2 uppercase tracking-wider text-gray-600 text-[10px]" style="width: 100px;">ê¶Œì¥ ìƒí’ˆ</th>
                                <th class="px-2 py-2 uppercase tracking-wider text-gray-600 text-[10px]" style="width: 60px;">í†µí™”</th>
                                <th class="px-2 py-2 uppercase tracking-wider text-gray-600 text-right text-[10px]" style="width: 100px;">ê¶Œì¥ ê¸ˆì•¡</th>
                                <th class="px-2 py-2 uppercase tracking-wider text-gray-600 text-[10px]" style="width: 90px;">ê²°ì œì¼</th>
                                <th class="px-2 py-2 uppercase tracking-wider font-bold text-blue-600 text-[10px]" style="width: 90px;">ê¶Œì¥ ì€í–‰</th>
                                <th class="px-2 py-2 text-center text-gray-600 text-[10px]" style="width: 60px;">ì‹¤í–‰</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                
                <!-- í…Œì´ë¸” ë°”ë”” (ìŠ¤í¬ë¡¤) -->
                <div id="hedgeSuggestionsScrollArea">
                    <table class="w-full text-xs text-left" style="table-layout: fixed;">
                        <tbody id="hedgeSuggestionsBody">
                            <tr>
                                <td colspan="8" class="text-center text-gray-400 py-20">
                                    <div class="text-4xl mb-2">ğŸ’¡</div>
                                    <p>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê°œë³„ í—¤ì§€ ê±°ë˜ê°€</p>
                                    <p class="text-xs mt-1">ì´ ì˜ì—­ì— ìŠ¤í¬ë¡¤ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- í†µí•© í—¤ì§€ ì œì•ˆ ì„¹ì…˜ - í˜¼í•© í—¤ì§€ ì „ëµ -->
            <section id="integratedHedgeSection" class="action-card overflow-hidden mt-4" data-guide="í†µí•© í—¤ì§€ ì „ëµ ì œì•ˆì—ì„œëŠ” ì„ ë¬¼í™˜, í™˜ë³€ë™ë³´í—˜, ë‹¬ëŸ¬ì„ ë¬¼ ë“± ë‹¤ì–‘í•œ í—¤ì§€ ìˆ˜ë‹¨ì„ í˜¼í•©í•˜ì—¬ ìµœì ì˜ ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤." data-guidetitle="í†µí•© í—¤ì§€ ì „ëµ ì•ˆë‚´">
                <div class="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 flex justify-between items-center border-b border-purple-200">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">ğŸ¯</span>
                        <div>
                            <h3 class="font-bold text-sm text-purple-800">í†µí•© í—¤ì§€ ì „ëµ ì œì•ˆ</h3>
                            <p class="text-[10px] text-purple-600">ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜ + ë‹¬ëŸ¬ì„ ë¬¼ í˜¼í•© ì „ëµìœ¼ë¡œ ìœ ë™ì  ê²°ì œì¼ ëŒ€ì‘</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="generateIntegratedHedge()" class="text-xs px-3 py-1 border border-purple-300 rounded bg-white hover:bg-purple-50 text-purple-700">ì „ëµ ê³„ì‚°</button>
                        <button onclick="executeIntegratedHedge()" class="text-xs px-3 py-1 bg-purple-600 text-white rounded font-bold hover:bg-purple-700">ì „ëµ ì‹¤í–‰</button>
                    </div>
                </div>
                
                <!-- ì „ì²´ ë…¸ì¶œ ìš”ì•½ -->
                <div class="p-4 bg-white border-b">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm font-bold text-gray-700">ğŸ“Š ì „ì²´ ë…¸ì¶œ í˜„í™©</h4>
                        <span id="integratedDataStatus" class="text-[10px] text-gray-400">ë°ì´í„° ì—†ìŒ</span>
                    </div>
                    <div class="grid grid-cols-5 gap-4">
                        <div class="text-center p-3 bg-gray-50 rounded-lg" data-guide="ì „ì²´ ê±°ë˜ ë°ì´í„°ì˜ ê±´ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì—…ë¡œë“œëœ ê±°ë˜ê°€ ëª‡ ê±´ì¸ì§€ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ì´ ê±°ë˜ê±´ìˆ˜ ì•ˆë‚´">
                            <div class="text-xs text-gray-500 mb-1">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                            <div id="integratedTotalCount" class="text-xl font-bold text-gray-700">0ê±´</div>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg" data-guide="ë°›ì„ ëˆ(ì±„ê¶Œ)ì˜ ì´ì•¡ì„ í‘œì‹œí•©ë‹ˆë‹¤. ê¸°ì—…ì´ ì™¸í™”ë¡œ ë°›ì„ ì˜ˆì •ì¸ ê¸ˆì•¡ì˜ í•©ê³„ì…ë‹ˆë‹¤." data-guidetitle="ì´ ì±„ê¶Œ ì•ˆë‚´">
                            <div class="text-xs text-blue-600 mb-1">ì´ ì±„ê¶Œ (ë°›ì„ëˆ)</div>
                            <div id="integratedReceivable" class="text-xl font-bold text-blue-600">$0</div>
                        </div>
                        <div class="text-center p-3 bg-red-50 rounded-lg" data-guide="ì¤„ ëˆ(ì±„ë¬´)ì˜ ì´ì•¡ì„ í‘œì‹œí•©ë‹ˆë‹¤. ê¸°ì—…ì´ ì™¸í™”ë¡œ ì§€ê¸‰í•´ì•¼ í•  ê¸ˆì•¡ì˜ í•©ê³„ì…ë‹ˆë‹¤." data-guidetitle="ì´ ì±„ë¬´ ì•ˆë‚´">
                            <div class="text-xs text-red-600 mb-1">ì´ ì±„ë¬´ (ì¤„ëˆ)</div>
                            <div id="integratedPayable" class="text-xl font-bold text-red-600">$0</div>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg border-2 border-purple-300" data-guide="ì±„ê¶Œê³¼ ì±„ë¬´ë¥¼ ìƒê³„í•œ í›„ ë‚¨ëŠ” ìˆœ ë…¸ì¶œ ê¸ˆì•¡ì…ë‹ˆë‹¤. ì‹¤ì œë¡œ í—¤ì§€ ì „ëµì´ í•„ìš”í•œ ëŒ€ìƒ ê¸ˆì•¡ì…ë‹ˆë‹¤." data-guidetitle="ìˆœ ë…¸ì¶œ ì•ˆë‚´">
                            <div class="text-xs text-purple-600 mb-1 font-bold">ìˆœ ë…¸ì¶œ (í—¤ì§€ëŒ€ìƒ)</div>
                            <div id="integratedNetExposure" class="text-xl font-bold text-purple-700">$0</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg" data-guide="ìˆœ ë…¸ì¶œ ê¸ˆì•¡ì„ ì›í™”ë¡œ í™˜ì‚°í•œ ê°’ì…ë‹ˆë‹¤. í™˜ë¦¬ìŠ¤í¬ ê´€ë¦¬ì˜ ì‹¤ì œ ê·œëª¨ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ì›í™” í™˜ì‚° ì•ˆë‚´">
                            <div class="text-xs text-green-600 mb-1">ì›í™” í™˜ì‚°</div>
                            <div id="integratedNetKRW" class="text-xl font-bold text-green-600">0ì–µì›</div>
                        </div>
                    </div>
                </div>
                
                <!-- í˜¼í•© í—¤ì§€ ì „ëµ ê¶Œê³  -->
                <div id="mixedHedgeStrategy" class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border-b">
                    <h4 class="text-sm font-bold text-indigo-800 mb-4">ğŸ¯ í˜¼í•© í—¤ì§€ ì „ëµ ê¶Œê³ ì•ˆ</h4>
                    
                    <!-- ì „ëµ ë¹„ìœ¨ ìŠ¬ë¼ì´ë” -->
                    <div class="mb-4 p-4 bg-white rounded-lg border" data-guide="í—¤ì§€ ë¹„ìœ¨ ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì •í•˜ë©´ ì „ì²´ í—¤ì§€ ì „ëµì˜ ë¹„ìœ¨ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 0%~100%ê¹Œì§€ ì¡°ì • ê°€ëŠ¥í•©ë‹ˆë‹¤." data-guidetitle="í—¤ì§€ ë¹„ìœ¨ ì¡°ì • ì•ˆë‚´">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-gray-600">í—¤ì§€ ë¹„ìœ¨ ì¡°ì •</span>
                            <span id="totalHedgeRatio" class="text-sm font-bold text-purple-600">70%</span>
                        </div>
                        <input type="range" id="hedgeRatioSlider" min="0" max="100" value="70" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                               onchange="updateHedgeStrategy()">
                        <div class="flex justify-between text-[9px] text-gray-400 mt-1">
                            <span>0% (ë¬´í—¤ì§€)</span>
                            <span>50%</span>
                            <span>100% (ì™„ì „í—¤ì§€)</span>
                        </div>
                    </div>
                    
                    <!-- í—¤ì§€ ìƒí’ˆë³„ ë°°ë¶„ -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜ (ê³ ì • í—¤ì§€) -->
                        <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500" data-guide="ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜ì€ ê³ ì • ê²°ì œì¼ì— ë§ì¶° í™˜ë¦¬ìŠ¤í¬ë¥¼ í™•ì •ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ìˆ˜ë‹¨ì…ë‹ˆë‹¤." data-guidetitle="ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜ ì•ˆë‚´">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">ğŸ¦</span>
                                    <div>
                                        <div class="text-sm font-bold text-blue-800">ì„ ë¬¼í™˜ / í™˜ë³€ë™ë³´í—˜</div>
                                        <div class="text-[10px] text-gray-500">ê³ ì • ê²°ì œì¼ í™•ì • í—¤ì§€</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div id="forwardRatio" class="text-xl font-bold text-blue-600">60%</div>
                                    <div class="text-[9px] text-gray-400">ê¶Œì¥ ë¹„ìœ¨</div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">í—¤ì§€ ê¸ˆì•¡</span>
                                    <span id="forwardAmount" class="font-bold text-blue-700">$0</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">ì›í™” í™˜ì‚°</span>
                                    <span id="forwardAmountKRW" class="font-bold text-blue-700">0ì–µì›</span>
                                </div>
                                <div class="w-full bg-gray-100 h-2 rounded-full">
                                    <div id="forwardBar" class="bg-blue-500 h-full rounded-full transition-all" style="width: 60%"></div>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-blue-50 rounded text-[10px] text-blue-700">
                                <strong>âœ… ì¥ì :</strong> í™˜ìœ¨ í™•ì •, íšŒê³„ì²˜ë¦¬ ìš©ì´<br>
                                <strong>âš ï¸ ì£¼ì˜:</strong> ê²°ì œì¼ ë³€ê²½ ì‹œ ë¹„ìš© ë°œìƒ
                            </div>
                        </div>
                        
                        <!-- ë‹¬ëŸ¬ì„ ë¬¼ (ìœ ì—° í—¤ì§€) -->
                        <div class="bg-white p-4 rounded-lg border-l-4 border-orange-500" data-guide="ë‹¬ëŸ¬ì„ ë¬¼ì€ ê²°ì œì¼ì´ ìœ ë™ì ì¸ í™˜ë¦¬ìŠ¤í¬ë¥¼ ìœ ì—°í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ìˆ˜ë‹¨ì…ë‹ˆë‹¤." data-guidetitle="ë‹¬ëŸ¬ì„ ë¬¼ ì•ˆë‚´">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">ğŸ“ˆ</span>
                                    <div>
                                        <div class="text-sm font-bold text-orange-800">ë‹¬ëŸ¬ì„ ë¬¼ (CME/KRX)</div>
                                        <div class="text-[10px] text-gray-500">ìœ ë™ì  ê²°ì œì¼ ëŒ€ì‘ í—¤ì§€</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div id="futuresRatio" class="text-xl font-bold text-orange-600">40%</div>
                                    <div class="text-[9px] text-gray-400">ê¶Œì¥ ë¹„ìœ¨</div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">í—¤ì§€ ê¸ˆì•¡</span>
                                    <span id="futuresAmount" class="font-bold text-orange-700">$0</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">ì›í™” í™˜ì‚°</span>
                                    <span id="futuresAmountKRW" class="font-bold text-orange-700">0ì–µì›</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-600">í•„ìš” ê³„ì•½ìˆ˜</span>
                                    <span id="futuresContracts" class="font-bold text-orange-700">0ê³„ì•½</span>
                                </div>
                                <div class="w-full bg-gray-100 h-2 rounded-full">
                                    <div id="futuresBar" class="bg-orange-500 h-full rounded-full transition-all" style="width: 40%"></div>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-orange-50 rounded text-[10px] text-orange-700">
                                <strong>âœ… ì¥ì :</strong> ë¡¤ì˜¤ë²„ ê°€ëŠ¥, ê²°ì œì¼ ìœ ì—°<br>
                                <strong>âš ï¸ ì£¼ì˜:</strong> ë§ˆì§„ì½œ, ì¼ì¼ì •ì‚° í•„ìš”
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë¯¸í—¤ì§€ ì”ì—¬ë¶„ -->
                    <div id="unhedgedSection" class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200" data-guide="ë¯¸í—¤ì§€ ì”ì—¬ë¶„ì€ ì•„ì§ í—¤ì§€ë˜ì§€ ì•Šì€ í™˜ë¦¬ìŠ¤í¬ ë…¸ì¶œ ê¸ˆì•¡ì…ë‹ˆë‹¤. ì¶”ê°€ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤." data-guidetitle="ë¯¸í—¤ì§€ ì”ì—¬ë¶„ ì•ˆë‚´">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">âš ï¸</span>
                                <div>
                                    <div class="text-sm font-bold text-yellow-800">ë¯¸í—¤ì§€ ì”ì—¬ë¶„</div>
                                    <div class="text-[10px] text-yellow-600">í™˜ìœ¨ ë³€ë™ ìœ„í—˜ì— ë…¸ì¶œ</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div id="unhedgedRatio" class="text-xl font-bold text-yellow-700">30%</div>
                                <div id="unhedgedAmount" class="text-xs text-yellow-600">$0 (0ì–µì›)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì „ëµ ìš”ì•½ í…Œì´ë¸” -->
                <table class="w-full text-xs text-left" data-guide="ì „ëµ ìš”ì•½ í…Œì´ë¸”ì—ì„œëŠ” ê° í—¤ì§€ ìˆ˜ë‹¨ë³„ ë¹„ìœ¨, ê¸ˆì•¡, ê¶Œì¥ ìƒí’ˆ, ì‹¤í–‰ ì—¬ë¶€ ë“±ì„ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ì „ëµ ìš”ì•½ ì•ˆë‚´">
                    <thead class="bg-purple-50 text-purple-700 border-b">
                        <tr>
                            <th class="p-3">í—¤ì§€ ìˆ˜ë‹¨</th>
                            <th class="p-3 text-right">ë¹„ìœ¨</th>
                            <th class="p-3 text-right">ê¸ˆì•¡ (USD)</th>
                            <th class="p-3 text-right">ê¸ˆì•¡ (KRW)</th>
                            <th class="p-3">ê¶Œì¥ ìƒí’ˆ</th>
                            <th class="p-3">ë¹„ê³ </th>
                            <th class="p-3 text-center">ì‹¤í–‰</th>
                        </tr>
                    </thead>
                    <tbody id="integratedHedgeBody" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="7" class="p-6 text-center text-gray-400">
                                <div class="text-3xl mb-2">ğŸ”—</div>
                                <p>ë°ì´í„° ì—…ë¡œë“œ í›„ 'ì „ëµ ê³„ì‚°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´</p>
                                <p class="text-xs mt-1">ìµœì ì˜ í˜¼í•© í—¤ì§€ ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- êµ¬ë¶„ì„  -->
            <hr class="border-t-2 border-gray-300 my-8">
            
            <!-- ì‹¤ì‹œê°„ ì§‘ê³„ í…Œì´ë¸” -->
            <section id="aggregationSummary" class="bg-gradient-to-r from-indigo-50 to-blue-50 p-6 rounded-lg border-l-4 border-indigo-500 mb-6" data-guide="ê±°ë˜ ë°ì´í„° ì§‘ê³„ í˜„í™©ì—ì„œëŠ” ì „ì²´ ê±°ë˜ ê±´ìˆ˜, í†µí™” ì¢…ë¥˜, ì±„ê¶Œ/ì±„ë¬´/ìˆœë…¸ì¶œ ë“± ì§‘ê³„ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ì§‘ê³„ í˜„í™© ì•ˆë‚´">
                <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š ê±°ë˜ ë°ì´í„° ì§‘ê³„ í˜„í™©</h3>
                
                <!-- KPI ì¹´ë“œ -->
                <div class="grid grid-cols-5 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                        <div id="aggTotalCount" class="text-2xl font-bold text-gray-800">0ê±´</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">í†µí™” ì¢…ë¥˜</div>
                        <div id="aggCurrencyCount" class="text-2xl font-bold text-blue-600">0ê°œ</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ì´ ì±„ê¶Œ</div>
                        <div id="aggTotalReceivable" class="text-2xl font-bold text-green-600">0ì–µì›</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ì´ ì±„ë¬´</div>
                        <div id="aggTotalPayable" class="text-2xl font-bold text-red-600">0ì–µì›</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">ìˆœ ë…¸ì¶œ</div>
                        <div id="aggNetExposure" class="text-2xl font-bold text-orange-600">0ì–µì›</div>
                    </div>
                </div>
                
                <!-- í†µí™”ë³„ ìƒì„¸ ì§‘ê³„ í…Œì´ë¸” -->
                <div class="bg-white rounded-lg overflow-hidden shadow-sm">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="p-3 text-left font-bold text-gray-700">í†µí™”</th>
                                <th class="p-3 text-right font-bold text-gray-700">ì±„ê¶Œ ê±´ìˆ˜</th>
                                <th class="p-3 text-right font-bold text-gray-700">ì±„ê¶Œ ê¸ˆì•¡</th>
                                <th class="p-3 text-right font-bold text-gray-700">ì±„ë¬´ ê±´ìˆ˜</th>
                                <th class="p-3 text-right font-bold text-gray-700">ì±„ë¬´ ê¸ˆì•¡</th>
                                <th class="p-3 text-right font-bold text-gray-700">ìˆœ ë…¸ì¶œ</th>
                                <th class="p-3 text-right font-bold text-gray-700">ìƒê³„ ê°€ëŠ¥ì„±</th>
                            </tr>
                        </thead>
                        <tbody id="aggTableBody">
                            <tr>
                                <td colspan="7" class="p-6 text-center text-gray-400">
                                    ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ì‹œë®¬ë ˆì´í„° ì‚¬ìš©ë²• -->
            <div class="bg-blue-50 border-l-4 border-blue-600 p-4 text-sm text-gray-700" data-guide="ì‹œë®¬ë ˆì´í„° ì‚¬ìš©ë²• ì•ˆë‚´: ê±°ë˜ë¥¼ ì„ íƒí•˜ë©´ ê¸ˆì•¡ê³¼ ê²°ì œì¼ì´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê³„ì•½ ìˆ˜ëŸ‰ê³¼ ì˜ˆìƒ ë¹„ìš©ì„ í™•ì¸í•˜ì„¸ìš”." data-guidetitle="ì‹œë®¬ë ˆì´í„° ì•ˆë‚´">
                <strong>ì‹œë®¬ë ˆì´í„° ì‚¬ìš©ë²•:</strong> ê±°ë˜ë¥¼ ì„ íƒí•˜ë©´ ê¸ˆì•¡ê³¼ ê²°ì œì¼ì´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê³„ì•½ ìˆ˜ëŸ‰ê³¼ ì˜ˆìƒ ë¹„ìš©ì„ í™•ì¸í•˜ì„¸ìš”.
            </div>

            <!-- í—¤ì§€ ì „ëµ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
            <div class="grid grid-cols-3 gap-6" data-guide="ê° í—¤ì§€ ìˆ˜ë‹¨ë³„ ì‹œë®¬ë ˆì´í„°ì™€ ì•ˆë‚´ë¬¸ì„ ì œê³µí•©ë‹ˆë‹¤. ì„ ë¬¼í™˜, ë‹¬ëŸ¬ì„ ë¬¼, í™˜ë³€ë™ë³´í—˜ì˜ íŠ¹ì§•ê³¼ ì¥ì ì„ í™•ì¸í•˜ì„¸ìš”." data-guidetitle="í—¤ì§€ ìˆ˜ë‹¨ ì•ˆë‚´">
                <!-- ì„ ë¬¼í™˜ -->
                <div class="bg-white border-2 border-blue-500 rounded-lg shadow-md p-6 flex flex-col" data-guide="ì„ ë¬¼í™˜ì€ ì€í–‰ê³¼ 1:1ë¡œ ë¯¸ë˜ í™˜ìœ¨ì„ í™•ì •í•˜ëŠ” ëŒ€í‘œì  í—¤ì§€ ìˆ˜ë‹¨ì…ë‹ˆë‹¤. ì—¬ëŸ¬ ì€í–‰ ê²¬ì  ìš”ì²­ì„œ ìë™ì‘ì„± ì§€ì›." data-guidetitle="ì„ ë¬¼í™˜ ì•ˆë‚´">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">ì„ ë¬¼í™˜</h3>
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <div class="text-xs font-bold mb-2">í—¤ì§€ ì‹œë®¬ë ˆì´í„°</div>
                        <input type="number" placeholder="í—¤ì§€ ê¸ˆì•¡ (USD)" id="amount1" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                        <input type="date" id="paymentDate1" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                        <button onclick="simulateForward()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">ì‹œë®¬ë ˆì´ì…˜</button>
                        <div id="result1" class="mt-3 text-xs text-gray-700"></div>
                    </div>
                    <div class="text-sm text-gray-700 mb-4">
                        <span class="text-blue-700 font-bold">ì—¬ëŸ¬ ì€í–‰ ê²¬ì  ìš”ì²­ì„œ ìë™ì‘ì„± ì§€ì›</span>
                        <div class="h-2"></div>
                        ì€í–‰ê³¼ 1:1ë¡œ ë¯¸ë˜ í™˜ìœ¨ì„ í™•ì •í•˜ëŠ” ëŒ€í‘œì  í—¤ì§€ ìˆ˜ë‹¨ì…ë‹ˆë‹¤.
                        <div class="h-2"></div>
                        ê¸°ì—…ë³„ ê±°ë˜ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ ìµœì ì˜ ê³„ì•½ ì¡°ê±´ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
                    </div>
                    <button class="mt-auto bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700">ê±°ë˜ì€í–‰</button>
                </div>

                <!-- ë‹¬ëŸ¬ì„ ë¬¼  -->
                <div class="bg-white border-2 border-blue-500 rounded-lg shadow-md p-6 flex flex-col" data-guide="ë‹¬ëŸ¬ì„ ë¬¼ì€ ë‚®ì€ ê±°ë˜ ë¹„ìš©, ë†’ì€ ìœ ë™ì„±, ì¤‘ë„ í•´ì§€ì˜ ìœ ì—°ì„±, ë§Œê¸° ì—°ì¥(Roll-over) ë“± ë‹¤ì–‘í•œ ì¥ì ì´ ìˆìŠµë‹ˆë‹¤." data-guidetitle="ë‹¬ëŸ¬ì„ ë¬¼ ì•ˆë‚´">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">ë‹¬ëŸ¬ì„ ë¬¼</h3>
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <div class="text-xs font-bold mb-2">í—¤ì§€ ì‹œë®¬ë ˆì´í„°</div>
                        <input type="number" placeholder="í—¤ì§€ ê¸ˆì•¡ (USD)" id="amount2" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                        <input type="date" id="paymentDate2" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                        <input type="number" placeholder="í˜„ì¬ ê°€ê²© (KRW) - ì‹¤ì‹œê°„ ì—°ë™ ì˜ˆì •" id="price2" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                        <button onclick="simulateFutures()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">ì‹œë®¬ë ˆì´ì…˜</button>
                        <div id="result2" class="mt-3 text-xs text-gray-700"></div>
                    </div>
                    <div class="text-sm text-gray-700 mb-4">
                        <span class="text-blue-700 font-bold">ë‹¬ëŸ¬ì„ ë¬¼ì˜ ì¥ì </span>
                        <div class="h-2"></div>
                        1. ë‚®ì€ ê±°ë˜ ë¹„ìš©<br>
                        2. ë†’ì€ ìœ ë™ì„±ê³¼ ì‹ ì†ì„±<br>
                        3. ì¤‘ë„ í•´ì§€ì˜ ìœ ì—°ì„±<br>
                        4. ë§Œê¸° ì—°ì¥ì˜ í¸ì˜ì„± (Roll-over)
                    </div>
                    <button class="mt-auto bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700">ê±°ë˜ì¦ê¶Œì‚¬</button>
                </div>

                <!-- í™˜ë³€ë™ë³´í—˜ -->
                <div class="bg-white border-2 border-blue-500 rounded-lg shadow-md p-6 flex flex-col" data-guide="í™˜ë³€ë™ë³´í—˜ì€ ì¤‘ì†Œê¸°ì—… ìš°ëŒ€ í˜œíƒ, ì„œë¥˜ ìë™ ì‘ì„± ì§€ì›, ì •ë¶€ì§€ì› ì‹œ ë¬´ë£Œ ë˜ëŠ” ì´ˆì €ë¹„ìš© ì œê³µ ë“± ë‹¤ì–‘í•œ ì¥ì ì´ ìˆìŠµë‹ˆë‹¤." data-guidetitle="í™˜ë³€ë™ë³´í—˜ ì•ˆë‚´">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">í™˜ë³€ë™ë³´í—˜</h3>
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <div class="text-xs font-bold mb-2">í—¤ì§€ ì‹œë®¬ë ˆì´í„°</div>
                        <input type="number" placeholder="ë³´í—˜ ê¸ˆì•¡ (USD)" id="amount3" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                        <select id="coverage3" class="w-full px-3 py-2 border rounded mb-2 text-sm">
                            <option>ê¸°ë³¸ ì»¤ë²„ë¦¬ì§€</option>
                            <option>í™•ì¥ ì»¤ë²„ë¦¬ì§€</option>
                        </select>
                        <button onclick="simulateInsurance()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm">ì‹œë®¬ë ˆì´ì…˜</button>
                        <div id="result3" class="mt-3 text-xs text-gray-700"></div>
                    </div>
                    <div class="text-sm text-gray-700 mb-4">
                        <span class="text-blue-700 font-bold">í™˜ë³€ë™ë³´í—˜ì˜ ì¥ì </span>
                        <div class="h-2"></div>
                        1. ì¤‘ì†Œê¸°ì—… ìš°ëŒ€ í˜œíƒ<br>
                        2. ì„œë¥˜ ìë™ ì‘ì„± ì§€ì›
                        <div class="h-2"></div>
                        ê³ ê°ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í™˜ë¦¬ìŠ¤í¬ ë³´í—˜ ì‹ ì²­ë¶€í„° ì§„í–‰ìƒí™©ê¹Œì§€ ìë™ ê´€ë¦¬í•©ë‹ˆë‹¤.
                        <div class="h-2"></div>
                        <span class="text-green-600 font-bold">ì •ë¶€ì§€ì› ì‹œ ë¬´ë£Œ ë˜ëŠ” ì´ˆì €ë¹„ìš© ì œê³µ</span>
                    </div>
                    <button class="mt-auto bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700">ë¬´ì—­ë³´í—˜ê³µì‚¬</button>
                </div>
            </div>
        </main>
            <!-- ì•ˆë‚´/ì„¤ëª… ëª¨ë‹¬ ì‚½ì… -->
            <div id="modal-guide" class="modal-guide">
                <button id="modal-guide-close" class="modal-close" title="ë‹«ê¸°">Ã—</button>
                <div class="modal-title">ì•ˆë‚´</div>
                <div class="modal-content">ì—¬ê¸°ì— ì•ˆë‚´ë¬¸ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
    </div>

    <script>
    function simulateForward() {
        var amount = document.getElementById('amount1').value || 0;
        var date = document.getElementById('paymentDate1').value;
        var today = new Date('2026-01-30');
        var paymentDate = new Date(date);
        var months = Math.ceil((paymentDate - today) / (1000 * 60 * 60 * 24 * 30));
        var period = '12ê°œì›”';
        if (months <= 6) period = '6ê°œì›”';
        var rate = 1325;
        var contracts = Math.ceil(amount / 1000);
        var total = amount * rate;
        var result = 'ì„ ë¬¼í™˜ ê³„ì•½ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼:<br>í—¤ì§€ ê¸ˆì•¡: ' + amount + ' USD<br>ê²°ì œì¼: ' + date + '<br>ê¸°ê°„: ' + period + '<br>í•„ìš” ê³„ì•½ ìˆ˜: ' + contracts + 'ê³„ì•½<br>ì˜ˆìƒ í™˜ìœ¨: ' + rate + ' KRW/USD<br>ì´ KRW: ' + total.toLocaleString();
        document.getElementById('result1').innerHTML = result;
    }
    
    function simulateFutures() {
        var amount = document.getElementById('amount2').value || 0;
        var date = document.getElementById('paymentDate2').value;
        var contracts = Math.floor(amount / 100000);
        var price = document.getElementById('price2').value || 0;
        var total = contracts * price;
        var result = 'ë‹¬ëŸ¬ì„ ë¬¼ ê±°ë˜ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼:<br>í—¤ì§€ ê¸ˆì•¡: ' + amount + ' USD<br>ê²°ì œì¼: ' + date + '<br>ê³„ì•½ ìˆ˜ëŸ‰: ' + contracts + '<br>ê°€ê²©: ' + price + ' KRW<br>ì´ ê¸ˆì•¡: ' + total.toLocaleString() + ' KRW';
        document.getElementById('result2').innerHTML = result;
    }
    
    function simulateInsurance() {
        var amount = document.getElementById('amount3').value || 0;
        var coverage = document.getElementById('coverage3').value;
        var premium = amount * 0.005;
        var result = 'í™˜ë³€ë™ë³´í—˜ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼:<br>ë³´í—˜ ê¸ˆì•¡: ' + amount + ' USD<br>ì»¤ë²„ë¦¬ì§€: ' + coverage + '<br>ì˜ˆìƒ í”„ë¦¬ë¯¸ì—„: ' + premium.toFixed(2) + ' USD';
        document.getElementById('result3').innerHTML = result;
    }
    
    let selectedTradeId = null;
    function selectTrade(id, amount, date) {
        if (selectedTradeId) {
            var prevRow = document.getElementById('row-' + selectedTradeId);
            if (prevRow) prevRow.classList.remove('bg-blue-100');
        }
        selectedTradeId = id;
        var row = document.getElementById('row-' + id);
        if (row) row.classList.add('bg-blue-100');
        
        document.getElementById('amount1').value = amount;
        document.getElementById('paymentDate1').value = date;
        document.getElementById('amount2').value = amount;
        document.getElementById('paymentDate2').value = date;
        document.getElementById('amount3').value = amount;
        
        document.getElementById('result1').innerHTML = '';
        document.getElementById('result2').innerHTML = '';
        document.getElementById('result3').innerHTML = '';
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ (ìƒˆë¡œê³ ì¹¨ ì‹œì—ë„ ìœ ì§€)
    function loadDataFromSession() {
        console.log('ğŸ” localStorageì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„...');
        
        // 1. ì—…ë¡œë“œëœ ì›ë³¸ ë°ì´í„° í™•ì¸ (localStorage ìš°ì„ )
        const uploadedDataStr = localStorage.getItem('uploadedData');
        if (uploadedDataStr) {
            try {
                const uploadedData = JSON.parse(uploadedDataStr);
                console.log('âœ… ì—…ë¡œë“œëœ ì›ë³¸ ë°ì´í„° ë°œê²¬:', uploadedData.length, 'ê±´');
                console.log('ğŸ“Š ë°ì´í„° ìƒ˜í”Œ:', uploadedData.slice(0, 3));
                
                // â˜… ì „ì²´ UI ë³µì› â˜…
                // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ (ìš”ì•½ ì •ë³´)
                updateDashboardWithData(uploadedData);
                
                // ê±°ë˜ ëª©ë¡ í…Œì´ë¸”ì— ì§ì ‘ í‘œì‹œ
                updateTradeListTable(uploadedData);
                
                // ì§‘ê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                updateAggregationSummary(uploadedData);
                
                // KPI ì„¹ì…˜ ì—…ë°ì´íŠ¸
                updateKPISection(uploadedData);
                
                // ê°œë³„ í—¤ì§€ ì œì•ˆ ìƒì„±
                generateIndividualHedgeSuggestions(uploadedData);
                
                // í†µí•© í—¤ì§€ ì „ëµ ìë™ ê³„ì‚°
                generateIntegratedHedge();
                
                // í—¤ì§€ ê³„ì‚° ë²„íŠ¼ í™œì„±í™”
                const btn = document.getElementById('runHedgeAnalysisBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.classList.add('btn-ready-pulse');
                }
                
                // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                const clearBtn = document.getElementById('clearDataBtn');
                if (clearBtn) {
                    clearBtn.style.display = 'block';
                }
                
                // ì—…ë¡œë“œ ì‹œê°„ í‘œì‹œ
                const timestamp = localStorage.getItem('uploadedDataTimestamp');
                if (timestamp) {
                    const uploadTime = new Date(timestamp).toLocaleString('ko-KR');
                    console.log('â° ì—…ë¡œë“œ ì‹œê°„:', uploadTime);
                }
            } catch (e) {
                console.error('âŒ ì—…ë¡œë“œ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
            }
        } else {
            console.log('â„¹ï¸ localStorageì— ì €ì¥ëœ ì—…ë¡œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // 2. ì„œë²„ ë¶„ì„ ê²°ê³¼ í™•ì¸ (í—¤ì§€ ì „ëµìš©)
        const serverResultStr = localStorage.getItem('serverAnalysisResult');
        if (serverResultStr) {
            try {
                const serverResult = JSON.parse(serverResultStr);
                console.log('âœ… ì„œë²„ ë¶„ì„ ê²°ê³¼ ë°œê²¬');
                loadServerAnalysisResults(serverResult);
            } catch (e) {
                console.error('âŒ ì„œë²„ ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜:', e);
            }
        }
    }

    // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    function updateDashboardWithData(data) {
        if (!data || data.length === 0) {
            console.warn('âš ï¸ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘:', data.length, 'ê±´');
        
        // í†µí™”ë³„ ì§‘ê³„
        const summary = {};
        data.forEach(item => {
            if (!summary[item.currency]) {
                summary[item.currency] = { receivable: 0, payable: 0 };
            }
            if (item.type === 'receivable') {
                summary[item.currency].receivable += item.amount;
            } else if (item.type === 'payable') {
                summary[item.currency].payable += item.amount;
            }
        });

        console.log('í†µí™”ë³„ ìš”ì•½:', summary);

        // KPI ì—…ë°ì´íŠ¸ (ì˜ˆì‹œ)
        const totalExposure = Object.values(summary).reduce((sum, curr) => 
            sum + Math.abs(curr.receivable - curr.payable), 0
        );
        
        // í™”ë©´ ìƒë‹¨ ì•Œë¦¼ ì¶”ê°€
        const header = document.querySelector('header');
        
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        const existingStatus = header.querySelector('.bg-blue-50');
        if (existingStatus) {
            existingStatus.remove();
        }
        
        const statusDiv = document.createElement('div');
        statusDiv.className = 'bg-blue-50 border-b border-blue-200 px-8 py-2';
        statusDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="text-sm text-blue-800">
                    âœ… ì—…ë¡œë“œëœ ë°ì´í„°: <strong>${data.length}ê±´</strong>
                </span>
                <span class="text-sm text-blue-600">
                    í†µí™”: ${Object.keys(summary).join(', ')}
                </span>
            </div>
        `;
        header.insertBefore(statusDiv, header.firstChild);
    }

    // ê±°ë˜ ëª©ë¡ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateTradeListTable(uploadedData) {
        const tbody = document.getElementById('tradeListBody');
        if (!tbody) {
            console.error('âŒ tradeListBody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì—…ë¡œë“œëœ ì›ë³¸ ë°ì´í„° íŒŒì‹±
        let data = uploadedData;
        if (typeof uploadedData === 'string') {
            try {
                data = JSON.parse(uploadedData);
            } catch (e) {
                console.error('âŒ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
                return;
            }
        }

        if (!Array.isArray(data) || data.length === 0) {
            console.warn('âš ï¸ í‘œì‹œí•  ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-500">í‘œì‹œí•  ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        console.log(`ğŸ“Š ì—…ë¡œë“œëœ ë°ì´í„° ${data.length}ê±´ í‘œì‹œ ì‹œì‘`);
        
        // ê° í•­ëª©ì˜ ìƒì„¸ ì •ë³´ ë¡œê·¸
        data.forEach((item, idx) => {
            console.log(`  [${idx}] ID: ${item.id}, Entity: ${item.entity}, Currency: ${item.currency}, Amount: ${item.amount}, Date: ${item.date}, Type: ${item.type}`);
        });

        // í™˜ìœ¨ ì •ë³´
        const rates = {
            'USD': 1342.50,
            'EUR': 1450.20,
            'JPY': 9.50,
            'CNY': 185.35,
            'GBP': 1700.60
        };

        tbody.innerHTML = '';

        const today = new Date('2026-02-02'); // í˜„ì¬ ë‚ ì§œ

        data.forEach((item, index) => {
            // ë°ì´í„° ê²€ì¦
            if (!item.date) {
                console.warn(`âš ï¸ [${index}] ë‚ ì§œ ì •ë³´ ì—†ìŒ:`, item);
            }
            
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-blue-50 cursor-pointer transition';
            
            // ì›í™” í™˜ì‚°ì•¡ ê³„ì‚°
            const rate = rates[item.currency] || rates['USD'];
            const krwAmount = Math.round(item.amount * rate);

            // D-Day ê³„ì‚°
            const paymentDate = new Date(item.date);
            const diffTime = paymentDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const dDayText = diffDays > 0 ? `D-${diffDays}` : diffDays === 0 ? 'D-Day' : `D+${Math.abs(diffDays)}`;
            const dDayClass = diffDays <= 7 ? 'text-red-600 font-bold' : diffDays <= 30 ? 'text-orange-600' : 'text-gray-600';

            // êµ¬ë¶„ ìƒ‰ìƒ
            const typeClass = item.type === 'receivable' 
                ? 'bg-green-100 text-green-700' 
                : 'bg-red-100 text-red-700';
            
            const typeText = item.type === 'receivable' ? 'ì±„ê¶Œ(ë§¤ì¶œ)' : 'ì±„ë¬´(ë§¤ì…)';

            tr.innerHTML = `
                <td class="p-3">
                    <span class="font-bold text-blue-600">${item.id || `TR-${index + 1}`}</span>
                </td>
                <td class="p-3">
                    <div class="font-semibold text-gray-800">${item.entity || 'Unknown'}</div>
                </td>
                <td class="p-3">
                    <span class="font-bold text-lg text-blue-700">${item.currency}</span>
                </td>
                <td class="p-3">
                    <div class="font-bold text-gray-800">${item.amount.toLocaleString('ko-KR')}</div>
                </td>
                <td class="p-3">
                    <div class="font-mono text-gray-700">${item.date || '-'}</div>
                </td>
                <td class="p-3">
                    <span class="px-2 py-1 ${typeClass} rounded-full text-[10px] font-bold">
                        ${typeText}
                    </span>
                </td>
                <td class="p-3">
                    <div class="font-bold text-green-700">â‚©${krwAmount.toLocaleString('ko-KR')}</div>
                    <div class="text-[9px] text-gray-500">@ ${rate.toLocaleString('ko-KR')}</div>
                </td>
                <td class="p-3">
                    <span class="${dDayClass} font-mono text-sm">${dDayText}</span>
                </td>
                <td class="p-3">
                    <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-[10px] font-bold">
                        ë¯¸í—¤ì§€
                    </span>
                </td>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸
            tr.onclick = () => selectTradeFromData(item);
            
            tbody.appendChild(tr);
        });

        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        const countElement = document.getElementById('tradeCount');
        if (countElement) {
            countElement.textContent = `ì´ ${data.length}ê±´`;
            countElement.className = 'text-xs font-bold text-blue-600';
        }

        console.log(`âœ… ${data.length}ê±´ì˜ ê±°ë˜ê°€ í…Œì´ë¸”ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ì§‘ê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateAggregationSummary(data) {
        if (!data || data.length === 0) {
            console.warn('âš ï¸ ì§‘ê³„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        console.log('ğŸ“Š ì§‘ê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹œì‘...', data.length, 'ê±´');
        console.log('ë°ì´í„° ìƒ˜í”Œ:', data.slice(0, 3));

        // í†µí™”ë³„ ì§‘ê³„
        const byCurrency = {};
        let totalReceivable = 0;
        let totalPayable = 0;

        data.forEach(item => {
            const currency = item.currency || 'UNKNOWN';
            
            if (!byCurrency[currency]) {
                byCurrency[currency] = {
                    receivableCount: 0,
                    receivableAmount: 0,
                    payableCount: 0,
                    payableAmount: 0
                };
            }

            if (item.type === 'receivable') {
                byCurrency[currency].receivableCount++;
                byCurrency[currency].receivableAmount += item.amount;
                totalReceivable += item.amount;
            } else {
                byCurrency[currency].payableCount++;
                byCurrency[currency].payableAmount += item.amount;
                totalPayable += item.amount;
            }
        });

        const currencyCount = Object.keys(byCurrency).length;
        console.log(`í†µí™” ì¢…ë¥˜: ${currencyCount}ê°œ`, Object.keys(byCurrency));

        // KPI ì—…ë°ì´íŠ¸
        // ì–µì› ë‹¨ìœ„ë¡œ í‘œì‹œ (í™˜ìœ¨ 1350ì› ê¸°ì¤€)
        const exchangeRate = 1350;
        const toEokWon = (usdAmount) => ((usdAmount * exchangeRate) / 100000000).toFixed(1);
        
        document.getElementById('aggTotalCount').textContent = `${data.length}ê±´`;
        document.getElementById('aggCurrencyCount').textContent = `${currencyCount}ê°œ`;
        document.getElementById('aggTotalReceivable').textContent = `${toEokWon(totalReceivable)}ì–µì›`;
        document.getElementById('aggTotalPayable').textContent = `${toEokWon(totalPayable)}ì–µì›`;
        
        const netExposure = totalReceivable - totalPayable;
        const netEl = document.getElementById('aggNetExposure');
        netEl.textContent = `${toEokWon(Math.abs(netExposure))}ì–µì›`;
        netEl.className = `text-2xl font-bold ${netExposure >= 0 ? 'text-green-600' : 'text-red-600'}`;

        // í†µí™”ë³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        const tbody = document.getElementById('aggTableBody');
        tbody.innerHTML = '';

        Object.keys(byCurrency).forEach(currency => {
            const data = byCurrency[currency];
            const netAmount = data.receivableAmount - data.payableAmount;
            const nettingPotential = Math.min(data.receivableAmount, data.payableAmount);
            const nettingRatio = nettingPotential > 0 
                ? ((nettingPotential / Math.max(data.receivableAmount, data.payableAmount)) * 100).toFixed(1)
                : 0;

            const tr = document.createElement('tr');
            tr.className = 'border-t hover:bg-blue-50';
            tr.innerHTML = `
                <td class="p-3">
                    <span class="font-bold text-lg text-blue-600">${currency}</span>
                </td>
                <td class="p-3 text-right text-gray-600">${data.receivableCount}ê±´</td>
                <td class="p-3 text-right font-bold text-green-600">${data.receivableAmount.toLocaleString()}</td>
                <td class="p-3 text-right text-gray-600">${data.payableCount}ê±´</td>
                <td class="p-3 text-right font-bold text-red-600">${data.payableAmount.toLocaleString()}</td>
                <td class="p-3 text-right font-bold ${netAmount >= 0 ? 'text-green-600' : 'text-red-600'}">
                    ${netAmount >= 0 ? '+' : ''}${netAmount.toLocaleString()}
                </td>
                <td class="p-3 text-right">
                    <div class="flex items-center justify-end gap-2">
                        <div class="w-20 bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${nettingRatio}%"></div>
                        </div>
                        <span class="text-xs font-bold text-gray-700">${nettingRatio}%</span>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        console.log('âœ… ì§‘ê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }

    // ë°ì´í„°ì—ì„œ ê±°ë˜ ì„ íƒ
    function selectTradeFromData(item) {
        console.log('ê±°ë˜ ì„ íƒ:', item);
        
        // ì„ ë¬¼í™˜ ì‹œë®¬ë ˆì´í„°ì— ìë™ ì…ë ¥
        const amount1 = document.getElementById('amount1');
        const paymentDate1 = document.getElementById('paymentDate1');
        
        if (amount1) amount1.value = item.amount;
        if (paymentDate1) paymentDate1.value = item.date;

        // ì„ íƒ í‘œì‹œ
        alert(
            `ê±°ë˜ ì„ íƒë¨\n\n` +
            `ê±°ë˜ì²˜: ${item.entity}\n` +
            `í†µí™”: ${item.currency}\n` +
            `ê¸ˆì•¡: ${item.amount.toLocaleString('ko-KR')}\n` +
            `ì¼ì: ${item.date}\n` +
            `êµ¬ë¶„: ${item.type === 'receivable' ? 'ì±„ê¶Œ' : 'ì±„ë¬´'}\n\n` +
            `í•˜ë‹¨ í—¤ì§€ ì‹œë®¬ë ˆì´í„°ì— ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`
        );

        // í—¤ì§€ ì‹œë®¬ë ˆì´í„° ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        const simulator = document.querySelector('.grid.grid-cols-3');
        if (simulator) {
            simulator.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // ë‚´ë¶€í—¤ì§€ ë„¤íŒ… ë¶„ì„
    function performInternalHedgeNetting(data) {
        console.log('ğŸ”„ ë‚´ë¶€í—¤ì§€ ë¶„ì„ ì‹œì‘...');
        
        const result = {
            nettedPairs: [],           // ìƒê³„ ì²˜ë¦¬ëœ ìŒ
            remainingExposure: [],     // ì”ì—¬ ë…¸ì¶œ
            totalNettedAmount: 0,      // ì´ ìƒê³„ ê¸ˆì•¡
            byCurrency: {}             // í†µí™”ë³„ ì§‘ê³„
        };
        
        // í†µí™”ë³„ ê·¸ë£¹í•‘
        const groupedByCurrency = {};
        data.forEach(item => {
            if (!groupedByCurrency[item.currency]) {
                groupedByCurrency[item.currency] = { receivables: [], payables: [] };
            }
            if (item.type === 'receivable') {
                groupedByCurrency[item.currency].receivables.push(item);
            } else {
                groupedByCurrency[item.currency].payables.push(item);
            }
        });
        
        // ê° í†µí™”ë³„ë¡œ ìƒê³„ ì²˜ë¦¬
        Object.keys(groupedByCurrency).forEach(currency => {
            const { receivables, payables } = groupedByCurrency[currency];
            
            console.log(`\nğŸ’± ${currency} ë¶„ì„:`);
            console.log(`  ì±„ê¶Œ: ${receivables.length}ê±´, ì´ ${receivables.reduce((sum, r) => sum + r.amount, 0).toLocaleString()}`);
            console.log(`  ì±„ë¬´: ${payables.length}ê±´, ì´ ${payables.reduce((sum, p) => sum + p.amount, 0).toLocaleString()}`);
            
            const used = new Set();
            
            // ë‚ ì§œì™€ ê¸ˆì•¡ ìœ ì‚¬ë„ ê¸°ë°˜ ë§¤ì¹­
            receivables.forEach(rcv => {
                payables.forEach(pay => {
                    if (used.has(pay.id)) return;
                    
                    // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ì¼ ë‹¨ìœ„)
                    const dateDiff = Math.abs(
                        (new Date(rcv.date) - new Date(pay.date)) / (1000 * 60 * 60 * 24)
                    );
                    
                    // ê¸ˆì•¡ ë¹„ìœ¨
                    const amountRatio = Math.min(rcv.amount, pay.amount) / Math.max(rcv.amount, pay.amount);
                    
                    // ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°
                    // - ë‚ ì§œ 30ì¼ ì´ë‚´: ë†’ì€ ì ìˆ˜
                    // - ê¸ˆì•¡ 70% ì´ìƒ ìœ ì‚¬: ë†’ì€ ì ìˆ˜
                    const dateScore = dateDiff <= 7 ? 100 : dateDiff <= 30 ? 50 : dateDiff <= 60 ? 20 : 0;
                    const amountScore = amountRatio * 100;
                    const matchScore = (dateScore * 0.4) + (amountScore * 0.6);
                    
                    // ë§¤ì¹­ ì„ê³„ê°’: 50ì  ì´ìƒ
                    if (matchScore >= 50) {
                        const nettedAmount = Math.min(rcv.amount, pay.amount);
                        
                        result.nettedPairs.push({
                            receivable: rcv,
                            payable: pay,
                            nettedAmount,
                            dateDiff,
                            matchScore: matchScore.toFixed(1),
                            currency
                        });
                        
                        result.totalNettedAmount += nettedAmount;
                        used.add(pay.id);
                        
                        console.log(`  âœ… ë§¤ì¹­: ${rcv.id} â†” ${pay.id} (${nettedAmount.toLocaleString()}, ì ìˆ˜: ${matchScore.toFixed(1)}, ë‚ ì§œì°¨: ${dateDiff}ì¼)`);
                    }
                });
            });
            
            // í†µí™”ë³„ ì§‘ê³„
            const totalReceivable = receivables.reduce((sum, r) => sum + r.amount, 0);
            const totalPayable = payables.reduce((sum, p) => sum + p.amount, 0);
            const netted = result.nettedPairs
                .filter(pair => pair.currency === currency)
                .reduce((sum, pair) => sum + pair.nettedAmount, 0);
            
            result.byCurrency[currency] = {
                totalReceivable,
                totalPayable,
                netted,
                netExposure: totalReceivable - totalPayable,
                remainingExposure: Math.abs(totalReceivable - totalPayable) - netted
            };
        });
        
        // ì”ì—¬ ë…¸ì¶œ ê³„ì‚°
        const nettedIds = new Set();
        result.nettedPairs.forEach(pair => {
            nettedIds.add(pair.receivable.id);
            nettedIds.add(pair.payable.id);
        });
        
        result.remainingExposure = data.filter(item => !nettedIds.has(item.id));
        
        console.log('\nğŸ“Š ë‚´ë¶€í—¤ì§€ ë¶„ì„ ì™„ë£Œ:');
        console.log(`  ì´ ìƒê³„: ${result.nettedPairs.length}ìŒ`);
        console.log(`  ìƒê³„ ê¸ˆì•¡: ${result.totalNettedAmount.toLocaleString()}`);
        console.log(`  ì”ì—¬ ë…¸ì¶œ: ${result.remainingExposure.length}ê±´`);
        
        return result;
    }

    // ë‚´ë¶€í—¤ì§€ ê²°ê³¼ í‘œì‹œ
    function displayNettingResults(nettingResult) {
        // ìƒë‹¨ KPI ì—…ë°ì´íŠ¸
        const nettingSection = document.createElement('section');
        nettingSection.className = 'bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg border-l-4 border-green-500';
        nettingSection.innerHTML = `
            <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ”„ ë‚´ë¶€í—¤ì§€ (ìì—°í—¤ì§€) ë¶„ì„ ê²°ê³¼</h3>
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 mb-1">ìƒê³„ ì²˜ë¦¬</div>
                    <div class="text-2xl font-bold text-green-600">${nettingResult.nettedPairs.length}ìŒ</div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 mb-1">ìì—°í—¤ì§€ ê¸ˆì•¡</div>
                    <div class="text-2xl font-bold text-blue-600">${((nettingResult.totalNettedAmount * 1350) / 100000000).toFixed(1)}ì–µì›</div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 mb-1">ì”ì—¬ ë…¸ì¶œ</div>
                    <div class="text-2xl font-bold text-orange-600">${nettingResult.remainingExposure.length}ê±´</div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm">
                    <div class="text-xs text-gray-500 mb-1">í—¤ì§€ íš¨ìœ¨</div>
                    <div class="text-2xl font-bold text-green-600">${((nettingResult.nettedPairs.length / (nettingResult.nettedPairs.length + nettingResult.remainingExposure.length)) * 100).toFixed(1)}%</div>
                </div>
            </div>
            
            <div class="mt-6">
                <h4 class="text-sm font-bold text-gray-700 mb-3">í†µí™”ë³„ ìƒê³„ í˜„í™©</h4>
                <div class="bg-white rounded-lg overflow-hidden">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">í†µí™”</th>
                                <th class="p-3 text-right">ì´ ì±„ê¶Œ</th>
                                <th class="p-3 text-right">ì´ ì±„ë¬´</th>
                                <th class="p-3 text-right">ìƒê³„ ê¸ˆì•¡</th>
                                <th class="p-3 text-right">ìˆœë…¸ì¶œ</th>
                                <th class="p-3 text-right">ì”ì—¬ ë…¸ì¶œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(nettingResult.byCurrency).map(currency => {
                                const data = nettingResult.byCurrency[currency];
                                return `
                                    <tr class="border-t">
                                        <td class="p-3 font-bold text-blue-600">${currency}</td>
                                        <td class="p-3 text-right text-green-600">${data.totalReceivable.toLocaleString()}</td>
                                        <td class="p-3 text-right text-red-600">${data.totalPayable.toLocaleString()}</td>
                                        <td class="p-3 text-right font-bold text-blue-600">${data.netted.toLocaleString()}</td>
                                        <td class="p-3 text-right ${data.netExposure >= 0 ? 'text-green-600' : 'text-red-600'}">${data.netExposure.toLocaleString()}</td>
                                        <td class="p-3 text-right font-bold text-orange-600">${data.remainingExposure.toLocaleString()}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            ${nettingResult.nettedPairs.length > 0 ? `
                <div class="mt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3">ìƒê³„ ë§¤ì¹­ ìƒì„¸</h4>
                    <div class="bg-white rounded-lg p-4 max-h-60 overflow-y-auto">
                        ${nettingResult.nettedPairs.map(pair => `
                            <div class="flex items-center justify-between py-2 border-b last:border-b-0">
                                <div class="flex items-center gap-4">
                                    <span class="text-xs font-bold text-blue-600">${pair.receivable.id}</span>
                                    <span class="text-xs text-gray-400">â†”</span>
                                    <span class="text-xs font-bold text-red-600">${pair.payable.id}</span>
                                </div>
                                <div class="flex items-center gap-4 text-xs">
                                    <span class="text-gray-600">${pair.currency} ${pair.nettedAmount.toLocaleString()}</span>
                                    <span class="text-gray-500">ë‚ ì§œì°¨: ${pair.dateDiff}ì¼</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded font-bold">ì ìˆ˜: ${pair.matchScore}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        `;
        
        // KPI ì„¹ì…˜ ë‹¤ìŒì— ì‚½ì…
        const main = document.querySelector('main');
        const kpiSection = main.querySelector('section');
        kpiSection.after(nettingSection);
    }

    // í—¤ì§€ ê³„ì‚° ì‹¤í–‰ (ì„œë²„ ì „ì†¡)
    async function runHedgeAnalysis() {
        const uploadedDataStr = localStorage.getItem('uploadedData');
        if (!uploadedDataStr) {
            alert('âŒ ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.');
            return;
        }

        try {
            const uploadedData = JSON.parse(uploadedDataStr);
            
            // ë¡œë”© í‘œì‹œ
            const btn = document.getElementById('runHedgeAnalysisBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ ì²˜ë¦¬ ì¤‘...';
            btn.disabled = true;
            btn.classList.remove('animate-pulse');
            
            console.log('ğŸ” ë°ì´í„° ìµëª…í™” ì‹œì‘...');
            
            // 1ë‹¨ê³„: ë°ì´í„° ìµëª…í™”
            const anonymizedData = anonymizeTradeData(uploadedData);
            console.log('âœ… ìµëª…í™” ì™„ë£Œ:', anonymizedData.length, 'ê±´');
            
            // 2ë‹¨ê³„: ì„œë²„ë¡œ ì „ì†¡ (ë˜ëŠ” ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜)
            console.log('ğŸ“¡ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...');
            
            let analysisResult;
            try {
                // API í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©
                if (typeof api !== 'undefined' && api.runHedgeAnalysis) {
                    analysisResult = await api.runHedgeAnalysis(anonymizedData);
                    console.log('âœ… ì„œë²„ ë¶„ì„ ì™„ë£Œ');
                } else {
                    throw new Error('API ì—°ê²° ì‹¤íŒ¨');
                }
            } catch (apiError) {
                console.warn('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ë¡œì»¬ ë¶„ì„ìœ¼ë¡œ ì „í™˜:', apiError.message);
                
                // ë¡œì»¬ ë¶„ì„
                const nettingResult = performInternalHedgeNetting(uploadedData);
                
                analysisResult = {
                    success: true,
                    nettingResult,
                    timestamp: new Date().toISOString(),
                    mode: 'local'
                };
            }
            
            // 3ë‹¨ê³„: ê²°ê³¼ ì €ì¥ ë° í‘œì‹œ
            localStorage.setItem('nettingResult', JSON.stringify(analysisResult.nettingResult));
            
            // ë‚´ë¶€í—¤ì§€ ê²°ê³¼ í‘œì‹œ
            displayNettingResults(analysisResult.nettingResult);
            
            // â˜… ì”ì—¬ ë…¸ì¶œ(ë‚´ë¶€í—¤ì§€ ì œì™¸)ë¡œ ê°œë³„ í—¤ì§€ ì œì•ˆ ê°±ì‹  â˜…
            const remainingExposure = analysisResult.nettingResult.remainingExposure || [];
            if (remainingExposure.length > 0) {
                console.log('ğŸ“‹ ì”ì—¬ ë…¸ì¶œë¡œ ê°œë³„ í—¤ì§€ ì œì•ˆ ê°±ì‹ :', remainingExposure.length, 'ê±´');
                generateIndividualHedgeSuggestions(remainingExposure);
            } else {
                // ì”ì—¬ ë…¸ì¶œì´ ì—†ìœ¼ë©´ ì „ì²´ ë°ì´í„°ë¡œ í‘œì‹œ
                generateIndividualHedgeSuggestions(uploadedData);
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            btn.disabled = true;
            btn.classList.remove('btn-ready-pulse');
            btn.innerHTML = 'âœ… ë¶„ì„ ì™„ë£Œ';
            
            // ì™„ë£Œ ì•Œë¦¼
            const netting = analysisResult.nettingResult;
            const nettingAmountEok = ((netting.totalNettedAmount * 1350) / 100000000).toFixed(1);
            alert(
                `âœ… í—¤ì§€ ë¶„ì„ ì™„ë£Œ!\n\n` +
                `ğŸ“Š ë‚´ë¶€í—¤ì§€ (ìì—°í—¤ì§€):\n` +
                `- ìƒê³„ ì²˜ë¦¬: ${netting.nettedPairs.length}ìŒ\n` +
                `- ìì—°í—¤ì§€ ê¸ˆì•¡: ${nettingAmountEok}ì–µì›\n` +
                `- ì”ì—¬ ë…¸ì¶œ: ${netting.remainingExposure.length}ê±´\n\n` +
                `${analysisResult.mode === 'local' ? 'âš ï¸ ë¡œì»¬ ë¶„ì„ ëª¨ë“œ' : 'âœ… ì„œë²„ ë¶„ì„ ì™„ë£Œ'}`
            );
            
        } catch (error) {
            console.error('âŒ í—¤ì§€ ë¶„ì„ ì˜¤ë¥˜:', error);
            alert('í—¤ì§€ ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
            
            // ë²„íŠ¼ ë³µì›
            const btn = document.getElementById('runHedgeAnalysisBtn');
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.classList.add('btn-ready-pulse');
        }
    }

    // ê±°ë˜ ë°ì´í„° ìµëª…í™” (í•˜ì´ë¸Œë¦¬ë“œ ë³´ì•ˆ: ì„œë²„ë¡œëŠ” ìˆ«ìë§Œ ì „ì†¡)
    // â˜… ê³ ê° ì •ë³´ ì¼ì²´ ì „ì†¡ ì•ˆë¨ - ì˜¤ì§ ê³„ì‚°ì— í•„ìš”í•œ ìˆ«ìë§Œ ì „ì†¡ â˜…
    function anonymizeTradeData(data) {
        console.log('ğŸ”’ ìµëª…í™” ì‹œì‘: ê³ ê° ì •ë³´ ì œê±° ì¤‘...');
        
        return data.map((row, index) => {
            // â˜… ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” ë°ì´í„°: ì˜¤ì§ ìˆ«ì/ì½”ë“œë§Œ â˜…
            return {
                // ì‹ë³„ ë¶ˆê°€ëŠ¥í•œ ì‹œí€€ìŠ¤ ID
                seq: index + 1,
                
                // í†µí™” ì½”ë“œ (USD, EUR ë“± - í‘œì¤€ ì½”ë“œ)
                ccy: row.currency,
                
                // ê¸ˆì•¡ (ìˆ«ìë§Œ)
                amt: parseFloat(row.amount) || 0,
                
                // ë§Œê¸°ì¼ (ì¼ìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ íŠ¹ì • ë‚ ì§œ ë…¸ì¶œ ë°©ì§€)
                daysToMaturity: calculateDaysToMaturity(row.date),
                
                // ìœ í˜• ì½”ë“œ (R=receivable, P=payable)
                dir: row.type === 'receivable' ? 'R' : 'P'
                
                // âŒ ì œì™¸ í•­ëª© (ì„œë²„ë¡œ ì „ì†¡ ì•ˆë¨):
                // - ê±°ë˜ì²˜ëª… (entity)
                // - ì›ë³¸ ID
                // - ì›ë³¸ ë‚ ì§œ
                // - ê³ ê° ê´€ë ¨ ëª¨ë“  ì •ë³´
            };
        });
    }

    // ë§Œê¸°ì¼ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
    function calculateDaysToMaturity(dateStr) {
        if (!dateStr) return 90; // ê¸°ë³¸ê°’
        
        try {
            const maturityDate = new Date(dateStr);
            const today = new Date();
            const diffTime = maturityDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        } catch (e) {
            return 90; // íŒŒì‹± ì‹¤íŒ¨ì‹œ ê¸°ë³¸ê°’
        }
    }

    // ë¬¸ìì—´ í•´ì‹œ í•¨ìˆ˜ (ë¡œì»¬ í‘œì‹œìš©)
    function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return Math.abs(hash).toString(36).toUpperCase();
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // í†µí•© í—¤ì§€ ì „ëµ (í˜¼í•© í—¤ì§€) ê´€ë ¨ í•¨ìˆ˜
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    // ì „ì—­ í†µí•© í—¤ì§€ ë°ì´í„°
    let integratedHedgeData = {
        totalCount: 0,
        totalReceivable: 0,  // USD
        totalPayable: 0,     // USD
        netExposure: 0,      // USD
        hedgeRatio: 70,      // ê¸°ë³¸ 70% í—¤ì§€
        forwardRatio: 60,    // ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜ ë¹„ìœ¨
        futuresRatio: 40     // ë‹¬ëŸ¬ì„ ë¬¼ ë¹„ìœ¨
    };
    
    // í†µí•© í—¤ì§€ ì „ëµ ê³„ì‚°
    function generateIntegratedHedge() {
        const uploadedData = localStorage.getItem('uploadedData');
        if (!uploadedData) {
            alert('ğŸ“‹ ë¨¼ì € ê±°ë˜ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const data = JSON.parse(uploadedData);
        console.log('ğŸ¯ í†µí•© í—¤ì§€ ì „ëµ ê³„ì‚° ì‹œì‘...', data.length, 'ê±´');
        
        const rates = {
            'USD': 1, 'EUR': 1.10, 'JPY': 0.0075, 'CNY': 0.14,
            'GBP': 1.28, 'AUD': 0.66, 'CAD': 0.74, 'CHF': 1.14
        };
        
        // USD í™˜ì‚° ì§‘ê³„
        let totalReceivable = 0;
        let totalPayable = 0;
        
        data.forEach(row => {
            const rate = rates[row.currency] || 1;
            const amtUSD = (parseFloat(row.amount) || 0) * rate;
            
            if (row.type === 'receivable') {
                totalReceivable += amtUSD;
            } else {
                totalPayable += amtUSD;
            }
        });
        
        const netExposure = totalReceivable - totalPayable;
        
        // ì „ì—­ ë°ì´í„° ì—…ë°ì´íŠ¸
        integratedHedgeData = {
            ...integratedHedgeData,
            totalCount: data.length,
            totalReceivable: totalReceivable,
            totalPayable: totalPayable,
            netExposure: Math.abs(netExposure)
        };
        
        // UI ì—…ë°ì´íŠ¸
        updateIntegratedHedgeUI();
        updateHedgeStrategy();
        
        // ì „ëµ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        updateIntegratedHedgeTable();
        
        console.log('âœ… í†µí•© í—¤ì§€ ì „ëµ ê³„ì‚° ì™„ë£Œ:', integratedHedgeData);
    }
    
    // í†µí•© í—¤ì§€ UI ì—…ë°ì´íŠ¸
    function updateIntegratedHedgeUI() {
        const d = integratedHedgeData;
        const USDKRW = 1350;
        
        // ì „ì²´ ë…¸ì¶œ í˜„í™©
        document.getElementById('integratedTotalCount').textContent = d.totalCount.toLocaleString() + 'ê±´';
        document.getElementById('integratedReceivable').textContent = '$' + Math.round(d.totalReceivable).toLocaleString();
        document.getElementById('integratedPayable').textContent = '$' + Math.round(d.totalPayable).toLocaleString();
        document.getElementById('integratedNetExposure').textContent = '$' + Math.round(d.netExposure).toLocaleString();
        document.getElementById('integratedNetKRW').textContent = (d.netExposure * USDKRW / 100000000).toFixed(1) + 'ì–µì›';
        document.getElementById('integratedDataStatus').textContent = 'ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
    }
    
    // í—¤ì§€ ì „ëµ ë¹„ìœ¨ ì—…ë°ì´íŠ¸ (ìŠ¬ë¼ì´ë”)
    function updateHedgeStrategy() {
        const hedgeRatio = parseInt(document.getElementById('hedgeRatioSlider').value);
        const d = integratedHedgeData;
        const USDKRW = 1350;
        
        // ì „ì²´ í—¤ì§€ ë¹„ìœ¨ ì—…ë°ì´íŠ¸
        d.hedgeRatio = hedgeRatio;
        document.getElementById('totalHedgeRatio').textContent = hedgeRatio + '%';
        
        // í—¤ì§€ ê¸ˆì•¡ ê³„ì‚°
        const totalHedgeAmount = d.netExposure * (hedgeRatio / 100);
        
        // ì„ ë¬¼í™˜ 60% / ë‹¬ëŸ¬ì„ ë¬¼ 40% ë°°ë¶„ (ê¸°ë³¸ ì „ëµ)
        const forwardAmount = totalHedgeAmount * (d.forwardRatio / 100);
        const futuresAmount = totalHedgeAmount * (d.futuresRatio / 100);
        const unhedgedAmount = d.netExposure - totalHedgeAmount;
        
        // ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜ ì—…ë°ì´íŠ¸
        document.getElementById('forwardRatio').textContent = Math.round(hedgeRatio * d.forwardRatio / 100) + '%';
        document.getElementById('forwardAmount').textContent = '$' + Math.round(forwardAmount).toLocaleString();
        document.getElementById('forwardAmountKRW').textContent = (forwardAmount * USDKRW / 100000000).toFixed(1) + 'ì–µì›';
        document.getElementById('forwardBar').style.width = (d.forwardRatio) + '%';
        
        // ë‹¬ëŸ¬ì„ ë¬¼ ì—…ë°ì´íŠ¸
        const contractSize = 10000; // CME ë¯¸ë‹ˆ ë‹¬ëŸ¬ì„ ë¬¼ 1ê³„ì•½ = $10,000
        const futuresContracts = Math.round(futuresAmount / contractSize);
        
        document.getElementById('futuresRatio').textContent = Math.round(hedgeRatio * d.futuresRatio / 100) + '%';
        document.getElementById('futuresAmount').textContent = '$' + Math.round(futuresAmount).toLocaleString();
        document.getElementById('futuresAmountKRW').textContent = (futuresAmount * USDKRW / 100000000).toFixed(1) + 'ì–µì›';
        document.getElementById('futuresContracts').textContent = futuresContracts.toLocaleString() + 'ê³„ì•½';
        document.getElementById('futuresBar').style.width = (d.futuresRatio) + '%';
        
        // ë¯¸í—¤ì§€ ì”ì—¬ë¶„
        document.getElementById('unhedgedRatio').textContent = (100 - hedgeRatio) + '%';
        document.getElementById('unhedgedAmount').textContent = 
            '$' + Math.round(unhedgedAmount).toLocaleString() + 
            ' (' + (unhedgedAmount * USDKRW / 100000000).toFixed(1) + 'ì–µì›)';
        
        // ë¯¸í—¤ì§€ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
        const unhedgedSection = document.getElementById('unhedgedSection');
        if (hedgeRatio >= 100) {
            unhedgedSection.style.display = 'none';
        } else {
            unhedgedSection.style.display = 'flex';
        }
    }
    
    // í†µí•© í—¤ì§€ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateIntegratedHedgeTable() {
        const d = integratedHedgeData;
        const USDKRW = 1350;
        const hedgeRatio = d.hedgeRatio / 100;
        const totalHedge = d.netExposure * hedgeRatio;
        const forwardAmt = totalHedge * (d.forwardRatio / 100);
        const futuresAmt = totalHedge * (d.futuresRatio / 100);
        
        const tbody = document.getElementById('integratedHedgeBody');
        
        if (d.netExposure <= 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="p-6 text-center text-gray-400">
                        <div class="text-3xl mb-2">ğŸ”—</div>
                        <p>ë°ì´í„° ì—…ë¡œë“œ í›„ 'ì „ëµ ê³„ì‚°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´</p>
                        <p class="text-xs mt-1">ìµœì ì˜ í˜¼í•© í—¤ì§€ ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        const direction = d.totalReceivable > d.totalPayable ? 'ë§¤ë„ (Sell)' : 'ë§¤ìˆ˜ (Buy)';
        const dirClass = d.totalReceivable > d.totalPayable ? 'text-red-600' : 'text-blue-600';
        
        tbody.innerHTML = `
            <tr class="bg-blue-50 hover:bg-blue-100">
                <td class="p-3">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ğŸ¦</span>
                        <span class="font-bold text-blue-800">ì„ ë¬¼í™˜ / í™˜ë³€ë™ë³´í—˜</span>
                    </div>
                </td>
                <td class="p-3 text-right font-bold">${d.forwardRatio}%</td>
                <td class="p-3 text-right font-bold text-blue-700">$${Math.round(forwardAmt).toLocaleString()}</td>
                <td class="p-3 text-right">${(forwardAmt * USDKRW / 100000000).toFixed(1)}ì–µì›</td>
                <td class="p-3">
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-[10px]">3ê°œì›” ì„ ë¬¼í™˜</span>
                </td>
                <td class="p-3 text-xs text-gray-500">í™•ì • ê²°ì œì¼ ë§¤ì¹­ìš©<br>ì£¼ë ¥ í—¤ì§€ ìˆ˜ë‹¨</td>
                <td class="p-3 text-center">
                    <button onclick="executeForwardHedge()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">ì‹¤í–‰</button>
                </td>
            </tr>
            <tr class="bg-orange-50 hover:bg-orange-100">
                <td class="p-3">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ğŸ“ˆ</span>
                        <span class="font-bold text-orange-800">ë‹¬ëŸ¬ì„ ë¬¼ (KRX/CME)</span>
                    </div>
                </td>
                <td class="p-3 text-right font-bold">${d.futuresRatio}%</td>
                <td class="p-3 text-right font-bold text-orange-700">$${Math.round(futuresAmt).toLocaleString()}</td>
                <td class="p-3 text-right">${(futuresAmt * USDKRW / 100000000).toFixed(1)}ì–µì›</td>
                <td class="p-3">
                    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-[10px]">${Math.round(futuresAmt / 10000)}ê³„ì•½</span>
                </td>
                <td class="p-3 text-xs text-gray-500">ìœ ë™ì  ê²°ì œì¼ ëŒ€ì‘<br>ë¡¤ì˜¤ë²„ ê°€ëŠ¥</td>
                <td class="p-3 text-center">
                    <button onclick="executeFuturesHedge()" class="px-3 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">ì‹¤í–‰</button>
                </td>
            </tr>
            <tr class="bg-gray-50 font-bold border-t-2 border-purple-300">
                <td class="p-3">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ğŸ¯</span>
                        <span class="text-purple-800">í•©ê³„ (ì´ í—¤ì§€)</span>
                    </div>
                </td>
                <td class="p-3 text-right text-purple-700">${d.hedgeRatio}%</td>
                <td class="p-3 text-right text-purple-700">$${Math.round(totalHedge).toLocaleString()}</td>
                <td class="p-3 text-right text-purple-700">${(totalHedge * USDKRW / 100000000).toFixed(1)}ì–µì›</td>
                <td class="p-3">
                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-[10px]">í˜¼í•© ì „ëµ</span>
                </td>
                <td class="p-3 text-xs text-purple-600">ì„ ë¬¼í™˜ ${d.forwardRatio}% + ì„ ë¬¼ ${d.futuresRatio}%</td>
                <td class="p-3 text-center">
                    <button onclick="executeIntegratedHedge()" class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 font-bold">ì „ì²´ ì‹¤í–‰</button>
                </td>
            </tr>
        `;
    }
    
    // ì„ ë¬¼í™˜ í—¤ì§€ ì‹¤í–‰
    function executeForwardHedge() {
        alert('ğŸ¦ ì„ ë¬¼í™˜ / í™˜ë³€ë™ë³´í—˜ í—¤ì§€ ì‹¤í–‰\n\nì€í–‰ì— ì„ ë¬¼í™˜ ê³„ì•½ ìš”ì²­ì´ ì „ì†¡ë©ë‹ˆë‹¤.\n(ì‹œë®¬ë ˆì´ì…˜)');
    }
    
    // ë‹¬ëŸ¬ì„ ë¬¼ í—¤ì§€ ì‹¤í–‰
    function executeFuturesHedge() {
        const contracts = document.getElementById('futuresContracts').textContent;
        alert('ğŸ“ˆ ë‹¬ëŸ¬ì„ ë¬¼ í—¤ì§€ ì‹¤í–‰\n\n' + contracts + ' ë§¤ë„ ì£¼ë¬¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.\n(ì‹œë®¬ë ˆì´ì…˜)');
    }
    
    // í†µí•© í—¤ì§€ ì „ì²´ ì‹¤í–‰
    function executeIntegratedHedge() {
        if (integratedHedgeData.netExposure <= 0) {
            alert('ğŸ“‹ ë¨¼ì € í†µí•© í—¤ì§€ ì „ëµì„ ê³„ì‚°í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const d = integratedHedgeData;
        const USDKRW = 1350;
        const totalHedge = d.netExposure * (d.hedgeRatio / 100);
        const forwardAmt = totalHedge * (d.forwardRatio / 100);
        const futuresAmt = totalHedge * (d.futuresRatio / 100);
        
        const msg = `ğŸ¯ í†µí•© í—¤ì§€ ì „ëµ ì‹¤í–‰ í™•ì¸

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ìˆœ ë…¸ì¶œ: $${Math.round(d.netExposure).toLocaleString()} (${(d.netExposure * USDKRW / 100000000).toFixed(1)}ì–µì›)
ğŸ¯ í—¤ì§€ ë¹„ìœ¨: ${d.hedgeRatio}%

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¦ ì„ ë¬¼í™˜/í™˜ë³€ë™ë³´í—˜: $${Math.round(forwardAmt).toLocaleString()} (${d.forwardRatio}%)
ğŸ“ˆ ë‹¬ëŸ¬ì„ ë¬¼: $${Math.round(futuresAmt).toLocaleString()} (${d.futuresRatio}%)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        
        if (confirm(msg)) {
            alert('âœ… í†µí•© í—¤ì§€ ì „ëµì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n(ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œëŠ” ì€í–‰ API ë° ì„ ë¬¼ ê±°ë˜ì†Œ ì—°ë™)');
        }
    }
    
    // í†µí•© í—¤ì§€ ì„¹ì…˜ ì´ˆê¸°í™”
    function resetIntegratedHedgeSection() {
        integratedHedgeData = {
            totalCount: 0,
            totalReceivable: 0,
            totalPayable: 0,
            netExposure: 0,
            hedgeRatio: 70,
            forwardRatio: 60,
            futuresRatio: 40
        };
        
        document.getElementById('integratedTotalCount').textContent = '0ê±´';
        document.getElementById('integratedReceivable').textContent = '$0';
        document.getElementById('integratedPayable').textContent = '$0';
        document.getElementById('integratedNetExposure').textContent = '$0';
        document.getElementById('integratedNetKRW').textContent = '0ì–µì›';
        document.getElementById('integratedDataStatus').textContent = 'ë°ì´í„° ì—†ìŒ';
        
        document.getElementById('hedgeRatioSlider').value = 70;
        document.getElementById('totalHedgeRatio').textContent = '70%';
        
        document.getElementById('forwardRatio').textContent = '60%';
        document.getElementById('forwardAmount').textContent = '$0';
        document.getElementById('forwardAmountKRW').textContent = '0ì–µì›';
        document.getElementById('forwardBar').style.width = '60%';
        
        document.getElementById('futuresRatio').textContent = '40%';
        document.getElementById('futuresAmount').textContent = '$0';
        document.getElementById('futuresAmountKRW').textContent = '0ì–µì›';
        document.getElementById('futuresContracts').textContent = '0ê³„ì•½';
        document.getElementById('futuresBar').style.width = '40%';
        
        document.getElementById('unhedgedRatio').textContent = '30%';
        document.getElementById('unhedgedAmount').textContent = '$0 (0ì–µì›)';
        
        document.getElementById('integratedHedgeBody').innerHTML = `
            <tr>
                <td colspan="7" class="p-6 text-center text-gray-400">
                    <div class="text-3xl mb-2">ğŸ”—</div>
                    <p>ë°ì´í„° ì—…ë¡œë“œ í›„ 'ì „ëµ ê³„ì‚°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´</p>
                    <p class="text-xs mt-1">ìµœì ì˜ í˜¼í•© í—¤ì§€ ì „ëµì„ ì œì•ˆí•©ë‹ˆë‹¤.</p>
                </td>
            </tr>
        `;
    }

    // ëª¨ë“  ë°ì´í„° ì‚­ì œ
    function clearAllData() {
        if (!confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì—…ë¡œë“œëœ ê±°ë˜ ë°ì´í„°, ì§‘ê³„ í˜„í™©, ë¶„ì„ ê²°ê³¼ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.\n\nâ€» ë…¸ì¶œë¶„ì„ íƒ­ì˜ ë°ì´í„°ë„ í•¨ê»˜ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) {
            return;
        }

        console.log('ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì‚­ì œ ì‹œì‘...');

        // â˜… localStorage ì™„ì „ ì´ˆê¸°í™” (ìƒˆë¡œê³ ì¹¨/íƒ­ ê°„ ê³µìœ  ë°ì´í„°) â˜…
        localStorage.removeItem('uploadedData');
        localStorage.removeItem('uploadedDataTimestamp');
        localStorage.removeItem('serverAnalysisResult');
        localStorage.removeItem('nettingResult');
        localStorage.removeItem('analysisResults');
        localStorage.removeItem('hedgeStrategies');
        localStorage.removeItem('riskMetrics');
        localStorage.removeItem('executedTrades');

        // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ë„ ì •ë¦¬ (í˜¸í™˜ì„±)
        sessionStorage.removeItem('uploadedData');
        sessionStorage.removeItem('uploadedDataTimestamp');
        sessionStorage.removeItem('nettingResult');
        sessionStorage.removeItem('serverAnalysisResult');
        sessionStorage.removeItem('hedgeAnalysisResult');

        // â˜… ë‹¤ë¥¸ íƒ­(ë…¸ì¶œë¶„ì„ ë“±)ì— ì‚­ì œ ì‹ í˜¸ ì „ì†¡ â˜…
        localStorage.setItem('dataClearSignal', Date.now().toString());
        setTimeout(() => localStorage.removeItem('dataClearSignal'), 100);

        // ===== KPI ì„¹ì…˜ ì´ˆê¸°í™” =====
        const kpiCurrentHedge = document.getElementById('kpiCurrentHedge');
        if (kpiCurrentHedge) {
            kpiCurrentHedge.textContent = '0%';
            kpiCurrentHedge.className = 'text-3xl font-bold text-gray-400';
        }
        const kpiHedgeGap = document.getElementById('kpiHedgeGap');
        if (kpiHedgeGap) {
            kpiHedgeGap.textContent = 'ë°ì´í„° ì—†ìŒ';
            kpiHedgeGap.className = 'indicator-gray text-[10px] px-2 py-1 rounded font-bold mb-1';
        }
        const kpiUnhedgedExposure = document.getElementById('kpiUnhedgedExposure');
        if (kpiUnhedgedExposure) {
            kpiUnhedgedExposure.textContent = '0ì–µì›';
        }

        // ===== ê±°ë˜ í…Œì´ë¸” ì´ˆê¸°í™” =====
        const tradeBody = document.getElementById('tradeListBody');
        if (tradeBody) {
            tradeBody.innerHTML = `
                <tr>
                    <td colspan="9" class="p-8 text-center text-gray-400">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p>ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-xs mt-2">Excel íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                    </td>
                </tr>
            `;
        }

        // ===== ì§‘ê³„ í…Œì´ë¸” ì´ˆê¸°í™” =====
        const aggElements = {
            'aggTotalCount': '0ê±´',
            'aggCurrencyCount': '0ê°œ',
            'aggTotalReceivable': '0ì–µì›',
            'aggTotalPayable': '0ì–µì›',
            'aggNetExposure': '0ì–µì›'
        };
        Object.entries(aggElements).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        });

        const aggBody = document.getElementById('aggTableBody');
        if (aggBody) {
            aggBody.innerHTML = `
                <tr>
                    <td colspan="7" class="p-6 text-center text-gray-400">
                        ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤
                    </td>
                </tr>
            `;
        }

        // ===== ì‹œìŠ¤í…œ ì œì•ˆ í—¤ì§€ ê±°ë˜ í…Œì´ë¸” ì´ˆê¸°í™” =====
        const suggestBody = document.getElementById('hedgeSuggestionsBody');
        if (suggestBody) {
            suggestBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-gray-400 py-20">
                        <div class="text-4xl mb-2">ğŸ’¡</div>
                        <p>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê°œë³„ í—¤ì§€ ê±°ë˜ê°€</p>
                        <p class="text-xs mt-1">ì´ ì˜ì—­ì— ìŠ¤í¬ë¡¤ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </td>
                </tr>
            `;
        }
        const suggestCountEl = document.getElementById('hedgeSuggestionsCount');
        if (suggestCountEl) suggestCountEl.textContent = '0ê±´';
        console.log('   âœ“ ì‹œìŠ¤í…œ ì œì•ˆ í—¤ì§€ ê±°ë˜ ì´ˆê¸°í™” ì™„ë£Œ');

        // ===== í†µí•© í—¤ì§€ ì „ëµ ì„¹ì…˜ ì´ˆê¸°í™” =====
        resetIntegratedHedgeSection();
        console.log('   âœ“ í†µí•© í—¤ì§€ ì „ëµ ì„¹ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');

        // ===== ì¹´ìš´íŠ¸ ì´ˆê¸°í™” =====
        const countEl = document.getElementById('tradeCount');
        if (countEl) {
            countEl.textContent = 'ë°ì´í„° ì—†ìŒ';
            countEl.className = 'text-sm font-bold text-white bg-gray-400 px-4 py-2 rounded-lg';
        }

        // ===== ë‚´ë¶€í—¤ì§€ ê²°ê³¼ ì„¹ì…˜ ì œê±° =====
        const nettingSection = document.querySelector('.bg-gradient-to-r.from-green-50');
        if (nettingSection) {
            nettingSection.remove();
        }

        // ===== ìƒë‹¨ ì•Œë¦¼ ì œê±° =====
        const statusDiv = document.querySelector('.bg-blue-50.border-b');
        if (statusDiv) {
            statusDiv.remove();
        }

        // ===== í—¤ì§€ ê³„ì‚° ë²„íŠ¼ ë¹„í™œì„±í™” =====
        const btn = document.getElementById('runHedgeAnalysisBtn');
        if (btn) {
            btn.disabled = true;
            btn.classList.remove('animate-pulse');
            btn.innerHTML = 'âš¡ í—¤ì§€ ê³„ì‚° ì‹¤í–‰';
        }

        console.log('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        alert('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n- ì—…ë¡œë“œ ë°ì´í„°\n- KPI í˜„í™©\n- ì§‘ê³„ í…Œì´ë¸”\n- ì œì•ˆ ê±°ë˜\n\nëª¨ë‘ ì´ˆê¸°í™” ì™„ë£Œ!');
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ì‹œìŠ¤í…œ ì œì•ˆ í—¤ì§€ ê±°ë˜ (ê°œë³„ ê±°ë˜ê±´ë³„)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    // ê°œë³„ í—¤ì§€ ì œì•ˆ ìƒì„±
    function generateIndividualHedgeSuggestions(data) {
        console.log('ğŸ’¡ ê°œë³„ í—¤ì§€ ì œì•ˆ ìƒì„± ì¤‘...', data.length, 'ê±´');
        
        const tbody = document.getElementById('hedgeSuggestionsBody');
        const countEl = document.getElementById('hedgeSuggestionsCount');
        
        if (!data || data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-gray-400 py-20">
                        <div class="text-4xl mb-2">ğŸ’¡</div>
                        <p>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê°œë³„ í—¤ì§€ ê±°ë˜ê°€</p>
                        <p class="text-xs mt-1">ì´ ì˜ì—­ì— ìŠ¤í¬ë¡¤ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </td>
                </tr>
            `;
            if (countEl) countEl.textContent = '0ê±´';
            return;
        }
        
        // ì€í–‰ ì¶”ì²œ ë¡œì§ (ê¸ˆì•¡ ê¸°ì¤€)
        const recommendBank = (amount, currency) => {
            if (amount >= 1000000) return { bank: 'ìš°ë¦¬ì€í–‰', reason: 'ëŒ€ê¸°ì—… ì „ë¬¸' };
            if (amount >= 500000) return { bank: 'í•˜ë‚˜ì€í–‰', reason: 'ìš°ëŒ€í™˜ìœ¨' };
            if (currency === 'JPY' || currency === 'CNY') return { bank: 'ì‹ í•œì€í–‰', reason: 'ì•„ì‹œì•„í†µí™” ì „ë¬¸' };
            return { bank: 'KBêµ­ë¯¼ì€í–‰', reason: 'ì¼ë°˜ ìš°ëŒ€' };
        };
        
        // í—¤ì§€ ìƒí’ˆ ì¶”ì²œ ë¡œì§
        const recommendProduct = (daysToMaturity, amount) => {
            if (daysToMaturity <= 30) return 'í˜„ë¬¼í™˜';
            if (daysToMaturity <= 90) return 'ì„ ë¬¼í™˜ (3M)';
            if (daysToMaturity <= 180) return 'ì„ ë¬¼í™˜ (6M)';
            if (amount >= 1000000) return 'í†µí™”ì˜µì…˜';
            return 'ì„ ë¬¼í™˜ (1Y)';
        };
        
        // ê±°ë˜ê±´ë³„ ì œì•ˆ ìƒì„±
        let rows = '';
        data.forEach((item, index) => {
            const amount = parseFloat(item.amount) || 0;
            const currency = item.currency || 'USD';
            const entity = item.entity || item.counterparty || 'ê±°ë˜ì²˜ ' + (index + 1);
            const dateStr = item.date || item.maturityDate || '-';
            const type = item.type || 'receivable';
            
            // ë§Œê¸°ì¼ê¹Œì§€ ì¼ìˆ˜ ê³„ì‚°
            let daysToMaturity = 90;
            if (dateStr && dateStr !== '-') {
                const maturityDate = new Date(dateStr);
                const today = new Date();
                daysToMaturity = Math.ceil((maturityDate - today) / (1000 * 60 * 60 * 24));
            }
            
            const bank = recommendBank(amount, currency);
            const product = recommendProduct(daysToMaturity, amount);
            const direction = type === 'receivable' ? 'ë§¤ë„' : 'ë§¤ìˆ˜';
            const dirClass = type === 'receivable' ? 'text-red-600' : 'text-blue-600';
            
            rows += `
                <tr class="hover:bg-blue-50 border-b border-gray-100" style="height: 32px;">
                    <td class="px-2 py-1 text-center font-bold text-gray-400 text-[10px]" style="width: 40px;">${index + 1}</td>
                    <td class="px-2 py-1" style="width: 150px;">
                        <span class="font-medium text-gray-800 text-[11px]">${entity}</span>
                        <span class="text-[9px] ${dirClass} ml-1">(${direction})</span>
                    </td>
                    <td class="px-2 py-1" style="width: 100px;">
                        <span class="px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded text-[9px]">${product}</span>
                    </td>
                    <td class="px-2 py-1 font-bold text-[11px]" style="width: 60px;">${currency}</td>
                    <td class="px-2 py-1 font-bold text-gray-800 text-right text-[11px]" style="width: 100px;">$${amount.toLocaleString()}</td>
                    <td class="px-2 py-1 text-gray-600 text-[10px]" style="width: 90px;">${dateStr}</td>
                    <td class="px-2 py-1" style="width: 90px;">
                        <span class="font-bold text-blue-700 text-[10px]">${bank.bank}</span>
                    </td>
                    <td class="px-2 py-1 text-center" style="width: 60px;">
                        <button onclick="executeSingleHedge(${index}, '${entity}', '${currency}', ${amount})" 
                                class="px-2 py-0.5 bg-green-500 text-white rounded text-[10px] hover:bg-green-600">
                            ì‹¤í–‰
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = rows;
        if (countEl) countEl.textContent = data.length + 'ê±´';
        
        // â˜… ìŠ¤í¬ë¡¤ ì˜ì—­ ê°•ì œ í™œì„±í™” (requestAnimationFrame ì‚¬ìš©) â˜…
        requestAnimationFrame(() => {
            const scrollArea = document.getElementById('hedgeSuggestionsScrollArea');
            if (scrollArea) {
                // CSS ìŠ¤íƒ€ì¼ ì§ì ‘ ì ìš© (ë™ì  ì—…ë°ì´íŠ¸ ë³´ì¥)
                scrollArea.style.overflowY = 'auto';
                scrollArea.style.maxHeight = '130px';
                scrollArea.style.minHeight = '80px';
                
                // ê°•ì œ ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
                void scrollArea.offsetHeight;
                
                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
                scrollArea.scrollTop = 0;
                
                console.log('ğŸ“œ ìŠ¤í¬ë¡¤ ì˜ì—­ í™œì„±í™” - scrollHeight:', scrollArea.scrollHeight, 'px, clientHeight:', scrollArea.clientHeight, 'px');
            }
        });
        
        console.log('âœ… ê°œë³„ í—¤ì§€ ì œì•ˆ ìƒì„± ì™„ë£Œ:', data.length, 'ê±´');
    }
    
    // ë‹¨ì¼ í—¤ì§€ ê±°ë˜ ì‹¤í–‰
    function executeSingleHedge(index, entity, currency, amount) {
        const msg = `ğŸ“‹ í—¤ì§€ ê±°ë˜ ì‹¤í–‰ í™•ì¸

ê±°ë˜ì²˜: ${entity}
í†µí™”: ${currency}
ê¸ˆì•¡: $${amount.toLocaleString()}

ì´ ê±°ë˜ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        
        if (confirm(msg)) {
            alert(`âœ… í—¤ì§€ ê±°ë˜ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê±°ë˜ì²˜: ${entity}\nê¸ˆì•¡: $${amount.toLocaleString()}\n\n(ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œëŠ” ì€í–‰ API ì—°ë™)`);
            
            // í•´ë‹¹ í–‰ í‘œì‹œ ì—…ë°ì´íŠ¸
            const tbody = document.getElementById('hedgeSuggestionsBody');
            const row = tbody.querySelectorAll('tr')[index];
            if (row) {
                row.classList.add('bg-green-50');
                const btn = row.querySelector('button');
                if (btn) {
                    btn.textContent = 'ì™„ë£Œ';
                    btn.className = 'px-3 py-1 bg-gray-300 text-gray-600 rounded text-xs cursor-not-allowed';
                    btn.disabled = true;
                }
            }
        }
    }
    
    // ëª¨ë“  ì œì•ˆ ê±°ë˜ ì‹¤í–‰
    function executeAllSuggestions() {
        const tbody = document.getElementById('hedgeSuggestionsBody');
        const rows = tbody.querySelectorAll('tr');
        const count = rows.length;
        
        if (count === 0 || (count === 1 && rows[0].querySelector('td[colspan]'))) {
            alert('ğŸ“‹ ì‹¤í–‰í•  í—¤ì§€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (confirm(`ğŸ¯ ì´ ${count}ê±´ì˜ í—¤ì§€ ê±°ë˜ë¥¼ ì¼ê´„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê°œë³„ ê±°ë˜ê°€ ëª¨ë‘ ì‹¤í–‰ë©ë‹ˆë‹¤.`)) {
            rows.forEach(row => {
                row.classList.add('bg-green-50');
                const btn = row.querySelector('button');
                if (btn) {
                    btn.textContent = 'ì™„ë£Œ';
                    btn.className = 'px-3 py-1 bg-gray-300 text-gray-600 rounded text-xs cursor-not-allowed';
                    btn.disabled = true;
                }
            });
            
            alert(`âœ… ${count}ê±´ì˜ í—¤ì§€ ê±°ë˜ê°€ ëª¨ë‘ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n(ì‹¤ì œ ì‹œìŠ¤í…œì—ì„œëŠ” ì€í–‰ API ì¼ê´„ ì—°ë™)`);
        }
    }

    // KPI ì„¹ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateKPISection(data) {
        console.log('ğŸ“Š KPI ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì‹œì‘...');
        
        const rates = {
            'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190,
            'GBP': 1750, 'AUD': 900, 'CAD': 1000, 'CHF': 1550,
            'HKD': 175, 'SGD': 1020, 'THB': 38, 'VND': 0.055
        };

        // í†µí™”ë³„ ì§‘ê³„
        let totalExposureKRW = 0;
        let totalReceivableKRW = 0;
        let totalPayableKRW = 0;

        data.forEach(item => {
            const rate = rates[item.currency] || 1350;
            const amountKRW = item.amount * rate;
            
            if (item.type === 'receivable') {
                totalReceivableKRW += amountKRW;
            } else if (item.type === 'payable') {
                totalPayableKRW += amountKRW;
            }
        });

        // ìˆœë…¸ì¶œ ê³„ì‚°
        totalExposureKRW = Math.abs(totalReceivableKRW - totalPayableKRW);
        
        // ì–µì› í™˜ì‚°
        const exposureEokWon = (totalExposureKRW / 100000000).toFixed(0);
        
        // í˜„ì¬ í—¤ì§€ ë¹„ìœ¨ ê³„ì‚° (ë‚´ë¶€í—¤ì§€ë¡œ ìƒì‡„ëœ ë¶€ë¶„)
        const internallyHedged = Math.min(totalReceivableKRW, totalPayableKRW);
        const totalGrossExposure = totalReceivableKRW + totalPayableKRW;
        const currentHedgeRatio = totalGrossExposure > 0 
            ? ((internallyHedged / totalGrossExposure) * 100).toFixed(1)
            : 0;
        
        // ëª©í‘œ ëŒ€ë¹„ ê°­ ê³„ì‚°
        const targetRatio = 75;
        const gap = targetRatio - parseFloat(currentHedgeRatio);

        // KPI ì—…ë°ì´íŠ¸
        const kpiCurrentHedge = document.getElementById('kpiCurrentHedge');
        if (kpiCurrentHedge) {
            kpiCurrentHedge.textContent = `${currentHedgeRatio}%`;
            // ìƒ‰ìƒ ì¡°ì •
            if (parseFloat(currentHedgeRatio) >= 70) {
                kpiCurrentHedge.className = 'text-3xl font-bold text-green-600';
            } else if (parseFloat(currentHedgeRatio) >= 50) {
                kpiCurrentHedge.className = 'text-3xl font-bold text-yellow-600';
            } else {
                kpiCurrentHedge.className = 'text-3xl font-bold text-red-500';
            }
        }

        const kpiHedgeGap = document.getElementById('kpiHedgeGap');
        if (kpiHedgeGap) {
            if (gap > 0) {
                kpiHedgeGap.textContent = `-${gap.toFixed(1)}% ë¶€ì¡±`;
                kpiHedgeGap.className = 'indicator-red text-[10px] px-2 py-1 rounded font-bold mb-1';
            } else {
                kpiHedgeGap.textContent = `+${Math.abs(gap).toFixed(1)}% ì´ˆê³¼`;
                kpiHedgeGap.className = 'indicator-green text-[10px] px-2 py-1 rounded font-bold mb-1';
            }
        }

        const kpiUnhedgedExposure = document.getElementById('kpiUnhedgedExposure');
        if (kpiUnhedgedExposure) {
            kpiUnhedgedExposure.textContent = `${exposureEokWon}ì–µì›`;
        }

        console.log(`âœ… KPI ì—…ë°ì´íŠ¸ ì™„ë£Œ: í—¤ì§€ë¹„ìœ¨ ${currentHedgeRatio}%, ë¯¸í—¤ì§€ë…¸ì¶œ ${exposureEokWon}ì–µì›`);
    }

    // ì—…ë¡œë“œëœ ë°ì´í„° ì²˜ë¦¬ (ê³µí†µ í•¨ìˆ˜)
    function processUploadedData(data) {
        console.log('ğŸ“Š ë°ì´í„° ì²˜ë¦¬ ì‹œì‘:', data.length, 'ê±´');
        
        // â˜… localStorageì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨/íƒ­ ê°„ ê³µìœ ) â˜…
        localStorage.setItem('uploadedData', JSON.stringify(data));
        localStorage.setItem('uploadedDataTimestamp', new Date().toISOString());
        
        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        updateDashboardWithData(data);
        updateTradeListTable(data);
        
        // ì§‘ê³„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        updateAggregationSummary(data);
        
        // â˜… KPI ì„¹ì…˜ ì—…ë°ì´íŠ¸ â˜…
        updateKPISection(data);
        
        // â˜… ê°œë³„ í—¤ì§€ ì œì•ˆ ìƒì„± â˜…
        generateIndividualHedgeSuggestions(data);
        
        // â˜… í†µí•© í—¤ì§€ ì „ëµ ìë™ ê³„ì‚° â˜…
        generateIntegratedHedge();
        
        // í—¤ì§€ ê³„ì‚° ë²„íŠ¼ í™œì„±í™”
        const btn = document.getElementById('runHedgeAnalysisBtn');
        if (btn) {
            btn.disabled = false;
            btn.classList.add('btn-ready-pulse');
        }
        
        // ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        const clearBtn = document.getElementById('clearDataBtn');
        if (clearBtn) {
            clearBtn.style.display = 'block';
        }
        
        // â˜… ë‹¤ë¥¸ íƒ­(ë…¸ì¶œë¶„ì„ ë“±)ì— ë°ì´í„° ì—…ë¡œë“œ ì‹ í˜¸ ì „ì†¡ â˜…
        localStorage.setItem('dataUploadSignal', Date.now().toString());
        setTimeout(() => localStorage.removeItem('dataUploadSignal'), 100);
        
        // â˜… ìµëª…í™” í›„ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ë¶„ì„ ì‹¤í–‰ â˜…
        sendAnonymizedDataToServer(data);
        
        // â˜… ì—…ë¡œë“œ ì™„ë£Œ ì•Œë¦¼ (ì´ë™í•˜ì§€ ì•ŠìŒ) â˜…
        alert(`âœ… ${data.length}ê±´ì˜ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì„œë²„ë¡œ ìµëª…í™”ëœ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ì—¬ ë¶„ì„ ì¤‘...\n\nğŸ“Š ìƒì„¸ ê²°ê³¼ëŠ” ì¢Œì¸¡ ë©”ë‰´ì˜ "ë…¸ì¶œ ë¶„ì„" íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â˜… í•˜ì´ë¸Œë¦¬ë“œ íŒŒì´í”„ë¼ì¸: ìµëª…í™”ëœ ìˆ«ì â†’ ì„œë²„ ê³„ì‚°ê¸° â†’ ê²°ê³¼ ë°˜ì˜ â˜…
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    // ìµëª…í™”ëœ ë°ì´í„°ë¥¼ ì„œë²„ ê³„ì‚°ê¸°ë¡œ ì „ì†¡
    async function sendAnonymizedDataToServer(data) {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ”’ í•˜ì´ë¸Œë¦¬ë“œ íŒŒì´í”„ë¼ì¸ ì‹œì‘');
        console.log('   âœ“ ê³ ê° ë°ì´í„°: ë¡œì»¬ì—ë§Œ ì €ì¥');
        console.log('   âœ“ ì„œë²„ ì „ì†¡: ìˆ«ìë§Œ (ê³ ê°ì •ë³´ ì¼ì²´ ì—†ìŒ)');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // 1ë‹¨ê³„: ìµëª…í™” ì²˜ë¦¬ (ìˆ«ìë§Œ ì¶”ì¶œ)
        const anonymizedData = anonymizeTradeData(data);
        
        // ì „ì†¡ ì „ ê²€ì¦: ê³ ê°ì •ë³´ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
        console.log('ğŸ“‹ ì„œë²„ ì „ì†¡ ë°ì´í„° ìƒ˜í”Œ:');
        console.log(JSON.stringify(anonymizedData.slice(0, 2), null, 2));
        
        // 2ë‹¨ê³„: ì„œë²„ ê³„ì‚°ê¸° í˜¸ì¶œìš© ìš”ì²­ ë°ì´í„° êµ¬ì„±
        const calculatorRequest = {
            // í†µí™”ë³„ ì§‘ê³„ (ìˆ«ìë§Œ)
            currencySummary: aggregateByCurrency(anonymizedData),
            
            // ë§Œê¸°ë³„ ë¶„í¬ (ìˆ«ìë§Œ)
            maturityBuckets: categorizeByMaturity(anonymizedData),
            
            // ê³„ì‚° ì˜µì…˜
            options: {
                targetHedgeRatio: 75,
                riskTolerance: 'moderate',
                calculators: ['01', '02', '03', '05']  // ì‚¬ìš©í•  ê³„ì‚°ê¸° ëª©ë¡
            }
        };

        console.log('ğŸ“¤ ì„œë²„ ê³„ì‚°ê¸° ìš”ì²­ ë°ì´í„°:', calculatorRequest);
        
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ì„œë²„ URL ì„¤ì • (ë„¤ì´ë²„ í´ë¼ìš°ë“œ ë“± ì™¸ë¶€ ì„œë²„ë¡œ ë³€ê²½ ê°€ëŠ¥)
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // 1. ë¡œì»¬ ê°œë°œ: '' (í˜„ì¬ í˜¸ìŠ¤íŠ¸)
        // 2. ë„¤ì´ë²„ í´ë¼ìš°ë“œ: 'https://your-naver-server.kr'
        // ì„¤ì • ë°©ë²•: HedgeFreedomConfig.setCalculatorServer('https://...')
        // ë˜ëŠ”: localStorage.setItem('CALCULATOR_SERVER', 'https://...')
        const serverUrl = (window.HedgeFreedomConfig?.getApiUrl) 
            ? window.HedgeFreedomConfig.getApiUrl('/api/calculator/batch')
            : '/api/calculator/batch';
        
        console.log('ğŸŒ ê³„ì‚°ê¸° ì„œë²„:', serverUrl);
        
        try {
            // 3ë‹¨ê³„: ì„œë²„ ê³„ì‚°ê¸° API í˜¸ì¶œ
            const response = await fetch(serverUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(calculatorRequest)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('âœ… ì„œë²„ ê³„ì‚°ê¸° ì‘ë‹µ ìˆ˜ì‹ :', result);
                
                // 4ë‹¨ê³„: ê³„ì‚° ê²°ê³¼ë¥¼ ë¡œì»¬ ëŒ€ì‹œë³´ë“œì— ë°˜ì˜
                // â˜… localStorageì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨/íƒ­ ê°„ ê³µìœ ) â˜…
                localStorage.setItem('serverAnalysisResult', JSON.stringify(result));
                // ê°™ì€ íƒ­ì—ì„œë„ ì¦‰ì‹œ ë°˜ì˜ë˜ë„ë¡ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œì†¡
                try {
                    window.dispatchEvent(new CustomEvent('serverAnalysisResultUpdated', { detail: result }));
                } catch (e) {
                    console.warn('Custom event dispatch failed:', e);
                }
                applyServerAnalysisResults(result, data);
                
                showNotification('success', 'ì„œë²„ ê³„ì‚° ì™„ë£Œ! ë¶„ì„ ê²°ê³¼ê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } else {
                console.warn('âš ï¸ ì„œë²„ ê³„ì‚°ê¸° ì‘ë‹µ ì˜¤ë¥˜, ë¡œì»¬ ë¶„ì„ ì§„í–‰...');
                runLocalAnalysis(data);
            }
        } catch (error) {
            console.error('âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜:', error);
            console.log('âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ë¶„ì„ìœ¼ë¡œ ëŒ€ì²´...');
            runLocalAnalysis(data);
        }
    }

    // í†µí™”ë³„ ì§‘ê³„ (ìµëª…í™”ëœ ë°ì´í„°)
    function aggregateByCurrency(anonymizedData) {
        const summary = {};
        
        anonymizedData.forEach(item => {
            if (!summary[item.ccy]) {
                summary[item.ccy] = { receivable: 0, payable: 0, count: 0 };
            }
            
            if (item.dir === 'R') {
                summary[item.ccy].receivable += item.amt;
            } else {
                summary[item.ccy].payable += item.amt;
            }
            summary[item.ccy].count++;
        });
        
        return summary;
    }

    // ë§Œê¸°ë³„ ë¶„ë¥˜ (ìµëª…í™”ëœ ë°ì´í„°)
    function categorizeByMaturity(anonymizedData) {
        const buckets = {
            '0-30': { receivable: 0, payable: 0 },
            '31-60': { receivable: 0, payable: 0 },
            '61-90': { receivable: 0, payable: 0 },
            '91-180': { receivable: 0, payable: 0 },
            '181-365': { receivable: 0, payable: 0 },
            '365+': { receivable: 0, payable: 0 }
        };
        
        anonymizedData.forEach(item => {
            let bucket;
            const days = item.daysToMaturity;
            
            if (days <= 30) bucket = '0-30';
            else if (days <= 60) bucket = '31-60';
            else if (days <= 90) bucket = '61-90';
            else if (days <= 180) bucket = '91-180';
            else if (days <= 365) bucket = '181-365';
            else bucket = '365+';
            
            if (item.dir === 'R') {
                buckets[bucket].receivable += item.amt;
            } else {
                buckets[bucket].payable += item.amt;
            }
        });
        
        return buckets;
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showNotification(type, message) {
        const colors = {
            success: 'bg-green-100 border-green-500 text-green-800',
            error: 'bg-red-100 border-red-500 text-red-800',
            warning: 'bg-yellow-100 border-yellow-500 text-yellow-800'
        };
        
        const div = document.createElement('div');
        div.className = `fixed top-4 right-4 p-4 rounded-lg border-l-4 ${colors[type]} shadow-lg z-50 transition-opacity duration-500`;
        div.innerHTML = `<span class="font-bold">${message}</span>`;
        document.body.appendChild(div);
        
        setTimeout(() => {
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 500);
        }, 3000);
    }

    // ì„œë²„ ë¶„ì„ ê²°ê³¼ ë°˜ì˜ (ë¡œì»¬ ì›ë³¸ ë°ì´í„°ì™€ ë§¤í•‘)
    function applyServerAnalysisResults(result, originalData) {
        console.log('ğŸ“Š ì„œë²„ ê³„ì‚° ê²°ê³¼ë¥¼ ë¡œì»¬ ëŒ€ì‹œë³´ë“œì— ë°˜ì˜...');
        
        // KPI ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ê³„ì‚°ëœ ì •í™•í•œ ê°’)
        if (result.kpi) {
            const kpiCurrentHedge = document.getElementById('kpiCurrentHedge');
            if (kpiCurrentHedge && result.kpi.currentHedgeRatio !== undefined) {
                kpiCurrentHedge.textContent = `${result.kpi.currentHedgeRatio}%`;
                
                // ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                if (result.kpi.currentHedgeRatio >= 70) {
                    kpiCurrentHedge.className = 'text-3xl font-bold text-green-600';
                } else if (result.kpi.currentHedgeRatio >= 50) {
                    kpiCurrentHedge.className = 'text-3xl font-bold text-yellow-600';
                } else {
                    kpiCurrentHedge.className = 'text-3xl font-bold text-red-500';
                }
            }
            
            const kpiUnhedgedExposure = document.getElementById('kpiUnhedgedExposure');
            if (kpiUnhedgedExposure && result.kpi.unhedgedExposure !== undefined) {
                kpiUnhedgedExposure.textContent = `${result.kpi.unhedgedExposure}ì–µì›`;
            }
            
            const kpiHedgeGap = document.getElementById('kpiHedgeGap');
            if (kpiHedgeGap && result.kpi.hedgeGap !== undefined) {
                const gap = result.kpi.hedgeGap;
                if (gap > 0) {
                    kpiHedgeGap.textContent = `-${gap.toFixed(1)}% ë¶€ì¡±`;
                    kpiHedgeGap.className = 'indicator-red text-[10px] px-2 py-1 rounded font-bold mb-1';
                } else {
                    kpiHedgeGap.textContent = `+${Math.abs(gap).toFixed(1)}% ì´ˆê³¼`;
                    kpiHedgeGap.className = 'indicator-green text-[10px] px-2 py-1 rounded font-bold mb-1';
                }
            }
        }
        
        // ì œì•ˆ ê±°ë˜ í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì„œë²„ ê³„ì‚° ê²°ê³¼ ê¸°ë°˜)
        if (result.suggestions && result.suggestions.length > 0) {
            updateSuggestedTrades(result.suggestions);
        }
        
        console.log('âœ… ì„œë²„ ê³„ì‚° ê²°ê³¼ ë°˜ì˜ ì™„ë£Œ (ê³ ê° ë°ì´í„°ëŠ” ë¡œì»¬ì—ë§Œ ìœ ì§€)');
    }

    // ì œì•ˆ ê±°ë˜ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateSuggestedTrades(suggestions) {
        const tbody = document.getElementById('hedgeSuggestionsBody');
        if (!tbody) {
            console.warn('âš ï¸ hedgeSuggestionsBody ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const priorityColors = {
            'high': { bg: 'bg-red-100', text: 'text-red-700', label: 'ë†’ìŒ' },
            'medium': { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'ì¤‘ê°„' },
            'low': { bg: 'bg-green-100', text: 'text-green-700', label: 'ë‚®ìŒ' }
        };

        const rows = suggestions.map(s => {
            const priority = priorityColors[s.priority] || priorityColors.medium;
            const amountFormatted = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0
            }).format(s.amount);

            return `
                <tr class="hover:bg-blue-50">
                    <td class="p-4"><span class="px-2 py-1 ${priority.bg} ${priority.text} rounded-full font-bold">${priority.label}</span></td>
                    <td class="p-4">
                        <p class="font-bold text-gray-800">${s.product}</p>
                        <p class="text-[10px] text-gray-400 italic">${s.reason || ''}</p>
                    </td>
                    <td class="p-4 font-bold text-blue-700">${s.currency} / KRW</td>
                    <td class="p-4 font-bold">${amountFormatted}</td>
                    <td class="p-4 font-mono">${s.targetDate || '-'}</td>
                    <td class="p-4">
                        <span class="font-bold">${s.bank || '-'}</span>
                        ${s.suggestedRate ? `<p class="text-[10px] text-green-600 font-medium">ì˜ˆìƒ í™˜ìœ¨: ${s.suggestedRate}</p>` : ''}
                    </td>
                    <td class="p-4 text-center">
                        <button class="px-4 py-1.5 border border-blue-600 text-blue-600 rounded-sm font-bold hover:bg-blue-600 hover:text-white transition">ì‹¤í–‰</button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;
    }

    // ë¡œì»¬ ë¶„ì„ (ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ëŒ€ì²´)
    function runLocalAnalysis(data) {
        console.log('ğŸ“Š ë¡œì»¬ ë¶„ì„ ì‹œì‘ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)...');
        
        const rates = { 'USD': 1350, 'EUR': 1500, 'JPY': 10.5, 'CNY': 190 };
        
        // í†µí™”ë³„ ì§‘ê³„
        const currencySummary = {};
        let totalReceivableKRW = 0;
        let totalPayableKRW = 0;
        
        data.forEach(item => {
            const ccy = item.currency || 'USD';
            const amount = parseFloat(item.amount) || 0;
            const rate = rates[ccy] || 1350;
            
            if (!currencySummary[ccy]) {
                currencySummary[ccy] = { receivable: 0, payable: 0 };
            }
            if (item.type === 'receivable') {
                currencySummary[ccy].receivable += amount;
                totalReceivableKRW += amount * rate;
            } else {
                currencySummary[ccy].payable += amount;
                totalPayableKRW += amount * rate;
            }
        });
        
        // ê³„ì‚°
        const netExposureKRW = Math.abs(totalReceivableKRW - totalPayableKRW);
        const netExposureUSD = netExposureKRW / 1350;
        const internalHedge = Math.min(totalReceivableKRW, totalPayableKRW);
        const totalGross = totalReceivableKRW + totalPayableKRW;
        const hedgeRatio = totalGross > 0 ? (internalHedge / totalGross * 100) : 0;
        const var95 = netExposureKRW * 0.015 * 1.645;
        
        // ì„œë²„ ê²°ê³¼ì™€ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ì €ì¥
        const localResult = {
            mode: 'local',
            timestamp: new Date().toISOString(),
            risk: {
                var95: var95,
                projectedVar: var95 * 0.3
            },
            exposure: {
                netExposure: netExposureUSD,
                grossExposure: totalGross / 1350,
                currencies: Object.keys(currencySummary),
                byCurrency: Object.fromEntries(
                    Object.entries(currencySummary).map(([ccy, data]) => [
                        ccy,
                        {
                            receivable: data.receivable,
                            payable: data.payable,
                            nettedAmount: Math.min(data.receivable, data.payable),
                            hedgedAmount: 0
                        }
                    ])
                )
            },
            hedge: {
                currentRatio: hedgeRatio,
                targetRatio: 75
            },
            sensitivity: {
                upside: netExposureKRW * 0.05,
                downside: netExposureKRW * 0.05 * (1 - hedgeRatio / 100)
            }
        };
        
        // â˜… localStorageì— ì €ì¥ (ë…¸ì¶œë¶„ì„ì—ì„œ ì‚¬ìš©) â˜…
        localStorage.setItem('serverAnalysisResult', JSON.stringify(localResult));
        console.log('ğŸ’¾ ë¡œì»¬ ë¶„ì„ ê²°ê³¼ ì €ì¥:', localResult);
        
        // ì œì•ˆ ê±°ë˜ ìƒì„±
        const suggestions = generateLocalSuggestions(data);
        updateSuggestedTrades(suggestions);
        
        showNotification('warning', 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ë¶„ì„ ê²°ê³¼ í‘œì‹œ');
        console.log('âœ… ë¡œì»¬ ë¶„ì„ ì™„ë£Œ');
    }

    // ë¡œì»¬ ì œì•ˆ ìƒì„±
    function generateLocalSuggestions(data) {
        const currencySummary = {};
        
        data.forEach(item => {
            if (!currencySummary[item.currency]) {
                currencySummary[item.currency] = { receivable: 0, payable: 0 };
            }
            if (item.type === 'receivable') {
                currencySummary[item.currency].receivable += item.amount;
            } else {
                currencySummary[item.currency].payable += item.amount;
            }
        });

        const suggestions = [];
        
        Object.entries(currencySummary).forEach(([currency, amounts]) => {
            const netExposure = amounts.receivable - amounts.payable;
            
            if (Math.abs(netExposure) > 100000) {
                suggestions.push({
                    priority: Math.abs(netExposure) > 1000000 ? 'high' : 'medium',
                    product: 'FX Forward (ì„ ë¬¼í™˜)',
                    currency: currency,
                    amount: Math.abs(netExposure),
                    targetDate: new Date(Date.now() + 90*24*60*60*1000).toISOString().split('T')[0],
                    reason: netExposure > 0 ? 'ìˆ˜ì¶œëŒ€ê¸ˆ í—¤ì§€' : 'ìˆ˜ì…ëŒ€ê¸ˆ í—¤ì§€',
                    bank: 'ì‹ í•œì€í–‰'
                });
            }
        });

        return suggestions;
    }

    // ì»¬ëŸ¼ ë§¤í•‘ ëª¨ë‹¬ í‘œì‹œ
    function showColumnMappingModal(rawData, fileName) {
        console.log('ğŸ” ì»¬ëŸ¼ ë§¤í•‘ ëª¨ë‹¬ í‘œì‹œ');
        
        const excelColumns = Object.keys(rawData[0]);
        console.log('Excel ì»¬ëŸ¼:', excelColumns);
        
        // ì €ì¥ëœ ë§¤í•‘ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
        const savedMappings = JSON.parse(localStorage.getItem('columnMappings') || '{}');
        
        // ëª¨ë‹¬ ìƒì„±
        const modal = document.createElement('div');
        modal.id = 'columnMappingModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <!-- í—¤ë” -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-4 sticky top-0">
                    <h3 class="text-2xl font-bold">ğŸ“‹ ì»¬ëŸ¼ ë§¤í•‘ ì„¤ì •</h3>
                    <p class="text-sm mt-1 text-blue-100">Excel ì»¬ëŸ¼ì„ ì‹œìŠ¤í…œ í‘œì¤€ ì»¬ëŸ¼ì— ë§¤í•‘í•˜ì„¸ìš”</p>
                    <p class="text-xs mt-1 text-blue-200">íŒŒì¼: ${fileName}</p>
                </div>

                <!-- ë³¸ë¬¸ -->
                <div class="p-6">
                    <!-- ì €ì¥ëœ í…œí”Œë¦¿ -->
                    ${Object.keys(savedMappings).length > 0 ? `
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h4 class="text-sm font-bold text-gray-700 mb-2">ğŸ’¾ ì €ì¥ëœ ë§¤í•‘ í…œí”Œë¦¿</h4>
                            <div class="flex flex-wrap gap-2">
                                ${Object.keys(savedMappings).map(name => `
                                    <button onclick="loadMappingTemplate('${name}')" 
                                        class="px-3 py-1 bg-white border border-blue-300 text-blue-700 rounded hover:bg-blue-100 text-xs font-semibold">
                                        ${name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- ìë™ ë§¤í•‘ ë²„íŠ¼ -->
                    <div class="mb-6">
                        <button onclick="autoMapColumns()" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600">
                            ğŸ¤– ìë™ ë§¤í•‘ (AI ì¶”ì²œ)
                        </button>
                    </div>

                    <!-- ë§¤í•‘ í…Œì´ë¸” -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 gap-4 text-xs font-bold text-gray-600 px-2">
                            <div>ì‹œìŠ¤í…œ ì»¬ëŸ¼ (í•„ìˆ˜)</div>
                            <div>Excel ì»¬ëŸ¼ ì„ íƒ</div>
                            <div>ë¯¸ë¦¬ë³´ê¸°</div>
                        </div>

                        ${[
                            { key: 'id', label: 'ê±°ë˜ID', required: false },
                            { key: 'entity', label: 'ê±°ë˜ì²˜ëª…', required: true },
                            { key: 'currency', label: 'í†µí™”', required: true },
                            { key: 'amount', label: 'ì™¸í™”ê¸ˆì•¡', required: true },
                            { key: 'date', label: 'ê²°ì œì˜ˆì •ì¼', required: true },
                            { key: 'type', label: 'êµ¬ë¶„ (ì±„ê¶Œ/ì±„ë¬´)', required: true }
                        ].map(col => `
                            <div class="grid grid-cols-3 gap-4 items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="font-bold text-gray-800">${col.label}</div>
                                    ${col.required ? '<span class="text-xs text-red-600">* í•„ìˆ˜</span>' : '<span class="text-xs text-gray-500">ì„ íƒ</span>'}
                                </div>
                                <div>
                                    <select id="map_${col.key}" class="w-full px-3 py-2 border rounded text-sm" onchange="updatePreview('${col.key}')">
                                        <option value="">-- ì„ íƒ --</option>
                                        ${excelColumns.map(ecol => `<option value="${ecol}">${ecol}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="preview_${col.key}" class="text-xs text-gray-600 truncate">
                                    -
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- í…œí”Œë¦¿ ì €ì¥ -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-bold text-gray-700 mb-2">ğŸ’¾ ì´ ë§¤í•‘ì„ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</h4>
                        <div class="flex gap-2">
                            <input type="text" id="templateName" placeholder="í…œí”Œë¦¿ ì´ë¦„ (ì˜ˆ: ë”ì¡´í˜•ì‹)" 
                                class="flex-1 px-3 py-2 border rounded text-sm">
                            <button onclick="saveMappingTemplate()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 text-sm">
                                ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>

                <!-- í‘¸í„° -->
                <div class="px-6 py-4 bg-gray-50 flex justify-between items-center sticky bottom-0">
                    <button onclick="closeMappingModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400">
                        ì·¨ì†Œ
                    </button>
                    <button onclick="applyColumnMapping()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
                        âœ… ë§¤í•‘ ì ìš©í•˜ê³  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ì›ë³¸ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
        window.currentRawData = rawData;
        window.currentExcelColumns = excelColumns;
    }

    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    function updatePreview(systemKey) {
        const select = document.getElementById(`map_${systemKey}`);
        const excelCol = select.value;
        const preview = document.getElementById(`preview_${systemKey}`);
        
        if (excelCol && window.currentRawData && window.currentRawData[0]) {
            const value = window.currentRawData[0][excelCol];
            preview.textContent = value || '-';
        } else {
            preview.textContent = '-';
        }
    }

    // ìë™ ë§¤í•‘
    function autoMapColumns() {
        console.log('ğŸ¤– ìë™ ë§¤í•‘ ì‹œì‘...');
        
        const mappingRules = {
            id: ['id', 'ID', 'Id', 'ë²ˆí˜¸', 'ê±°ë˜ë²ˆí˜¸', 'transaction_id', 'trans_id'],
            entity: ['entity', 'Entity', 'ê±°ë˜ì²˜', 'ê±°ë˜ì²˜ëª…', 'ì—…ì²´ëª…', 'ê³ ê°ëª…', 'company', 'customer'],
            currency: ['currency', 'Currency', 'Ccy', 'ccy', 'í†µí™”', 'í†µí™”ì½”ë“œ', 'ì™¸í™”ì¢…ë¥˜', 'ì™¸í™”'],
            amount: ['amount', 'Amount', 'ê¸ˆì•¡', 'ì™¸í™”ê¸ˆì•¡', 'ê±°ë˜ê¸ˆì•¡', 'amt'],
            date: ['date', 'Date', 'ì¼ì', 'ë§Œê¸°ì¼', 'ê²°ì œì¼', 'ê²°ì œì˜ˆì •ì¼', 'ê±°ë˜ì¼', 'payment_date'],
            type: ['type', 'Type', 'êµ¬ë¶„', 'ê±°ë˜êµ¬ë¶„', 'ìœ í˜•', 'transaction_type']
        };
        
        let matchCount = 0;
        
        Object.keys(mappingRules).forEach(systemKey => {
            const select = document.getElementById(`map_${systemKey}`);
            const rules = mappingRules[systemKey];
            
            // Excel ì»¬ëŸ¼ê³¼ ë§¤ì¹­
            for (const excelCol of window.currentExcelColumns) {
                const found = rules.some(rule => 
                    excelCol.toLowerCase().includes(rule.toLowerCase()) ||
                    rule.toLowerCase().includes(excelCol.toLowerCase())
                );
                
                if (found) {
                    select.value = excelCol;
                    updatePreview(systemKey);
                    matchCount++;
                    console.log(`  âœ… ${systemKey} â†’ ${excelCol}`);
                    break;
                }
            }
        });
        
        alert(`ğŸ¤– ìë™ ë§¤í•‘ ì™„ë£Œ!\n\n${matchCount}ê°œ ì»¬ëŸ¼ì´ ìë™ìœ¼ë¡œ ë§¤í•‘ë˜ì—ˆìŠµë‹ˆë‹¤.\në‚˜ë¨¸ì§€ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.`);
    }

    // ë§¤í•‘ í…œí”Œë¦¿ ì €ì¥
    function saveMappingTemplate() {
        const templateName = document.getElementById('templateName').value.trim();
        if (!templateName) {
            alert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        
        const mapping = {
            id: document.getElementById('map_id').value,
            entity: document.getElementById('map_entity').value,
            currency: document.getElementById('map_currency').value,
            amount: document.getElementById('map_amount').value,
            date: document.getElementById('map_date').value,
            type: document.getElementById('map_type').value
        };
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        const savedMappings = JSON.parse(localStorage.getItem('columnMappings') || '{}');
        savedMappings[templateName] = mapping;
        localStorage.setItem('columnMappings', JSON.stringify(savedMappings));
        
        alert(`âœ… "${templateName}" í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        console.log('ğŸ’¾ ì €ì¥ëœ ë§¤í•‘:', mapping);
    }

    // ë§¤í•‘ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadMappingTemplate(templateName) {
        const savedMappings = JSON.parse(localStorage.getItem('columnMappings') || '{}');
        const mapping = savedMappings[templateName];
        
        if (!mapping) {
            alert('í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ë§¤í•‘ ì ìš©
        Object.keys(mapping).forEach(key => {
            const select = document.getElementById(`map_${key}`);
            if (select && mapping[key]) {
                select.value = mapping[key];
                updatePreview(key);
            }
        });
        
        alert(`âœ… "${templateName}" í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }

    // ì»¬ëŸ¼ ë§¤í•‘ ì ìš©
    function applyColumnMapping() {
        console.log('âœ… ì»¬ëŸ¼ ë§¤í•‘ ì ìš© ì‹œì‘...');
        
        const mapping = {
            id: document.getElementById('map_id').value,
            entity: document.getElementById('map_entity').value,
            currency: document.getElementById('map_currency').value,
            amount: document.getElementById('map_amount').value,
            date: document.getElementById('map_date').value,
            type: document.getElementById('map_type').value
        };
        
        // í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
        const required = ['entity', 'currency', 'amount', 'date', 'type'];
        const missing = required.filter(key => !mapping[key]);
        
        if (missing.length > 0) {
            alert(`âš ï¸ í•„ìˆ˜ ì»¬ëŸ¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.\n\nëˆ„ë½: ${missing.join(', ')}`);
            return;
        }
        
        // ë°ì´í„° ë³€í™˜
        const mappedData = window.currentRawData.map((row, index) => {
            const result = {
                id: mapping.id ? row[mapping.id] : `DATA-${String(index + 1).padStart(4, '0')}`,
                entity: row[mapping.entity] || 'Unknown',
                currency: row[mapping.currency] || 'USD',
                amount: parseFloat(row[mapping.amount]) || 0,
                date: row[mapping.date] || new Date().toISOString().split('T')[0],
                type: normalizeType(row[mapping.type])
            };
            
            // ë‚ ì§œ ì •ê·œí™”
            if (typeof result.date === 'number') {
                const excelDate = XLSX.SSF.parse_date_code(result.date);
                result.date = `${excelDate.y}-${String(excelDate.m).padStart(2, '0')}-${String(excelDate.d).padStart(2, '0')}`;
            }
            
            return result;
        });
        
        console.log('âœ… ë§¤í•‘ ì™„ë£Œ:', mappedData.length, 'ê±´');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeMappingModal();
        
        // ë°ì´í„° ì²˜ë¦¬
        processUploadedData(mappedData);
    }

    // êµ¬ë¶„ ê°’ ì •ê·œí™”
    function normalizeType(value) {
        if (!value) return 'receivable';
        
        const str = String(value).toLowerCase();
        if (str.includes('ì±„ê¶Œ') || str.includes('ë§¤ì¶œ') || str.includes('receivable') || str.includes('recv')) {
            return 'receivable';
        } else if (str.includes('ì±„ë¬´') || str.includes('ë§¤ì…') || str.includes('payable') || str.includes('pay')) {
            return 'payable';
        }
        return 'receivable';
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeMappingModal() {
        const modal = document.getElementById('columnMappingModal');
        if (modal) {
            modal.remove();
        }
        window.currentRawData = null;
        window.currentExcelColumns = null;
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('fileInputDirect');
        if (fileInput) {
            fileInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                console.log('ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', file.name);
                
                try {
                    const data = await readFileData(file);
                    console.log('âœ… íŒŒì¼ ì½ê¸° ì™„ë£Œ:', data.length, 'ê±´');
                    
                    // ì»¬ëŸ¼ ë§¤í•‘ í•„ìš” ì—¬ë¶€ í™•ì¸
                    if (data.length > 0) {
                        const firstRow = data[0];
                        const hasStandardColumns = 
                            firstRow.hasOwnProperty('currency') &&
                            firstRow.hasOwnProperty('amount') &&
                            firstRow.hasOwnProperty('date') &&
                            firstRow.hasOwnProperty('type');
                        
                        if (!hasStandardColumns) {
                            console.log('âš ï¸ í‘œì¤€ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ ë§¤í•‘ UIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                            showColumnMappingModal(data, file.name);
                            e.target.value = '';
                            return;
                        }
                    }
                    
                    // í‘œì¤€ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì²˜ë¦¬
                    processUploadedData(data);
                    
                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    e.target.value = '';
                } catch (error) {
                    console.error('âŒ íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                }
            });
        }

        // í´ë” ì—…ë¡œë“œ ì´ë²¤íŠ¸
        const folderInput = document.getElementById('folderInputDirect');
        if (folderInput) {
            folderInput.addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                if (!files || files.length === 0) return;

                // Excel/CSV íŒŒì¼ë§Œ í•„í„°ë§
                const validFiles = files.filter(file => {
                    const ext = file.name.toLowerCase();
                    return ext.endsWith('.xlsx') || ext.endsWith('.xls') || ext.endsWith('.csv');
                });

                if (validFiles.length === 0) {
                    alert('í´ë”ì— Excel(.xlsx, .xls) ë˜ëŠ” CSV(.csv) íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                    e.target.value = '';
                    return;
                }

                console.log('ğŸ“ í´ë” ì—…ë¡œë“œ ì‹œì‘:', validFiles.length, 'ê°œ íŒŒì¼ ë°œê²¬');
                console.log('ğŸ“‚ íŒŒì¼ ëª©ë¡:', validFiles.map(f => f.name));

                let allData = [];
                let processedCount = 0;
                let errorFiles = [];

                // ì§„í–‰ ìƒí™© í‘œì‹œ
                const progressMessage = `ğŸ“ í´ë” ì—…ë¡œë“œ ì¤‘... (0/${validFiles.length})`;
                const tradeCountEl = document.getElementById('tradeCount');
                if (tradeCountEl) {
                    tradeCountEl.textContent = progressMessage;
                }

                try {
                    for (const file of validFiles) {
                        try {
                            console.log(`ğŸ“„ ì²˜ë¦¬ ì¤‘: ${file.name}`);
                            const data = await readFileData(file);
                            
                            // ê° ë°ì´í„°ì— ì›ë³¸ íŒŒì¼ëª… ì¶”ê°€
                            const dataWithSource = data.map(row => ({
                                ...row,
                                _sourceFile: file.name
                            }));
                            
                            allData = allData.concat(dataWithSource);
                            processedCount++;
                            
                            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                            if (tradeCountEl) {
                                tradeCountEl.textContent = `ğŸ“ í´ë” ì—…ë¡œë“œ ì¤‘... (${processedCount}/${validFiles.length})`;
                            }
                            
                            console.log(`âœ… ${file.name}: ${data.length}ê±´ ì²˜ë¦¬ ì™„ë£Œ`);
                        } catch (fileError) {
                            console.error(`âŒ ${file.name} ì²˜ë¦¬ ì˜¤ë¥˜:`, fileError);
                            errorFiles.push({ name: file.name, error: fileError.message });
                        }
                    }

                    if (allData.length === 0) {
                        alert('ëª¨ë“  íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜ ë°œìƒ íŒŒì¼:\n' + 
                              errorFiles.map(f => `- ${f.name}: ${f.error}`).join('\n'));
                        e.target.value = '';
                        return;
                    }

                    console.log(`ğŸ“Š ì´ ${allData.length}ê±´ì˜ ë°ì´í„° ë³‘í•© ì™„ë£Œ`);
                    
                    // ì»¬ëŸ¼ ë§¤í•‘ í•„ìš” ì—¬ë¶€ í™•ì¸
                    if (allData.length > 0) {
                        const firstRow = allData[0];
                        const hasStandardColumns = 
                            firstRow.hasOwnProperty('currency') &&
                            firstRow.hasOwnProperty('amount') &&
                            firstRow.hasOwnProperty('date') &&
                            firstRow.hasOwnProperty('type');
                        
                        if (!hasStandardColumns) {
                            console.log('âš ï¸ í‘œì¤€ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ ë§¤í•‘ UIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                            showColumnMappingModal(allData, `${validFiles.length}ê°œ íŒŒì¼ (í´ë” ì—…ë¡œë“œ)`);
                            e.target.value = '';
                            return;
                        }
                    }

                    // ë°ì´í„° ì²˜ë¦¬
                    processUploadedData(allData);

                    // ê²°ê³¼ ì•Œë¦¼
                    let resultMessage = `âœ… í´ë” ì—…ë¡œë“œ ì™„ë£Œ!\n\nì²˜ë¦¬ëœ íŒŒì¼: ${processedCount}ê°œ\nì´ ë°ì´í„°: ${allData.length}ê±´`;
                    if (errorFiles.length > 0) {
                        resultMessage += `\n\nâš ï¸ ì˜¤ë¥˜ ë°œìƒ íŒŒì¼ (${errorFiles.length}ê°œ):\n` + 
                                        errorFiles.map(f => `- ${f.name}`).join('\n');
                    }
                    alert(resultMessage);

                } catch (error) {
                    console.error('âŒ í´ë” ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('í´ë” ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                } finally {
                    e.target.value = '';
                }
            });
        }
    });

    // íŒŒì¼ ì½ê¸° í•¨ìˆ˜
    async function readFileData(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            
            reader.onload = (e) => {
                try {
                    let rawData = [];
                    
                    if (fileName.endsWith('.csv')) {
                        // CSV íŒŒì‹±
                        const text = e.target.result;
                        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
                        rawData = parsed.data;
                    } else {
                        // Excel íŒŒì‹± (ë‚ ì§œ ìë™ ë³€í™˜ ì˜µì…˜ í™œì„±í™”)
                        const workbook = XLSX.read(e.target.result, { 
                            type: 'binary',
                            cellDates: true,  // ë‚ ì§œë¥¼ Date ê°ì²´ë¡œ ìë™ ë³€í™˜
                            dateNF: 'yyyy-mm-dd'
                        });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        rawData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, dateNF: 'yyyy-mm-dd' });
                    }
                    
                    if (rawData.length === 0) {
                        throw new Error('íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    
                    console.log('====================================');
                    console.log('ğŸ“‹ Excel ì›ë³¸ ë°ì´í„° ì „ì²´ êµ¬ì¡°:');
                    console.log('ì²« ë²ˆì§¸ í–‰ì˜ ëª¨ë“  ì»¬ëŸ¼:', Object.keys(rawData[0]));
                    console.log('ì²« ë²ˆì§¸ í–‰ ì „ì²´ ë°ì´í„°:', rawData[0]);
                    console.log('====================================');
                    
                    // ë°ì´í„° í‘œì¤€í™”
                    const standardizedData = rawData.map((row, index) => {
                        console.log(`ì›ë³¸ ë°ì´í„° [${index}]:`, row);
                        
                        // í†µí™” ë§¤í•‘ (ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… ì§€ì›)
                        const currency = row.currency || row.Currency || row.CURRENCY ||
                                       row['í†µí™”'] || row['í†µí™”ì½”ë“œ'] || row['ì™¸í™”ì¢…ë¥˜'] || row['ì™¸í™”'] ||
                                       row['Currency'] || row['Ccy'] || row['ccy'] || 'USD';
                        
                        // ê¸ˆì•¡ ë§¤í•‘
                        const amount = parseFloat(
                            row.amount || row.Amount || row.AMOUNT ||
                            row['ê¸ˆì•¡'] || row['ì™¸í™”ê¸ˆì•¡'] || row['ê±°ë˜ê¸ˆì•¡'] || 0
                        );
                        
                        // ë‚ ì§œ ì²˜ë¦¬ ê°œì„ 
                        let date = row.date || row.Date || row.DATE ||
                                  row['ì¼ì'] || row['ë§Œê¸°ì¼'] || row['ê²°ì œì¼'] || row['ê²°ì œì˜ˆì •ì¼'] ||
                                  row['Date'] || row['ê±°ë˜ì¼'];
                        
                        console.log(`[${index}] ì›ë³¸ - í†µí™”: ${currency}, ê¸ˆì•¡: ${amount}, ë‚ ì§œ:`, date, typeof date);
                        
                        // ë¬¸ìì—´ ë‚ ì§œ ì²˜ë¦¬
                        if (typeof date === 'string') {
                            // YYYY-MM-DD í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                            if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                                // ê·¸ëŒ€ë¡œ ìœ ì§€
                            } else {
                                // ë‹¤ë¥¸ í˜•ì‹ì´ë©´ íŒŒì‹± ì‹œë„
                                const parsed = new Date(date);
                                if (!isNaN(parsed.getTime())) {
                                    date = parsed.toISOString().split('T')[0];
                                }
                            }
                        }
                        // Excel ë‚ ì§œ ì‹œë¦¬ì–¼ ìˆ«ì ë³€í™˜
                        else if (typeof date === 'number') {
                            const excelDate = XLSX.SSF.parse_date_code(date);
                            date = `${excelDate.y}-${String(excelDate.m).padStart(2, '0')}-${String(excelDate.d).padStart(2, '0')}`;
                        } 
                        // Date ê°ì²´
                        else if (date instanceof Date) {
                            date = date.toISOString().split('T')[0];
                        } 
                        // ë‚ ì§œ ì—†ìŒ
                        else {
                            date = new Date().toISOString().split('T')[0];
                        }
                        
                        console.log(`[${index}] ë³€í™˜ëœ ë‚ ì§œ:`, date);
                        
                        // êµ¬ë¶„ ë§¤í•‘ (ì±„ê¶Œ/ì±„ë¬´)
                        let type = row.type || row.Type || row.TYPE ||
                                  row['êµ¬ë¶„'] || row['ê±°ë˜êµ¬ë¶„'] || row['Type'];
                        
                        // êµ¬ë¶„ ê°’ ì •ê·œí™”
                        if (type) {
                            const typeStr = String(type).toLowerCase();
                            if (typeStr.includes('ì±„ê¶Œ') || typeStr.includes('ë§¤ì¶œ') || typeStr.includes('receivable') || typeStr.includes('recv')) {
                                type = 'receivable';
                            } else if (typeStr.includes('ì±„ë¬´') || typeStr.includes('ë§¤ì…') || typeStr.includes('payable') || typeStr.includes('pay')) {
                                type = 'payable';
                            } else {
                                type = amount > 0 ? 'receivable' : 'payable';
                            }
                        } else {
                            type = amount > 0 ? 'receivable' : 'payable';
                        }
                        
                        // ê±°ë˜ì²˜ ë§¤í•‘
                        const entity = row.entity || row.Entity || row.ENTITY ||
                                      row['ê±°ë˜ì²˜'] || row['ê±°ë˜ì²˜ëª…'] || row['ì—…ì²´ëª…'] || row['ê³ ê°ëª…'] ||
                                      row['Entity'] || row['Company'] || 'Unknown';
                        
                        // ID ë§¤í•‘
                        const id = row.id || row.ID || row.Id ||
                                  row['ë²ˆí˜¸'] || row['ê±°ë˜ë²ˆí˜¸'] || row['ID'] ||
                                  `DATA-${String(index + 1).padStart(4, '0')}`;
                        
                        const result = {
                            id,
                            currency,
                            amount: Math.abs(amount),
                            date,
                            type,
                            entity
                        };
                        
                        console.log(`í‘œì¤€í™” ë°ì´í„° [${index}]:`, result);
                        return result;
                    });
                    
                    resolve(standardizedData);
                } catch (error) {
                    reject(new Error('íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ' + error.message));
                }
            };
            
            reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
            
            if (fileName.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.addEventListener('load', loadDataFromSession);
    
    // ì¸ì¦ ì²´í¬ (ê²½ëŸ‰ í”Œë«í¼: ë¡œì»¬ ì „ìš©ì´ë¯€ë¡œ ì¸ì¦ ì„ íƒì )
    function checkAuthentication() {
        // â˜… ê²½ëŸ‰ í”Œë«í¼ ëª¨ë“œ: ì¸ì¦ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ â˜…
        const isLightweightMode = window.location.port === '7870' || 
                                   window.location.protocol === 'file:' ||
                                   localStorage.getItem('LIGHTWEIGHT_MODE') === 'true';
        
        if (isLightweightMode) {
            console.log('âœ… ê²½ëŸ‰ í”Œë«í¼ ëª¨ë“œ - ì¸ì¦ ìƒëµ');
            // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            const userEmailEl = document.getElementById('userEmail');
            const companyNameEl = document.getElementById('companyName');
            if (userEmailEl) userEmailEl.textContent = 'ë¡œì»¬ ì‚¬ìš©ì';
            if (companyNameEl) companyNameEl.textContent = 'ê²½ëŸ‰ í”Œë«í¼';
            return true;
        }
        
        const authInfo = api.loadToken();
        
        if (!authInfo) {
            // ë¡œê·¸ì¸ í•„ìš”
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
            return false;
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        if (authInfo.email) {
            document.getElementById('userEmail').textContent = authInfo.email;
        }
        if (authInfo.companyName) {
            document.getElementById('companyName').textContent = authInfo.companyName;
        }

        console.log('ì¸ì¦ í™•ì¸ ì™„ë£Œ:', authInfo.email);
        return true;
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function handleLogout(event) {
        if (event) event.preventDefault();
        
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                await api.logout();
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                // ì—ëŸ¬ê°€ ë‚˜ë„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                localStorage.removeItem('hedgefreedom_auth');
                sessionStorage.removeItem('hedgefreedom_auth');
                window.location.href = 'login.html';
            }
        }
    }

    // ì„œë²„ì—ì„œ ì‹¤ì‹œê°„ í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
    async function loadCurrentRates() {
        try {
            // ì‹¤ì‹œê°„ í™˜ìœ¨ ë°ì´í„° (2026ë…„ 2ì›” 2ì¼ ê¸°ì¤€)
            const rates = {
                'USD/KRW': { rate: 1342.50, change: 0.45, trend: 'up' },
                'EUR/USD': { rate: 1.0842, change: -0.12, trend: 'down' },
                'USD/JPY': { rate: 148.23, change: 0.28, trend: 'up' },
                'USD/CNY': { rate: 7.2145, change: -0.08, trend: 'down' },
                'DXY': { rate: 103.42, change: 0.15, trend: 'up' }
            };
            
            console.log('ì‹¤ì‹œê°„ í™˜ìœ¨ ë¡œë“œ:', rates);
            
            // í™˜ìœ¨ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateRateDisplay(rates);
        } catch (error) {
            console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
    }

    function updateRateDisplay(rates) {
        // í—¤ë”ì˜ í™˜ìœ¨ ì •ë³´ ì—…ë°ì´íŠ¸
        const rateContainers = document.querySelectorAll('header .flex.items-center.space-x-2');
        
        rateContainers.forEach(container => {
            const label = container.querySelector('.text-xs');
            const value = container.querySelector('.text-sm');
            const changeSpan = container.querySelector('.text-\\[10px\\]');
            
            if (label && value) {
                const pair = label.textContent.trim();
                const rateData = rates[pair];
                
                if (rateData) {
                    value.textContent = rateData.rate.toFixed(2);
                    
                    // ì¶”ì„¸ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                    if (rateData.trend === 'up') {
                        container.className = 'flex items-center space-x-2 px-3 py-1 bg-green-50 rounded';
                        value.className = 'text-sm font-bold text-green-600';
                        if (changeSpan) {
                            changeSpan.textContent = `â–²${Math.abs(rateData.change).toFixed(2)}%`;
                            changeSpan.className = 'text-[10px] text-green-600';
                        }
                    } else {
                        container.className = 'flex items-center space-x-2 px-3 py-1 bg-red-50 rounded';
                        value.className = 'text-sm font-bold text-red-600';
                        if (changeSpan) {
                            changeSpan.textContent = `â–¼${Math.abs(rateData.change).toFixed(2)}%`;
                            changeSpan.className = 'text-[10px] text-red-600';
                        }
                    }
                }
            }
        });

        // ê°±ì‹  ì‹œê°„ ì—…ë°ì´íŠ¸
        const refreshTime = document.querySelector('header .text-\\[10px\\]');
        if (refreshTime) {
            const now = new Date();
            const secondsAgo = Math.floor(Math.random() * 60);
            refreshTime.textContent = `ê°±ì‹  ${secondsAgo}ì´ˆì „`;
        }

        console.log('í™˜ìœ¨ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }

    // ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
        // ì¸ì¦ ì²´í¬
        if (!checkAuthentication()) {
            return;
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
        localStorageManager.initialize().catch(err => {
            console.warn('ë¡œì»¬ í´ë” ì´ˆê¸°í™” ì‹¤íŒ¨, localStorage ì‚¬ìš©:', err);
        });

        // ì„¸ì…˜ ë°ì´í„° ë¡œë“œ
        loadDataFromSession();

        // ì„œë²„ ë¶„ì„ ê²°ê³¼ ë¡œë“œ ë° í‘œì‹œ
        loadServerAnalysisResults();

        // ì‹¤ì‹œê°„ í™˜ìœ¨ ë¡œë“œ
        loadCurrentRates();
    });

    // ì„œë²„ ë¶„ì„ ê²°ê³¼ ë¡œë“œ ë° í—¤ì§€ ì „ëµ í‘œì‹œ
    function loadServerAnalysisResults() {
        try {
            // ì„œë²„ ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (localStorage ìš°ì„ )
            const analysisResults = localStorage.getItem('analysisResults');
            const hedgeStrategies = localStorage.getItem('hedgeStrategies');
            const riskMetrics = localStorage.getItem('riskMetrics');

            if (!analysisResults) {
                console.log('ì„œë²„ ë¶„ì„ ê²°ê³¼ ì—†ìŒ');
                return;
            }

            const results = JSON.parse(analysisResults);
            const strategies = hedgeStrategies ? JSON.parse(hedgeStrategies) : [];
            const metrics = riskMetrics ? JSON.parse(riskMetrics) : {};

            console.log('ì„œë²„ ë¶„ì„ ê²°ê³¼ ë¡œë“œ:', results);
            console.log('í—¤ì§€ ì „ëµ:', strategies);
            console.log('ë¦¬ìŠ¤í¬ ì§€í‘œ:', metrics);

            // 1. KPI ì—…ë°ì´íŠ¸
            updateHedgeKPIs(results, metrics);

            // 2. í—¤ì§€ ì‹¤í–‰ ì œì•ˆ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateHedgeProposalsTable(strategies);

            // 3. VaR ì˜í–¥ ì—…ë°ì´íŠ¸
            updateVaRImpact(metrics);

            // 4. ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸
            updateSensitivityAnalysis(metrics);

            // 5. ìƒë‹¨ ì•Œë¦¼ ë°°ë„ˆ í‘œì‹œ
            showAnalysisCompleteBanner(results);

        } catch (error) {
            console.error('ì„œë²„ ê²°ê³¼ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
    }

    // KPI ì—…ë°ì´íŠ¸
    function updateHedgeKPIs(results, metrics) {
        // í˜„ì¬ í—¤ì§€ ë¹„ìœ¨ ì—…ë°ì´íŠ¸
        const currentHedgeRatio = metrics.currentHedgeRatio || 42;
        const kpiElement = document.querySelector('main section .bg-white:nth-child(2) .text-3xl');
        if (kpiElement) {
            kpiElement.textContent = currentHedgeRatio + '%';
        }

        // ê°­ í‘œì‹œ ì—…ë°ì´íŠ¸
        const gap = 75 - currentHedgeRatio;
        const gapElement = document.querySelector('main section .bg-white:nth-child(3) .text-3xl');
        if (gapElement) {
            gapElement.textContent = gap + '%';
        }
    }

    // í—¤ì§€ ì‹¤í–‰ ì œì•ˆ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateHedgeProposalsTable(strategies) {
        if (!strategies || strategies.length === 0) return;

        const tbody = document.querySelector('section.action-card tbody');
        if (!tbody) return;

        // ê¸°ì¡´ í–‰ ì œê±°
        tbody.innerHTML = '';

        // ì„œë²„ ì „ëµìœ¼ë¡œ í…Œì´ë¸” ì±„ìš°ê¸°
        strategies.forEach(strategy => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-blue-50';
            
            const priority = strategy.priority || 'MEDIUM';
            const priorityClass = priority === 'HIGH' ? 'bg-red-100 text-red-700' :
                                 priority === 'MEDIUM' ? 'bg-yellow-100 text-yellow-700' :
                                 'bg-green-100 text-green-700';

            // KRW ê¸ˆì•¡ í¬ë§·
            const krwAmount = strategy.krwAmount ? 
                `â‚©${strategy.krwAmount.toLocaleString('ko-KR')}` : 
                'ê³„ì‚°ì¤‘';

            // ì€í–‰ ì •ë³´
            const bankInfo = strategy.recommendedBank !== 'ì€í–‰ ì—°ë™ ì¤€ë¹„ì¤‘' ?
                `<span class="font-bold">${strategy.recommendedBank}</span>
                 <p class="text-[10px] text-green-600 font-medium">ìµœìš°ìˆ˜ ê²¬ì : ${strategy.rate}</p>
                 ${strategy.allQuotes ? `<p class="text-[9px] text-gray-400 mt-1">${strategy.allQuotes}</p>` : ''}` :
                `<span class="font-bold text-gray-400">${strategy.recommendedBank}</span>
                 <p class="text-[10px] text-gray-400">${strategy.rate}</p>`;

            tr.innerHTML = `
                <td class="p-4"><span class="px-2 py-1 ${priorityClass} rounded-full font-bold">${
                    priority === 'HIGH' ? 'ë†’ìŒ' : priority === 'MEDIUM' ? 'ì¤‘ê°„' : 'ë‚®ìŒ'
                }</span></td>
                <td class="p-4">
                    <p class="font-bold text-gray-800">${strategy.instrument || 'FX Forward'}</p>
                    <p class="text-[10px] text-gray-400 italic">${strategy.description || 'ì„œë²„ ì¶”ì²œ ì „ëµ'}</p>
                    ${strategy.premium ? `<p class="text-[10px] text-blue-600 mt-1">í”„ë¦¬ë¯¸ì—„: $${strategy.premium.toLocaleString('ko-KR')} (${strategy.premiumPercent})</p>` : ''}
                </td>
                <td class="p-4 font-bold text-blue-700">${strategy.currency || 'USD'} / KRW</td>
                <td class="p-4">
                    <p class="font-bold">$${(strategy.amount || 0).toLocaleString('ko-KR')}</p>
                    <p class="text-[10px] text-gray-500">${krwAmount}</p>
                </td>
                <td class="p-4">
                    <p class="font-mono">${strategy.maturityDate || '2026-06-30'}</p>
                    <p class="text-[10px] text-gray-500">${strategy.daysToMaturity || 0}ì¼ í›„</p>
                </td>
                <td class="p-4">
                    ${bankInfo}
                    ${strategy.currentSpot ? `<p class="text-[9px] text-gray-400 mt-1">í˜„ë¬¼: ${strategy.currentSpot}</p>` : ''}
                    ${strategy.forwardPoints ? `<p class="text-[9px] text-gray-400">FP: ${strategy.forwardPoints}p</p>` : ''}
                </td>
                <td class="p-4 text-center">
                    <button class="px-4 py-1.5 border border-blue-600 text-blue-600 rounded-sm font-bold hover:bg-blue-600 hover:text-white transition"
                            onclick="executeHedgeStrategy('${strategy.currency}', ${strategy.amount}, '${strategy.maturityDate}', '${strategy.instrument}')">
                        ì‹¤í–‰
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        console.log(`âœ… ${strategies.length}ê°œ í—¤ì§€ ì „ëµì´ í…Œì´ë¸”ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // í—¤ì§€ ì „ëµ ì‹¤í–‰ í•¨ìˆ˜
    function executeHedgeStrategy(currency, amount, maturityDate, instrument) {
        const confirmation = confirm(
            `í—¤ì§€ ì „ëµ ì‹¤í–‰ í™•ì¸\n\n` +
            `ìƒí’ˆ: ${instrument}\n` +
            `í†µí™”: ${currency}\n` +
            `ê¸ˆì•¡: $${amount.toLocaleString('ko-KR')}\n` +
            `ë§Œê¸°: ${maturityDate}\n\n` +
            `ì€í–‰ ì—°ë™ ê¸°ëŠ¥ ê°œë°œ ì™„ë£Œ í›„ ì‹¤ì œ ê±°ë˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n` +
            `í˜„ì¬ëŠ” ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.\n\n` +
            `ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
        );

        if (confirmation) {
            // ì‹¤í–‰ ë¡œê·¸ ê¸°ë¡
            console.log('í—¤ì§€ ì „ëµ ì‹¤í–‰ ìš”ì²­:', {
                currency, amount, maturityDate, instrument,
                timestamp: new Date().toISOString()
            });

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const executedTrades = JSON.parse(localStorage.getItem('executedTrades') || '[]');
            executedTrades.push({
                currency, amount, maturityDate, instrument,
                status: 'pending_bank_integration',
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('executedTrades', JSON.stringify(executedTrades));

            alert(
                `âœ… ì‹¤í–‰ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                `ì€í–‰ ì—°ë™ ì‹œìŠ¤í…œì´ êµ¬ì¶•ë˜ë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.\n` +
                `ìš”ì²­ ë‚´ì—­ì€ ê±°ë˜ ë‚´ì—­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
            );
        }
    }

    // VaR ì˜í–¥ ì—…ë°ì´íŠ¸
    function updateVaRImpact(metrics) {
        const currentVaR = metrics.currentVaR || 3400000;
        const projectedVaR = metrics.projectedVaR || 800000;
        
        // USDë¥¼ ì–µì›ìœ¼ë¡œ ë³€í™˜ (í™˜ìœ¨ 1350ì› ê¸°ì¤€)
        const toEokWon = (usd) => ((usd * 1350) / 100000000).toFixed(1);

        // VaR ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
        const varElements = document.querySelectorAll('.text-2xl.font-bold');
        varElements.forEach((el, index) => {
            if (el.classList.contains('text-red-500') || el.textContent.includes('ì–µì›') || el.textContent.includes('M')) {
                if (index === 0 || el.classList.contains('text-red-500')) {
                    el.textContent = `${toEokWon(currentVaR)}ì–µì›`;
                    el.className = 'text-2xl font-bold text-red-500';
                }
            }
        });

        const projectedElements = document.querySelectorAll('.text-2xl.font-bold.text-green-600');
        if (projectedElements.length > 0) {
            projectedElements[0].textContent = `${toEokWon(projectedVaR)}ì–µì›`;
        }

        // ê°ì†Œìœ¨ ê³„ì‚° ë° í‘œì‹œ
        const reduction = ((1 - projectedVaR / currentVaR) * 100).toFixed(0);
        console.log(`VaR ì˜í–¥: í˜„ì¬ ${toEokWon(currentVaR)}ì–µì› â†’ ì˜ˆìƒ ${toEokWon(projectedVaR)}ì–µì› (${reduction}% ê°ì†Œ)`);
    }

    // ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸
    function updateSensitivityAnalysis(metrics) {
        const upside = metrics.upsideScenario || { change: '+5%', impact: '+$1.2M', hedgedImpact: '+$0.4M' };
        const downside = metrics.downsideScenario || { change: '-5%', impact: '-$0.4M', hedgedImpact: '-$0.1M' };

        // ë¯¼ê°ë„ ë¶„ì„ ì„¹ì…˜ ì°¾ê¸°
        const sensitivitySection = Array.from(document.querySelectorAll('h4')).find(el => 
            el.textContent.includes('ë¯¼ê°ë„ ë¶„ì„')
        );

        if (sensitivitySection) {
            const container = sensitivitySection.closest('.bg-white');
            if (container) {
                const contentDiv = container.querySelector('.space-y-3');
                if (contentDiv) {
                    contentDiv.innerHTML = `
                        <div class="flex justify-between text-xs">
                            <span>USD/KRW ${upside.change} ì‹œ</span>
                            <span class="text-green-600 font-bold">${upside.impact} ì´ìµ</span>
                        </div>
                        <div class="w-full bg-gray-100 h-2 rounded-full">
                            <div class="bg-green-500 h-full rounded-full" style="width: 75%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>í—¤ì§€ í›„</span>
                            <span class="font-semibold">${upside.hedgedImpact} (ì œí•œì  ì´ìµ)</span>
                        </div>
                        <div class="h-4"></div>
                        <div class="flex justify-between text-xs">
                            <span>USD/KRW ${downside.change} ì‹œ</span>
                            <span class="text-red-500 font-bold">${downside.impact} ì†ì‹¤</span>
                        </div>
                        <div class="w-full bg-gray-100 h-2 rounded-full">
                            <div class="bg-red-400 h-full rounded-full" style="width: 25%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span>í—¤ì§€ í›„</span>
                            <span class="font-semibold text-green-600">${downside.hedgedImpact} (ì†ì‹¤ ì œí•œ)</span>
                        </div>
                    `;
                }
            }
        }

        console.log('ë¯¼ê°ë„ ë¶„ì„ ì—…ë°ì´íŠ¸:', { upside, downside });
    }

    // ë¶„ì„ ì™„ë£Œ ë°°ë„ˆ í‘œì‹œ
    function showAnalysisCompleteBanner(results) {
        const main = document.querySelector('main');
        if (!main) return;

        // ê¸°ì¡´ ë°°ë„ˆ ì œê±°
        const existingBanner = document.getElementById('analysisBanner');
        if (existingBanner) existingBanner.remove();

        const banner = document.createElement('div');
        banner.id = 'analysisBanner';
        banner.className = 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-lg shadow-lg mb-6';
        banner.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">ğŸ¯</div>
                    <div>
                        <h3 class="text-lg font-bold">ì„œë²„ ë¶„ì„ ì™„ë£Œ</h3>
                        <p class="text-sm text-blue-100">
                            AI ê¸°ë°˜ í—¤ì§€ ì „ëµì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 
                            ${(results.hedgeStrategies || []).length}ê°œì˜ ì‹¤í–‰ ê°€ëŠ¥í•œ ì „ëµì„ í™•ì¸í•˜ì„¸ìš”.
                        </p>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" 
                        class="text-white hover:text-blue-200 text-2xl font-bold px-2">
                    Ã—
                </button>
            </div>
            <div class="mt-3 grid grid-cols-4 gap-4 text-sm">
                <div class="bg-white bg-opacity-20 rounded px-3 py-2">
                    <div class="text-blue-100 text-xs">ë¶„ì„ ë°ì´í„°</div>
                    <div class="font-bold">${results.dataCount || 0}ê±´</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded px-3 py-2">
                    <div class="text-blue-100 text-xs">í†µí™”</div>
                    <div class="font-bold">${results.currencyCount || 0}ê°œ</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded px-3 py-2">
                    <div class="text-blue-100 text-xs">VaR ê°ì†Œ</div>
                    <div class="font-bold text-green-300">${results.varReduction || '76%'}</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded px-3 py-2">
                    <div class="text-blue-100 text-xs">ë¶„ì„ ì‹œê°„</div>
                    <div class="font-bold">${new Date().toLocaleTimeString('ko-KR')}</div>
                </div>
            </div>
        `;

        main.insertBefore(banner, main.firstChild);
    }
    
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ì„œë²„ ì„¤ì • ê¸°ëŠ¥ (ë„¤ì´ë²„ í´ë¼ìš°ë“œ ë“± ì™¸ë¶€ ì„œë²„ ì—°ê²°)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    // ì„œë²„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateServerStatus() {
        const serverUrl = window.HedgeFreedomConfig?.CALCULATOR_SERVER || '';
        const statusDot = document.getElementById('serverStatusDot');
        const statusText = document.getElementById('serverStatusText');
        
        if (serverUrl) {
            // ì™¸ë¶€ ì„œë²„ ì„¤ì •ë¨
            statusText.textContent = `ê³„ì‚° ì„œë²„: ${new URL(serverUrl).hostname}`;
            checkServerHealth(serverUrl);
        } else {
            // ë¡œì»¬ ì„œë²„
            statusText.textContent = 'ê³„ì‚° ì„œë²„: ë¡œì»¬';
            statusDot.className = 'w-2 h-2 bg-green-500 rounded-full';
        }
    }
    
    // ì„œë²„ í—¬ìŠ¤ì²´í¬
    async function checkServerHealth(serverUrl) {
        const statusDot = document.getElementById('serverStatusDot');
        try {
            const response = await fetch(`${serverUrl}/api/health`, { 
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });
            if (response.ok) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full';
            } else {
                statusDot.className = 'w-2 h-2 bg-yellow-500 rounded-full';
            }
        } catch (error) {
            statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
            console.warn('ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', error);
        }
    }
    
    // ì„œë²„ ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
    function showServerSettings() {
        const currentServer = window.HedgeFreedomConfig?.CALCULATOR_SERVER || '';
        
        const modal = document.createElement('div');
        modal.id = 'serverSettingsModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl w-[500px] max-w-[90vw]">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-bold">âš™ï¸ ê³„ì‚° ì„œë²„ ì„¤ì •</h2>
                    <button onclick="closeServerSettings()" class="text-gray-500 hover:text-gray-700 text-xl">Ã—</button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                        <p class="font-bold text-blue-700">ğŸ”’ í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜</p>
                        <p class="text-blue-600 mt-1">
                            ê³ ê° ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.<br>
                            ì„œë²„ëŠ” ìµëª…í™”ëœ ìˆ«ìë§Œ ë°›ì•„ ê³„ì‚°ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì‚° ì„œë²„ URL</label>
                        <input type="text" id="serverUrlInput" 
                               value="${currentServer}"
                               placeholder="ë¹ˆì¹¸ = ë¡œì»¬ ì„œë²„ (http://localhost:7870)"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">
                            ì˜ˆ: https://your-naver-cloud-server.kr
                        </p>
                    </div>
                    
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-700">ë¹ ë¥¸ ì„ íƒ:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setServerUrl('')" 
                                    class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">
                                ğŸ  ë¡œì»¬ ì„œë²„
                            </button>
                            <button onclick="setServerUrl('http://localhost:7870')" 
                                    class="px-3 py-1 text-sm bg-blue-100 hover:bg-blue-200 rounded text-blue-700">
                                ğŸ’» ê²½ëŸ‰ í”Œë«í¼ (7870)
                            </button>
                            <button onclick="setServerUrl('http://localhost:7860')" 
                                    class="px-3 py-1 text-sm bg-purple-100 hover:bg-purple-200 rounded text-purple-700">
                                ğŸ¢ ì¤‘ëŸ‰ í”Œë«í¼ (7860)
                            </button>
                        </div>
                    </div>
                    
                    <div id="serverTestResult" class="hidden p-3 rounded text-sm"></div>
                </div>
                <div class="p-4 border-t bg-gray-50 flex justify-between">
                    <button onclick="testServerConnection()" 
                            class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                        ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                    <div class="space-x-2">
                        <button onclick="closeServerSettings()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="saveServerSettings()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function setServerUrl(url) {
        document.getElementById('serverUrlInput').value = url;
    }
    
    function closeServerSettings() {
        const modal = document.getElementById('serverSettingsModal');
        if (modal) modal.remove();
    }
    
    async function testServerConnection() {
        const url = document.getElementById('serverUrlInput').value.trim();
        const resultDiv = document.getElementById('serverTestResult');
        resultDiv.className = 'p-3 rounded text-sm bg-yellow-100 text-yellow-700';
        resultDiv.textContent = 'â³ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
        resultDiv.classList.remove('hidden');
        
        const testUrl = url || window.location.origin;
        
        try {
            const response = await fetch(`${testUrl}/api/health`, {
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });
            
            if (response.ok) {
                const data = await response.json();
                resultDiv.className = 'p-3 rounded text-sm bg-green-100 text-green-700';
                resultDiv.innerHTML = `âœ… ì—°ê²° ì„±ê³µ!<br>ì„œë²„: ${data.server || 'unknown'} | ë²„ì „: ${data.version || 'unknown'}`;
            } else {
                resultDiv.className = 'p-3 rounded text-sm bg-red-100 text-red-700';
                resultDiv.textContent = `âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})`;
            }
        } catch (error) {
            resultDiv.className = 'p-3 rounded text-sm bg-red-100 text-red-700';
            resultDiv.textContent = `âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
        }
    }
    
    function saveServerSettings() {
        const url = document.getElementById('serverUrlInput').value.trim();
        
        if (window.HedgeFreedomConfig) {
            window.HedgeFreedomConfig.setCalculatorServer(url, true);
        } else {
            localStorage.setItem('CALCULATOR_SERVER', url);
        }
        
        updateServerStatus();
        closeServerSettings();
        showNotification('success', `ì„œë²„ ì„¤ì • ì €ì¥ë¨: ${url || 'ë¡œì»¬'}`);
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(updateServerStatus, 500);
    });
    </script>

    <script>
    // ìë™ ì„œë²„ ê³„ì‚° ìš”ì²­: uploadedDataê°€ ìˆê³  serverAnalysisResultê°€ ì—†ì„ ë•Œ í•œ ë²ˆë§Œ ìš”ì²­
    (function setupAutoServerAnalysisRequester(){
        const POLL_INTERVAL = 3000; // ms
        async function requestBatchIfNeeded() {
            try {
                const uploadedRaw = localStorage.getItem('uploadedData');
                if (!uploadedRaw) return;

                const uploadedTimestamp = localStorage.getItem('uploadedDataTimestamp') || '';
                const lastRequested = localStorage.getItem('serverAnalysisRequestedAt') || '';

                // ì´ë¯¸ ì„œë²„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ
                if (localStorage.getItem('serverAnalysisResult')) return;

                // ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ìƒˆë¡œì›Œì¡Œê³  ë§ˆì§€ë§‰ ìš”ì²­ ì´í›„ë¼ë©´ ìš”ì²­ ì‹¤í–‰
                if (uploadedTimestamp && uploadedTimestamp === lastRequested) return;

                console.log('ìë™: ì„œë²„ ë°°ì¹˜ ê³„ì‚° ìš”ì²­ ì‹œë„...');

                const data = JSON.parse(uploadedRaw);
                const currencySummary = {};
                data.forEach(item => {
                    const c = item.currency || 'USD';
                    if (!currencySummary[c]) currencySummary[c] = { receivable: 0, payable: 0 };
                    if (item.type === 'receivable') currencySummary[c].receivable += Number(item.amount) || 0;
                    else currencySummary[c].payable += Number(item.amount) || 0;
                });

                const payload = { currencySummary, maturityBuckets: {}, options: { targetHedgeRatio: 75 } };

                // ê¸°ë¡: ìš”ì²­ ì‹œê°„(ì—…ë¡œë“œ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ì—°ê²°)
                localStorage.setItem('serverAnalysisRequestedAt', uploadedTimestamp);

                try {
                    const serverUrl = (window.HedgeFreedomConfig && HedgeFreedomConfig.CALCULATOR_SERVER) ? HedgeFreedomConfig.CALCULATOR_SERVER : '';
                    const res = await fetch((serverUrl || '') + '/api/calculator/batch', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const json = await res.json();

                    // ì €ì¥ ë° ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜
                    localStorage.setItem('serverAnalysisResult', JSON.stringify(json));
                    try { window.dispatchEvent(new CustomEvent('serverAnalysisResultUpdated', { detail: json })); } catch(e){}

                    console.log('ìë™: ì„œë²„ ê³„ì‚° ì™„ë£Œ ë° ì €ì¥');
                } catch (err) {
                    console.warn('ìë™: ì„œë²„ ê³„ì‚° ì‹¤íŒ¨:', err.message);
                    // ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í´ë§ì—ì„œ ì¬ì‹œë„
                    localStorage.removeItem('serverAnalysisRequestedAt');
                }
            } catch (e) {
                console.error('ìë™ ì„œë²„ ë¶„ì„ ì²˜ë¦¬ ì˜¤ë¥˜:', e);
            }
        }

        // í´ë§ ì‹œì‘
        setInterval(requestBatchIfNeeded, POLL_INTERVAL);
        // ë˜í•œ DOMContentLoaded ì§í›„ í•œ ë²ˆ ì‹œë„
        window.addEventListener('DOMContentLoaded', requestBatchIfNeeded);
    })();
    </script>

</body>
</html>