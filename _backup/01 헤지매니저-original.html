<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>HedgeFreedom - í—¤ì§€ ë§¤ë‹ˆì € (v2.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="core/local-storage-handler.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .hedgefreedom-blue { color: #0056b3; }
        .bg-hedgefreedom-dark { background-color: #001529; }
        .action-card {
            background: white;
            border-top: 4px solid #1890ff;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .btn-execute {
            background-color: #1890ff;
            color: white;
            transition: all 0.2s;
        }
        .btn-execute:hover {
            background-color: #096dd9;
        }
        
        .indicator-red {
            color: #f5222d;
            background: #fff1f0;
            border: 1px solid #ffa39e;
        }
        .indicator-green {
            color: #52c41a;
            background: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        
        .status-unhedged { color: #f5222d; font-weight: bold; }
        .status-partial { color: #fa8c16; font-weight: bold; }
        .status-full { color: #52c41a; font-weight: bold; }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="bg-hedgefreedom-dark w-60 flex-shrink-0 text-gray-400 text-sm h-screen overflow-y-auto">
        <div class="p-6 text-white border-b border-gray-800">
            <div class="text-xl font-bold">HEDGEFREEDOM</div>
            <div class="text-[10px] text-gray-500 mt-1">powered by hedgeOn</div>
        </div>
        <nav class="mt-4 pb-20">
            <div class="px-6 py-2 text-[10px] text-gray-600 uppercase tracking-wider">í•µì‹¬ ê¸°ëŠ¥</div>
            <a href="01 í—¤ì§€ë§¤ë‹ˆì €.html" class="flex items-center px-6 py-3 bg-blue-600 text-white font-medium">
                <span class="bg-white text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">1</span>
                í—¤ì§€ ë§¤ë‹ˆì €
            </a>
            <a href="02 ë…¸ì¶œë¶„ì„ .html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="bg-gray-700 text-gray-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">2</span>
                ë…¸ì¶œ ë¶„ì„
            </a>
            <a href="03 ìœ„í—˜ë³´ê³ ì„œ.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="bg-gray-700 text-gray-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3">3</span>
                ìœ„í—˜ ë³´ê³ ì„œ
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            <div class="px-6 py-2 text-[10px] text-gray-600 uppercase tracking-wider">ì•Œë¦¼ & ëª¨ë‹ˆí„°ë§</div>
            
            <a href="ì´íƒˆì•Œë¦¼.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ””</span> ì´íƒˆ ì•Œë¦¼
            </a>
            <a href="ë³€ë™ì„±ì•Œë¦¼.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ“ˆ</span> ë³€ë™ì„± ì•Œë¦¼
            </a>
            <a href="ì‹¤ì‹œê°„ëª¨ë‹ˆí„°.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">âš¡</span> ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            <div class="px-6 py-2 text-[10px] text-gray-600 uppercase tracking-wider">ê±°ë˜ & í˜‘ìƒ</div>
            
            <a href="ë„¤ê³ ìš©ë¸Œë¦¬í•‘.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ“‹</span> ë„¤ê³ ìš© ë¸Œë¦¬í•‘
            </a>
            <a href="í˜‘ìƒì´ë ¥.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ“</span> í˜‘ìƒ ì´ë ¥
            </a>
            <a href="ê²°ì œíƒ€ì´ë°.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">â°</span> ê²°ì œ íƒ€ì´ë°
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            <div class="px-6 py-2 text-[10px] text-gray-600 uppercase tracking-wider">ë¶„ì„ & ì‹œë®¬ë ˆì´ì…˜</div>
            
            <a href="ë§ˆì§„ë²¤ì¹˜ë§ˆí¬.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ“Š</span> ë§ˆì§„ ë²¤ì¹˜ë§ˆí¬
            </a>
            <a href="íƒ€ì‚¬í™˜ìœ¨ë­í‚¹.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ†</span> íƒ€ì‚¬ í™˜ìœ¨ ë­í‚¹
            </a>
            <a href="í™˜ì°¨ì†ìµì‹œë®¬ë ˆì´ì…˜.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ’°</span> í™˜ì°¨ì†ìµ ì‹œë®¬ë ˆì´ì…˜
            </a>
            <a href="ë¶„ì„ëŒ€ì‹œë³´ë“œ.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ“‰</span> ë¶„ì„ ëŒ€ì‹œë³´ë“œ
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            <div class="px-6 py-2 text-[10px] text-gray-600 uppercase tracking-wider">ì „ëµ & ë³´ê³ </div>
            
            <a href="ë‹¬ëŸ¬ì„ ë¬¼í™œìš©.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ¯</span> ë‹¬ëŸ¬ ì„ ë¬¼ í™œìš©
            </a>
            <a href="ì‚¬í›„ë³´ê³ ì„œ.html" class="flex items-center px-6 py-3 hover:bg-gray-800">
                <span class="mr-3">ğŸ“„</span> ì‚¬í›„ ë³´ê³ ì„œ
            </a>
            
            <div class="border-t border-gray-800 my-4"></div>
            
            <a href="login.html" class="flex items-center px-6 py-3 hover:bg-gray-800 text-red-400">
                ğŸšª ë¡œê·¸ì•„ì›ƒ
            </a>
            
            <div class="px-6 py-4 mt-8 border-t border-gray-800">
                <div class="text-xs text-gray-500">ë¡œê·¸ì¸:</div>
                <div id="userEmail" class="text-sm text-gray-300 truncate">demo@hedgefreedom.com</div>
                <div id="companyName" class="text-xs text-gray-500 mt-1">ë°ëª¨ íšŒì‚¬</div>
                <div class="text-[10px] text-gray-600 mt-2">www.hedgefreedom.com</div>
            </div>
        </nav>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="flex-1 flex flex-col overflow-hidden">
        
        <!-- í—¤ë” -->
        <header class="bg-white border-b">
            <div class="flex justify-between items-center px-8 py-0.5 border-b border-gray-50">
                <div class="flex items-center space-x-2">
                    <span id="serverStatusDot" class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span id="serverStatusText" class="text-[10px] text-gray-500">ì„œë²„: ì •ìƒ</span>
                </div>
                <span id="lastUpdate" class="text-[10px] text-gray-400 font-light">ê°±ì‹  ì¤‘...</span>
            </div>
            <div class="h-14 flex items-center justify-between px-8">
                <div id="exchangeRates" class="flex items-center space-x-6 flex-1">
                    <!-- í™˜ìœ¨ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>
        </header>

        <!-- ë©”ì¸ ì˜ì—­ -->
        <main class="p-6 overflow-y-auto space-y-6">
            
            <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <section class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-dashed border-green-300 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800 mb-1">ğŸ“¤ ê±°ë˜ ë°ì´í„° ì—…ë¡œë“œ</h3>
                        <p class="text-xs text-gray-600 mb-3">ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ìµëª…í™”ë˜ì–´ ì„œë²„ë¡œ ì „ì†¡ë©ë‹ˆë‹¤</p>
                        <div class="flex items-center gap-3">
                            <input 
                                type="file" 
                                id="excelFileInput" 
                                accept=".xlsx,.xls" 
                                class="hidden"
                                onchange="handleFileSelect(event)"
                            />
                            <button 
                                onclick="document.getElementById('excelFileInput').click()" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 shadow-md flex items-center gap-2"
                            >
                                ğŸ“ íŒŒì¼ ì„ íƒ
                            </button>
                            <span id="selectedFileName" class="text-sm text-gray-500 italic">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                            <button 
                                id="uploadBtn" 
                                onclick="uploadExcelFile()" 
                                disabled
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                â¬†ï¸ ì—…ë¡œë“œ ë° ê³„ì‚°
                            </button>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 mb-1">ì§€ì› í˜•ì‹</div>
                        <div class="text-sm font-bold text-green-600">.xlsx, .xls</div>
                        <div class="text-xs text-gray-500 mt-2">ìµœëŒ€ 10MB</div>
                    </div>
                </div>
                <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ -->
                <div id="uploadProgress" class="mt-4 hidden">
                    <div class="bg-white rounded-lg p-3 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-semibold text-gray-700">ì—…ë¡œë“œ ì§„í–‰ ì¤‘...</span>
                            <span id="uploadPercentage" class="text-xs text-blue-600 font-bold">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="uploadProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="uploadStatus" class="text-xs text-gray-500 mt-2">íŒŒì¼ ì½ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </section>
            
            <!-- ê±°ë˜ í¬ì§€ì…˜ í…Œì´ë¸” -->
            <section class="action-card overflow-hidden">
                <div class="p-4 bg-gradient-to-r from-blue-600 to-indigo-600 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg text-white">ğŸ“Š ì—…ë¡œë“œëœ ê±°ë˜ ë°ì´í„°</h3>
                        <p class="text-xs text-blue-100 mt-1">ê³ ê°ë³„ ê±°ë˜ í¬ì§€ì…˜ ë° í—¤ì§€ í˜„í™©</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tradeCount" class="text-sm font-bold text-white bg-blue-500 px-4 py-2 rounded-lg">ë¡œë”© ì¤‘...</span>
                        <button onclick="refreshData()" class="px-4 py-2 bg-white text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-50 flex items-center gap-2">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button id="calculateHedgeBtn" onclick="calculateHedgeStrategy()" class="px-6 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg text-sm font-bold hover:from-orange-600 hover:to-red-600 shadow-lg">
                            âš¡ í—¤ì§€ ì „ëµ ê³„ì‚°
                        </button>
                    </div>
                </div>
                
                <!-- ë¡œë”© í‘œì‹œ -->
                <div id="loadingIndicator" class="p-8 text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                
                <!-- í¬ì§€ì…˜ í…Œì´ë¸” -->
                <div id="positionsTableContainer" class="overflow-auto max-h-60" style="display: none;">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-white text-gray-400 border-b sticky top-0">
                            <tr>
                                <th class="p-3 uppercase tracking-wider font-bold">ê±°ë˜ID</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ê±°ë˜ì²˜ëª…</th>
                                <th class="p-3 uppercase tracking-wider font-bold">í†µí™”</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ì™¸í™”ê¸ˆì•¡</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ê²°ì œì˜ˆì •ì¼</th>
                                <th class="p-3 uppercase tracking-wider font-bold">êµ¬ë¶„</th>
                                <th class="p-3 uppercase tracking-wider font-bold">ì›í™”í™˜ì‚°ì•¡</th>
                                <th class="p-3 uppercase tracking-wider font-bold">D-Day</th>
                                <th class="p-3 uppercase tracking-wider font-bold">í—¤ì§€ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="positionsTableBody" class="divide-y divide-gray-100">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- KPI ì„¹ì…˜ -->
            <section id="kpiSection" class="grid grid-cols-3 gap-6">
                <div class="bg-white p-5 rounded shadow-sm flex flex-col relative">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-gray-400">ëª©í‘œ í—¤ì§€ ë¹„ìœ¨</span>
                        <button 
                            id="editTargetRatioBtn" 
                            onclick="toggleEditTargetRatio()" 
                            class="text-gray-400 hover:text-blue-500 transition-colors"
                            title="ëª©í‘œ ë¹„ìœ¨ ìˆ˜ì •"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="targetRatioDisplay" class="flex items-end space-x-2">
                        <span id="targetHedgeRatio" class="text-3xl font-bold text-gray-800">-</span>
                        <span class="text-sm text-gray-500 mb-1">ì •ì±… ê¸°ì¤€</span>
                    </div>
                    <div id="targetRatioEdit" class="hidden flex items-center space-x-2">
                        <input 
                            type="number" 
                            id="targetRatioInput" 
                            class="w-24 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-2xl font-bold"
                            min="0" 
                            max="100"
                            placeholder="80"
                        />
                        <span class="text-2xl font-bold text-gray-600">%</span>
                        <button onclick="saveTargetRatio()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">
                            ì €ì¥
                        </button>
                        <button onclick="cancelEditTargetRatio()" class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded shadow-sm flex flex-col">
                    <span class="text-xs font-bold text-gray-400 mb-2">í˜„ì¬ í—¤ì§€ ë¹„ìœ¨</span>
                    <div class="flex items-end space-x-2">
                        <span id="currentHedgeRatio" class="text-3xl font-bold text-red-500">-</span>
                        <span id="hedgeGap" class="indicator-red text-[10px] px-2 py-1 rounded font-bold mb-1">ë¡œë”© ì¤‘</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded shadow-sm flex flex-col">
                    <span class="text-xs font-bold text-gray-400 mb-2">ë¯¸í—¤ì§€ ë…¸ì¶œ</span>
                    <div class="flex items-end space-x-2">
                        <span id="unhedgedExposure" class="text-3xl font-bold text-gray-800">-</span>
                        <span class="text-sm text-gray-500 mb-1">KRW</span>
                    </div>
                </div>
            </section>

            <!-- í—¤ì§€ ì œì•ˆ -->
            <section class="action-card">
                <div class="p-4 bg-gray-50 flex justify-between items-center border-b">
                    <div class="flex items-center gap-3">
                        <h3 class="font-bold text-sm text-gray-700">ğŸ“‹ ì‹œìŠ¤í…œ ì œì•ˆ í—¤ì§€ ê±°ë˜</h3>
                        <span id="suggestionsCount" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">0ê±´</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="executeAllSuggestions()" class="text-xs px-3 py-1 btn-execute rounded font-bold">
                            ëª¨ë“  ì œì•ˆ ì‹¤í–‰
                        </button>
                    </div>
                </div>
                
                <div class="overflow-auto max-h-80">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-100 border-b sticky top-0">
                            <tr>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600">#</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600">ê±°ë˜ì²˜</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600">ê¶Œì¥ ìƒí’ˆ</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600">í†µí™”</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600 text-right">ê¶Œì¥ ê¸ˆì•¡</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600">ê²°ì œì¼</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-blue-600 font-bold">ê¶Œì¥ ì€í–‰</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600">í™˜ìœ¨</th>
                                <th class="px-3 py-2 uppercase tracking-wider text-gray-600 text-center">ì‹¤í–‰</th>
                            </tr>
                        </thead>
                        <tbody id="suggestionsTableBody" class="divide-y divide-gray-100">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- ì´ˆê¸° ì„¤ì • ëª¨ë‹¬ -->
    <div id="initialSettingsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ¯ ì´ˆê¸° ì„¤ì •</h2>
            <p class="text-sm text-gray-600 mb-6">
                HedgeFreedomì„ ì‹œì‘í•©ë‹ˆë‹¤!<br>
                ë§ì¶¤í˜• í—¤ì§€ ì „ëµì„ ìœ„í•´ ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.
            </p>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ (%)
                </label>
                <input 
                    type="number" 
                    id="targetHedgeRatioInput" 
                    value="75" 
                    min="0" 
                    max="100"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg font-bold text-center"
                >
                <div class="mt-3 space-y-2">
                    <p class="text-xs text-gray-500">ğŸ’¡ ê¶Œì¥ ê°’:</p>
                    <div class="flex gap-2">
                        <button onclick="setTargetRatio(85)" class="px-3 py-1 bg-gray-100 hover:bg-blue-100 rounded text-xs">
                            ë³´ìˆ˜ì  85%
                        </button>
                        <button onclick="setTargetRatio(75)" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-xs font-bold">
                            ì¤‘ë¦½ 75%
                        </button>
                        <button onclick="setTargetRatio(60)" class="px-3 py-1 bg-gray-100 hover:bg-blue-100 rounded text-xs">
                            ê³µê²©ì  60%
                        </button>
                    </div>
                </div>
            </div>
            
            <button 
                onclick="saveInitialSettings()" 
                class="w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-bold hover:from-blue-600 hover:to-blue-700 shadow-lg"
            >
                ì„¤ì • ì™„ë£Œ ë° ëŒ€ì‹œë³´ë“œ ì‹œì‘
            </button>
        </div>
    </div>

    <!-- í´ë” ì„ íƒ ëª¨ë‹¬ -->
    <div id="folderSelectionModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“ ì‘ì—… í´ë” ì§€ì • (í•„ìˆ˜)</h2>
            <p class="text-sm text-gray-600 mb-4">
                <strong class="text-red-600">âš ï¸ ì¤‘ìš”:</strong> ë°˜ë“œì‹œ ë¬¸ì„œ í´ë”ì— <strong class="text-blue-600">"HEDGEFREEDOM"</strong> í´ë”ë¥¼ ë§Œë“¤ê³  ì„ íƒí•´ì£¼ì„¸ìš”.<br>
                ì´ í´ë”ì—ëŠ” ëª¨ë“  ê³¼ê±° ê±°ë˜ ìë£Œ, ê°ì‚¬ ëŒ€ì‘ ìë£Œ, íšŒê³„ ì²˜ë¦¬ ë‚´ì—­ì´ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-4 mb-6">
                <p class="text-xs text-yellow-800 font-bold mb-2">âš ï¸ í´ë”ëª… ê³ ì • ì´ìœ :</p>
                <ul class="text-xs text-yellow-900 space-y-1 ml-4">
                    <li>â€¢ ëª¨ë“  ê³¼ê±° ê±°ë˜ ìë£Œë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬</li>
                    <li>â€¢ ê°ì‚¬ ëŒ€ì‘ ì‹œ ì¦‰ì‹œ ìë£Œ ì œì¶œ ê°€ëŠ¥</li>
                    <li>â€¢ íšŒê³„ ì²˜ë¦¬ ì‹œ íˆìŠ¤í† ë¦¬ ì¶”ì  ìš©ì´</li>
                    <li>â€¢ ë¸Œëœë“œ ì¼ê´€ì„± ë° ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥</li>
                </ul>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-xs text-blue-800 mb-2"><strong>ğŸ“‚ í‘œì¤€ í´ë” ê²½ë¡œ:</strong></p>
                <pre class="text-xs text-blue-900 font-mono bg-white p-2 rounded">
Windows: C:\Users\ì‚¬ìš©ìëª…\Documents\HEDGEFREEDOM
Mac:     ~/Documents/HEDGEFREEDOM
Linux:   ~/Documents/HEDGEFREEDOM
                </pre>
                <p class="text-xs text-blue-800 mt-2">ì„ íƒí•œ í´ë” ì•ˆì— ìë™ìœ¼ë¡œ í•˜ìœ„ í´ë”ê°€ ìƒì„±ë©ë‹ˆë‹¤:</p>
                <pre class="text-xs text-blue-900 font-mono bg-white p-2 rounded mt-1">
HEDGEFREEDOM/
â”œâ”€â”€ data/          (ì„¤ì • ë° í˜„ì¬ ë°ì´í„°)
â”œâ”€â”€ uploads/       (ì—…ë¡œë“œí•œ Excel íŒŒì¼)
â”œâ”€â”€ history/       (ì¼ë³„ íˆìŠ¤í† ë¦¬ - ê°ì‚¬ìš©)
â””â”€â”€ cache/         (ì„ì‹œ ìºì‹œ)
                </pre>
            </div>
            
            <button 
                onclick="selectFolder()" 
                class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-bold hover:from-green-600 hover:to-green-700 shadow-lg"
            >
                ğŸ“ HEDGEFREEDOM í´ë” ì„ íƒí•˜ê¸°
            </button>
            
            <p class="text-xs text-gray-500 mt-4 text-center">
                ğŸ’¡ <strong>í•„ìˆ˜:</strong> ë¬¸ì„œ í´ë”ì— "HEDGEFREEDOM" í´ë”ë¥¼ ë¨¼ì € ë§Œë“œì„¸ìš”<br>
                <span class="text-[10px] text-gray-400">powered by hedgeOn Engine | www.hedgefreedom.com</span>
            </p>
        </div>
    </div>

    <script>
        // API ê¸°ë³¸ URL
        const API_BASE = 'http://localhost:9000';
        
        // ì „ì—­ ë°ì´í„° ì €ì¥
        let currentPositions = [];
        let currentKPI = null;
        let currentSuggestions = [];
        let currentRates = {};
        let userSettings = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“Š í—¤ì§€ë§¤ë‹ˆì € í˜ì´ì§€ ë¡œë“œ');
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
            await initializeApp();
        });
        
        /**
         * ì•± ì´ˆê¸°í™”
         */
        async function initializeApp() {
            try {
                // 1. ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
                if (!localStorageHandler.isSupported()) {
                    alert('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ë¡œì»¬ í´ë” ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nChrome 86+ ì´ìƒì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // 2. ë¡œì»¬ í´ë” ì´ˆê¸°í™” ì‹œë„
                try {
                    await localStorageHandler.initialize();
                    console.log('âœ… ë¡œì»¬ í´ë” ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // ì‚¬ìš©ìê°€ í´ë” ì„ íƒ ì·¨ì†Œ â†’ ëª¨ë‹¬ í‘œì‹œ
                        showFolderSelectionModal();
                        return;
                    }
                    throw error;
                }
                
                // 3. ë¡œì»¬ì—ì„œ ë°ì´í„° ë¡œë“œ
                const localData = await localStorageHandler.loadAllData();
                console.log('ğŸ“‚ ë¡œì»¬ ë°ì´í„° ë¡œë“œ:', localData);
                
                // 4. ì‚¬ìš©ì ì„¤ì • í™•ì¸
                if (!localData.settings || !localData.settings.targetHedgeRatio) {
                    // ì„¤ì • ì—†ìŒ â†’ ì´ˆê¸° ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
                    showInitialSettingsModal();
                } else {
                    // ì„¤ì • ìˆìŒ â†’ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
                    userSettings = localData.settings;
                    await loadDashboard(localData);
                }
                
            } catch (error) {
                console.error('âŒ ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        /**
         * ëŒ€ì‹œë³´ë“œ ë¡œë“œ
         */
        async function loadDashboard(localData) {
            console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹œì‘');
            
            // ë¡œì»¬ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ (ë¹ ë¥¸ ë¡œë”©)
            if (localData.positions && localData.positions.length > 0) {
                currentPositions = localData.positions;
                renderPositions(currentPositions);
                document.getElementById('tradeCount').textContent = `${currentPositions.length}ê±´`;
            }
            
            if (localData.kpi) {
                currentKPI = localData.kpi;
                renderKPI(currentKPI);
            }
            
            if (localData.suggestions && localData.suggestions.length > 0) {
                currentSuggestions = localData.suggestions;
                renderSuggestions(currentSuggestions);
                document.getElementById('suggestionsCount').textContent = `${currentSuggestions.length}ê±´`;
            }
            
            // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë°±ê·¸ë¼ìš´ë“œ)
            await loadAllData();
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ (1ë¶„ë§ˆë‹¤)
            setInterval(loadAllData, 60000);
        }
        
        /**
         * ì´ˆê¸° ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
         */
        function showInitialSettingsModal() {
            const modal = document.getElementById('initialSettingsModal');
            modal.classList.add('active');
        }
        
        /**
         * ì´ˆê¸° ì„¤ì • ì €ì¥
         */
        async function saveInitialSettings() {
            const targetHedgeRatio = parseInt(document.getElementById('targetHedgeRatioInput').value);
            
            if (isNaN(targetHedgeRatio) || targetHedgeRatio < 0 || targetHedgeRatio > 100) {
                alert('âš ï¸ ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ì€ 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ì„¤ì • ê°ì²´ ìƒì„±
                const settings = {
                    targetHedgeRatio: targetHedgeRatio,
                    companyName: 'ë°ëª¨ íšŒì‚¬',
                    industry: 'ì œì¡°ì—…',
                    riskTolerance: 'moderate',
                    baseCurrency: 'KRW',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                
                // ë¡œì»¬ì— ì €ì¥
                await localStorageHandler.saveSettings(settings);
                console.log('âœ… ì„¤ì •ì´ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', settings);
                
                // ì„œë²„ì—ë„ ì €ì¥ (ì„ íƒì  - ì‹¤íŒ¨í•´ë„ ì§„í–‰)
                try {
                    const response = await fetch(`${API_BASE}/api/user/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    
                    if (response.ok) {
                        console.log('âœ… ì„¤ì •ì´ ì„œë²„ì—ë„ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                    } else {
                        console.warn('âš ï¸ ì„œë²„ ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë¨)');
                    }
                } catch (serverError) {
                    console.warn('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë¨):', serverError.message);
                }
                
                // ëª¨ë‹¬ ë‹«ê¸°
                document.getElementById('initialSettingsModal').classList.remove('active');
                
                // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
                userSettings = settings;
                await loadDashboard({ settings });
                
            } catch (error) {
                console.error('âŒ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                alert(`ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        /**
         * ëª©í‘œ ë¹„ìœ¨ ì„¤ì • (í€µ ë²„íŠ¼)
         */
        function setTargetRatio(ratio) {
            document.getElementById('targetHedgeRatioInput').value = ratio;
        }
        
        /**
         * í´ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
         */
        function showFolderSelectionModal() {
            const modal = document.getElementById('folderSelectionModal');
            modal.classList.add('active');
        }
        
        /**
         * í´ë” ì„ íƒ
         */
        async function selectFolder() {
            try {
                await localStorageHandler.selectWorkingFolder();
                document.getElementById('folderSelectionModal').classList.remove('active');
                
                // ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
                showInitialSettingsModal();
                
            } catch (error) {
                console.error('âŒ í´ë” ì„ íƒ ì˜¤ë¥˜:', error);
            }
        }
        
        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            try {
                // ë³‘ë ¬ë¡œ ë°ì´í„° ë¡œë“œ ì‹œë„
                const results = await Promise.allSettled([
                    loadPositions(),
                    loadKPI(),
                    loadSuggestions()
                ]);
                
                // ê° ê²°ê³¼ í™•ì¸
                results.forEach((result, index) => {
                    const names = ['í¬ì§€ì…˜', 'KPI', 'ì œì•ˆ'];
                    if (result.status === 'fulfilled') {
                        console.log(`âœ… ${names[index]} ë¡œë“œ ì„±ê³µ`);
                    } else {
                        console.warn(`âš ï¸ ${names[index]} ë¡œë“œ ì‹¤íŒ¨:`, result.reason?.message);
                    }
                });
                
                updateLastUpdateTime();
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰ (ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ë§Œ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ)
                console.warn('ì¼ë¶€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.');
            }
        }
        
        // ê±°ë˜ í¬ì§€ì…˜ ë¡œë“œ
        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE}/api/hedge/positions`);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // API ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ ìˆ˜ì •
                    currentPositions = Array.isArray(result.data) ? result.data : (result.data.positions || []);
                    currentRates = result.data.rates || {};
                    
                    renderPositions(currentPositions);
                    renderExchangeRates(currentRates);
                    document.getElementById('tradeCount').textContent = `${currentPositions.length}ê±´`;
                    
                    // ë¡œì»¬ì— ì €ì¥
                    try {
                        await localStorageHandler.savePositions(currentPositions);
                    } catch (saveError) {
                        console.warn('âš ï¸ ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', saveError);
                    }
                } else {
                    throw new Error(result.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ í¬ì§€ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í•˜ì—¬ UI ê¹¨ì§ ë°©ì§€
                if (currentPositions.length === 0) {
                    currentPositions = [];
                    renderPositions(currentPositions);
                    document.getElementById('tradeCount').textContent = '0ê±´';
                }
                throw error;
            }
        }
        
        // KPI ë¡œë“œ
        async function loadKPI() {
            try {
                const response = await fetch(`${API_BASE}/api/hedge/kpi`);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    currentKPI = result.data;
                    
                    // ì‚¬ìš©ì ì„¤ì •ì˜ ëª©í‘œ ë¹„ìœ¨ ë°˜ì˜
                    if (userSettings && userSettings.targetHedgeRatio) {
                        currentKPI.targetHedgeRatio = userSettings.targetHedgeRatio;
                        currentKPI.gap = currentKPI.currentHedgeRatio - userSettings.targetHedgeRatio;
                    }
                    
                    renderKPI(currentKPI);
                    
                    // ë¡œì»¬ì— ì €ì¥
                    try {
                        await localStorageHandler.saveKPI(currentKPI);
                    } catch (saveError) {
                        console.warn('âš ï¸ KPI ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', saveError);
                    }
                } else {
                    throw new Error(result.error || 'KPI ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ KPI ë¡œë“œ ì˜¤ë¥˜:', error);
                // ê¸°ë³¸ KPI ì„¤ì •
                if (!currentKPI) {
                    currentKPI = {
                        targetHedgeRatio: userSettings?.targetHedgeRatio || 70,
                        currentHedgeRatio: 0,
                        gap: -(userSettings?.targetHedgeRatio || 70),
                        unhedgedAmount: 0
                    };
                    renderKPI(currentKPI);
                }
                throw error;
            }
        }
        
        // í—¤ì§€ ì œì•ˆ ë¡œë“œ
        async function loadSuggestions() {
            try {
                const response = await fetch(`${API_BASE}/api/hedge/suggestions`);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // API ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ ìˆ˜ì •
                    currentSuggestions = Array.isArray(result.data) ? result.data : (result.data.suggestions || []);
                    renderSuggestions(currentSuggestions);
                    document.getElementById('suggestionsCount').textContent = `${currentSuggestions.length}ê±´`;
                    
                    // ë¡œì»¬ì— ì €ì¥
                    try {
                        await localStorageHandler.saveSuggestions(currentSuggestions);
                    } catch (saveError) {
                        console.warn('âš ï¸ ì œì•ˆ ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', saveError);
                    }
                } else {
                    throw new Error(result.error || 'ì œì•ˆ ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ ì œì•ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
                if (currentSuggestions.length === 0) {
                    currentSuggestions = [];
                    renderSuggestions(currentSuggestions);
                    document.getElementById('suggestionsCount').textContent = '0ê±´';
                }
                throw error;
            }
        }
        
        // í¬ì§€ì…˜ í…Œì´ë¸” ë Œë”ë§
        function renderPositions(positions) {
            const tbody = document.getElementById('positionsTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tableContainer = document.getElementById('positionsTableContainer');
            
            if (!positions || positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            // ë¡œë”© ìˆ¨ê¸°ê³  í…Œì´ë¸” í‘œì‹œ
            loadingIndicator.style.display = 'none';
            tableContainer.style.display = 'block';
            
            tbody.innerHTML = positions.map(pos => {
                const hedgeStatus = getHedgeStatus(pos);
                const hedgeClass = getHedgeStatusClass(pos.hedgeStatus);
                
                return `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="selectPosition('${pos.id}')">
                        <td class="p-3 font-medium text-gray-900">${pos.id}</td>
                        <td class="p-3">${pos.counterparty}</td>
                        <td class="p-3 font-bold">${pos.currency}</td>
                        <td class="p-3 text-right">${formatNumber(pos.amount)}</td>
                        <td class="p-3">${pos.paymentDate}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${pos.type === 'ì±„ë¬´' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                ${pos.type}
                            </span>
                        </td>
                        <td class="p-3 text-right font-medium">${formatKRW(pos.krwAmount)}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 rounded text-xs ${pos.dday <= 30 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">
                                D-${pos.dday}
                            </span>
                        </td>
                        <td class="p-3 ${hedgeClass}">${hedgeStatus}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // í™˜ìœ¨ ë Œë”ë§
        function renderExchangeRates(rates) {
            const container = document.getElementById('exchangeRates');
            
            // ê¸°ë³¸ í™˜ìœ¨ ì„¤ì •
            const defaultRates = {
                USD: 1350.0,
                EUR: 1450.0,
                JPY: 9.5,
                CNY: 185.0
            };
            
            const actualRates = rates && Object.keys(rates).length > 0 ? rates : defaultRates;
            
            const rateItems = [
                { label: 'USD/KRW', value: actualRates.USD || 1350, change: 0.45 },
                { label: 'EUR/KRW', value: actualRates.EUR || 1450, change: -0.12 },
                { label: 'JPY/KRW', value: actualRates.JPY || 9.5, change: 0.28 },
                { label: 'CNY/KRW', value: actualRates.CNY || 185, change: -0.08 }
            ];
            
            container.innerHTML = rateItems.map(item => {
                const isPositive = item.change >= 0;
                return `
                    <div class="flex items-center space-x-2 px-3 py-1 ${isPositive ? 'bg-green-50' : 'bg-red-50'} rounded">
                        <span class="text-xs font-bold text-gray-600">${item.label}</span>
                        <span class="text-sm font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                            ${item.value.toFixed(2)}
                        </span>
                        <span class="text-[10px] ${isPositive ? 'text-green-600' : 'text-red-600'}">
                            ${isPositive ? 'â–²' : 'â–¼'}${Math.abs(item.change)}%
                        </span>
                    </div>
                `;
            }).join('');
        }
        
        // KPI ë Œë”ë§
        function renderKPI(kpi) {
            if (!kpi) {
                console.warn('KPI ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            document.getElementById('targetHedgeRatio').textContent = `${kpi.targetHedgeRatio || 70}%`;
            document.getElementById('currentHedgeRatio').textContent = `${kpi.currentHedgeRatio || 0}%`;
            
            const unhedgedAmount = kpi.unhedgedAmount || kpi.unhedgedExposure || 0;
            document.getElementById('unhedgedExposure').textContent = `${Math.round(unhedgedAmount / 100000000)}ì–µì›`;
            
            const gap = kpi.gap || 0;
            const gapElement = document.getElementById('hedgeGap');
            gapElement.textContent = `ëª©í‘œ ëŒ€ë¹„ ${gap > 0 ? '+' : ''}${gap}%p`;
            gapElement.className = gap < -10 ? 'indicator-red text-[10px] px-2 py-1 rounded font-bold mb-1' : 'indicator-green text-[10px] px-2 py-1 rounded font-bold mb-1';
        }
        
        // ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ í¸ì§‘ ëª¨ë“œ í† ê¸€
        function toggleEditTargetRatio() {
            const displayDiv = document.getElementById('targetRatioDisplay');
            const editDiv = document.getElementById('targetRatioEdit');
            const currentValue = parseInt(document.getElementById('targetHedgeRatio').textContent);
            
            displayDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            
            document.getElementById('targetRatioInput').value = currentValue;
            document.getElementById('targetRatioInput').focus();
        }
        
        // ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ í¸ì§‘ ì·¨ì†Œ
        function cancelEditTargetRatio() {
            const displayDiv = document.getElementById('targetRatioDisplay');
            const editDiv = document.getElementById('targetRatioEdit');
            
            displayDiv.classList.remove('hidden');
            editDiv.classList.add('hidden');
        }
        
        // ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ ì €ì¥
        async function saveTargetRatio() {
            const newRatio = parseInt(document.getElementById('targetRatioInput').value);
            
            if (isNaN(newRatio) || newRatio < 0 || newRatio > 100) {
                alert('âš ï¸ ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ì€ 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ë¡œì»¬ ì„¤ì • ì—…ë°ì´íŠ¸
                const currentSettings = await localStorageHandler.loadSettings() || {};
                currentSettings.targetHedgeRatio = newRatio;
                currentSettings.lastUpdated = new Date().toISOString();
                await localStorageHandler.saveSettings(currentSettings);
                
                // ì„œë²„ë¡œ ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ ì „ì†¡
                try {
                    await fetch(`${API_BASE}/api/user/settings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(currentSettings)
                    });
                    console.log('âœ… ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ì´ ì„œë²„ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤:', newRatio);
                } catch (serverError) {
                    console.warn('âš ï¸ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œ):', serverError);
                }
                
                // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                if (userSettings) {
                    userSettings.targetHedgeRatio = newRatio;
                }
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('targetHedgeRatio').textContent = `${newRatio}%`;
                cancelEditTargetRatio();
                
                // KPI ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ê°­ ì¬ê³„ì‚°
                await loadDashboard({
                    settings: currentSettings,
                    positions: await localStorageHandler.loadPositions(),
                    kpi: await localStorageHandler.loadKPI()
                });
                
                // ì„±ê³µ ë©”ì‹œì§€
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                successMsg.textContent = 'âœ“ ëª©í‘œ í—¤ì§€ ë¹„ìœ¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 2000);
                
            } catch (error) {
                console.error('ëª©í‘œ ë¹„ìœ¨ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ì œì•ˆ í…Œì´ë¸” ë Œë”ë§
        function renderSuggestions(suggestions) {
            const tbody = document.getElementById('suggestionsTableBody');
            
            if (!suggestions || suggestions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-400">ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = suggestions.map((sug, index) => `
                <tr class="hover:bg-blue-50">
                    <td class="px-3 py-2 text-center">${index + 1}</td>
                    <td class="px-3 py-2">${sug.counterparty}</td>
                    <td class="px-3 py-2">
                        <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700 font-medium">
                            ${sug.product}
                        </span>
                    </td>
                    <td class="px-3 py-2 font-bold">${sug.currency}</td>
                    <td class="px-3 py-2 text-right font-medium">${formatNumber(sug.recommendedAmount)}</td>
                    <td class="px-3 py-2">${sug.paymentDate}</td>
                    <td class="px-3 py-2 text-blue-600 font-bold">${sug.bank}</td>
                    <td class="px-3 py-2 font-medium">${sug.rate.toFixed(2)}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="executeSuggestion('${sug.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                            ì‹¤í–‰
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // í—¤ì§€ ìƒíƒœ í…ìŠ¤íŠ¸
        function getHedgeStatus(position) {
            if (position.hedgeStatus === 'ì™„ì „í—¤ì§€') return 'ì™„ì „í—¤ì§€';
            if (position.hedgeStatus === 'ë¶€ë¶„í—¤ì§€') {
                const percent = Math.round((position.hedgedAmount / position.amount) * 100);
                return `ë¶€ë¶„í—¤ì§€ (${percent}%)`;
            }
            return 'ë¯¸í—¤ì§€';
        }
        
        // í—¤ì§€ ìƒíƒœ CSS í´ë˜ìŠ¤
        function getHedgeStatusClass(status) {
            if (status === 'ì™„ì „í—¤ì§€') return 'status-full';
            if (status === 'ë¶€ë¶„í—¤ì§€') return 'status-partial';
            return 'status-unhedged';
        }
        
        // ìˆ«ì í¬ë§·
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }
        
        // ì›í™” í¬ë§·
        function formatKRW(num) {
            const billion = Math.floor(num / 100000000);
            const million = Math.floor((num % 100000000) / 10000);
            
            if (billion > 0) {
                return million > 0 ? `${billion}ì–µ ${million}ë§Œì›` : `${billion}ì–µì›`;
            }
            return `${million}ë§Œì›`;
        }
        
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `ê°±ì‹ : ${now.toLocaleTimeString('ko-KR')}`;
        }
        
        // í¬ì§€ì…˜ ì„ íƒ
        function selectPosition(id) {
            console.log('í¬ì§€ì…˜ ì„ íƒ:', id);
            // í–¥í›„ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
        }
        
        // ì œì•ˆ ì‹¤í–‰
        function executeSuggestion(id) {
            if (confirm('ì´ í—¤ì§€ ì œì•ˆì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                console.log('ì œì•ˆ ì‹¤í–‰:', id);
                alert('í—¤ì§€ ê±°ë˜ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì‹¤ì œ ì‹œìŠ¤í…œ ì—°ë™ í•„ìš”)');
            }
        }
        
        // ëª¨ë“  ì œì•ˆ ì‹¤í–‰
        function executeAllSuggestions() {
            if (confirm(`ì´ ${currentSuggestions.length}ê±´ì˜ í—¤ì§€ ì œì•ˆì„ ëª¨ë‘ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                console.log('ëª¨ë“  ì œì•ˆ ì‹¤í–‰');
                alert('ëª¨ë“  í—¤ì§€ ê±°ë˜ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì‹¤ì œ ì‹œìŠ¤í…œ ì—°ë™ í•„ìš”)');
            }
        }
        
        // í—¤ì§€ ì „ëµ ê³„ì‚°
        async function calculateHedgeStrategy() {
            const btn = document.getElementById('calculateHedgeBtn');
            btn.disabled = true;
            btn.textContent = 'ê³„ì‚° ì¤‘...';
            
            try {
                const response = await fetch(`${API_BASE}/api/hedge/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        positions: currentPositions,
                        targetRatio: currentKPI.targetHedgeRatio
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`í—¤ì§€ ì „ëµ ê³„ì‚° ì™„ë£Œ!\n\nê³„ì‚° ID: ${result.data.calculationId}\nì¶”ì²œ ì•¡ì…˜: ${result.data.recommendedActions.length}ê±´\nì˜ˆìƒ ë¹„ìš©: ${formatKRW(result.data.estimatedCost)}\në¦¬ìŠ¤í¬ ê°ì†Œ: ${result.data.riskReduction}%`);
                    
                    // ì œì•ˆ ìƒˆë¡œê³ ì¹¨
                    await loadSuggestions();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('âŒ ê³„ì‚° ì˜¤ë¥˜:', error);
                alert('í—¤ì§€ ì „ëµ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'âš¡ í—¤ì§€ ì „ëµ ê³„ì‚°';
            }
        }
        
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        function refreshData() {
            console.log('ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
            loadAllData();
        }
        
        // ========================================
        // ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
        // ========================================
        
        let selectedFile = null;
        
        /**
         * íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) {
                selectedFile = null;
                document.getElementById('selectedFileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
                document.getElementById('uploadBtn').disabled = true;
                return;
            }
            
            // íŒŒì¼ í™•ì¥ì ì²´í¬
            const validExtensions = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isValidExtension) {
                alert('âš ï¸ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                selectedFile = null;
                document.getElementById('selectedFileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
                document.getElementById('uploadBtn').disabled = true;
                return;
            }
            
            // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('âš ï¸ íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                event.target.value = '';
                selectedFile = null;
                document.getElementById('selectedFileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
                document.getElementById('uploadBtn').disabled = true;
                return;
            }
            
            selectedFile = file;
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('uploadBtn').disabled = false;
            
            console.log('âœ… íŒŒì¼ ì„ íƒë¨:', file.name, `(${(file.size / 1024).toFixed(2)} KB)`);
        }
        
        /**
         * ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ë° ì²˜ë¦¬
         */
        async function uploadExcelFile() {
            if (!selectedFile) {
                alert('âš ï¸ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressPercentage = document.getElementById('uploadPercentage');
            const uploadStatus = document.getElementById('uploadStatus');
            
            try {
                // UI ì—…ë°ì´íŠ¸
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
                progressDiv.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                uploadStatus.textContent = 'íŒŒì¼ ì½ëŠ” ì¤‘...';
                
                // 1ë‹¨ê³„: íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”© (30%)
                const fileData = await readFileAsBase64(selectedFile);
                updateProgress(30, 'ë°ì´í„° ìµëª…í™” ì¤‘...');
                
                // 2ë‹¨ê³„: ìµëª…í™”ëœ ë°ì´í„° ì¤€ë¹„ (50%)
                const anonymizedData = anonymizeFileData(selectedFile.name);
                updateProgress(50, 'ì„œë²„ë¡œ ì „ì†¡ ì¤‘...');
                
                // 3ë‹¨ê³„: ì„œë²„ë¡œ ì „ì†¡ (70%)
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('customerId', getCurrentCustomerId());
                formData.append('uploadDate', new Date().toISOString());
                
                const response = await fetch(`${API_BASE}/api/upload/excel`, {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress(80, 'ì„œë²„ ì²˜ë¦¬ ì¤‘...');
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                updateProgress(90, 'ê²°ê³¼ ì²˜ë¦¬ ì¤‘...');
                
                if (result.success) {
                    updateProgress(100, 'ì—…ë¡œë“œ ì™„ë£Œ!');
                    
                    // ë¡œì»¬ì—ë„ ì €ì¥
                    if (result.data.positions) {
                        await localStorageHandler.savePositions(result.data.positions);
                    }
                    if (result.data.kpi) {
                        await localStorageHandler.saveKPI(result.data.kpi);
                    }
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    setTimeout(() => {
                        alert(`âœ… ì—…ë¡œë“œ ì„±ê³µ!\n\nì²˜ë¦¬ëœ ê±°ë˜: ${result.data.positions?.length || 0}ê±´\nì´ ë…¸ì¶œì•¡: ${formatKRW(result.data.kpi?.totalExposure || 0)}\ní—¤ì§€ ë¹„ìœ¨: ${result.data.kpi?.currentHedgeRatio || 0}%`);
                        
                        // UI ì´ˆê¸°í™”
                        resetUploadUI();
                        
                        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                        loadAllData();
                    }, 500);
                    
                } else {
                    throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('âŒ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                updateProgress(0, 'ì˜¤ë¥˜ ë°œìƒ');
                setTimeout(() => {
                    alert(`âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨\n\n${error.message}\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                    resetUploadUI();
                }, 500);
            }
        }
        
        /**
         * íŒŒì¼ì„ Base64ë¡œ ì½ê¸°
         */
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * ë°ì´í„° ìµëª…í™” (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
         * ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œë„ ì²˜ë¦¬í•˜ì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ì „ ì²˜ë¦¬
         */
        function anonymizeFileData(fileName) {
            const timestamp = new Date().toISOString();
            const customerId = getCurrentCustomerId();
            
            return {
                originalFileName: fileName,
                uploadTimestamp: timestamp,
                customerId: customerId,
                // ì‹¤ì œ íŒŒì¼ ë‚´ìš©ì€ ì„œë²„ì—ì„œ ìµëª…í™”
                anonymized: true
            };
        }
        
        /**
         * í˜„ì¬ ê³ ê° ID ê°€ì ¸ì˜¤ê¸°
         */
        function getCurrentCustomerId() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê³ ê° ID ê°€ì ¸ì˜¤ê¸°
            // ì—†ìœ¼ë©´ ì„ì‹œ ID ìƒì„±
            let customerId = localStorage.getItem('customerId');
            
            if (!customerId) {
                // UUID í˜•ì‹ì˜ ê³ ìœ  ID ìƒì„±
                customerId = 'customer_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('customerId', customerId);
                console.log('ğŸ†” ìƒˆ ê³ ê° ID ìƒì„±:', customerId);
            }
            
            return customerId;
        }
        
        /**
         * ì—…ë¡œë“œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
         */
        function updateProgress(percentage, statusText) {
            const progressBar = document.getElementById('uploadProgressBar');
            const progressPercentage = document.getElementById('uploadPercentage');
            const uploadStatus = document.getElementById('uploadStatus');
            
            progressBar.style.width = `${percentage}%`;
            progressPercentage.textContent = `${percentage}%`;
            uploadStatus.textContent = statusText;
        }
        
        /**
         * ì—…ë¡œë“œ UI ì´ˆê¸°í™”
         */
        function resetUploadUI() {
            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('uploadProgress');
            const fileInput = document.getElementById('excelFileInput');
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'â¬†ï¸ ì—…ë¡œë“œ ë° ê³„ì‚°';
            progressDiv.classList.add('hidden');
            fileInput.value = '';
            selectedFile = null;
            document.getElementById('selectedFileName').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
        }
        
        // ========================================
        // ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥ ë
        // ========================================
        
        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            alert(`ì˜¤ë¥˜: ${message}`);
        }
    </script>

</body>
</html>
